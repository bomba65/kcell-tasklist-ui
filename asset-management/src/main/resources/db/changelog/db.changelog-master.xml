<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
                            http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
    <changeSet id="1" author="tair">
        <!--createSequence sequenceName="hibernate_sequence" /-->

        <createTable tableName="site">
            <column name="id" type="text">
                <constraints primaryKey="true" />
            </column>
            <column name="name" type="text" />
            <column name="fance_type" type="text" />
            <column name="version" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
        </createTable>
        <sql>
            alter table site add check(length(name) >= 5);
        </sql>

        <createTable tableName="site_far_end_candidate">
            <column name="site_id" type="text">
                <constraints foreignKeyName="fk_site_far_end_candidate_site_id" referencedTableName="site" referencedColumnNames="id" />
            </column>
            <column name="far_end_site_id" type="text">
                <constraints foreignKeyName="fk_site_far_end_candidate_far_end_id" referencedTableName="site" referencedColumnNames="id" />
            </column>
        </createTable>
        
        <addPrimaryKey tableName="site_far_end_candidate" columnNames="site_id,far_end_site_id" />

        <createTable tableName="facility">
            <column name="id" type="bigserial">
                <constraints primaryKey="true" />
            </column>
            <column name="name" type="text" />
            <column name="site_id" type="text">
                <constraints foreignKeyName="fk_facility_site" referencedTableName="site" referencedColumnNames="id" nullable="false"/>
            </column>
            <column name="version" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint tableName="facility" columnNames="site_id, name" />
        <sql>
            alter table facility add check(length(name) >= 5)
        </sql>

        <createTable tableName="site_facility">
            <column name="site_id" type="text">
                <constraints foreignKeyName="fk_site_facility_site_id" referencedTableName="site"
                    referencedColumnNames="id"/>
            </column>
            <column name="facility_id" type="bigint">
                <constraints foreignKeyName="fk_site_facility_facility_id" referencedTableName="facility"
                    referencedColumnNames="id"/>
            </column>
        </createTable>

        <addPrimaryKey tableName="site_facility" columnNames="site_id,facility_id" />

        <sql>
            with inserted_site as (
                insert into site (id, name) values ('SITE1', 'Site 1')
                returning *
            )
            insert into facility (name, site_id) select 'Facility 1-1', id from inserted_site;
        </sql>

        <sql>
            with inserted_site as (
            insert into site (id, name) values ('SITE2', 'Site 2')
            returning *
            )
            insert into facility (name, site_id) select 'Facility 2-1', id from inserted_site;
        </sql>

        <sql>
            insert into site_far_end_candidate (site_id, far_end_site_id) values ('SITE1', 'SITE2')
        </sql>

    </changeSet>
</databaseChangeLog>
