<style>
    .my-group .form-control{
        width:50%;
    }
    .modal-lg.modal-dialog{
        width: 90%;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .animate-if {
        background:white;
        overflow: hidden;
        transition: 0.4s;
        padding: 13px;
        margin-bottom: 0px;
        color: #b3b3b3;
        background-color: #fff;
        border: 2px solid #b3b3b3;
        border-radius: 0;
        -webkit-box-shadow: none;
        box-shadow: none;
    }

    .animate-if.ng-enter, .animate-if.ng-leave {
        transition:all 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) ;
    }

    .animate-if.ng-enter,
    .animate-if.ng-leave.ng-leave-active {
        opacity:0;
        max-height:0;
        padding-top: 0px;
        padding-bottom: 0px;
    }

    .animate-if.ng-leave,
    .animate-if.ng-enter.ng-enter-active {
        opacity:1;
        max-height: 500px;
        padding-top: 13px;
        padding-bottom: 13px;
    }
</style>
<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject([ '$scope', '$http', '$rootScope', '$q', '$timeout', function($scope, $http, $rootScope, $q, $timeout) {
            var variables = [
                'requestedDate',
                'jrNumber',
                'initiatorFull',
                'validityDate',
                'soaComplaintId',
                'site',
                'siteName',
                'siteAddress',
                'site_name',
                'isOptical',
                'sendNotifyToRegionHeads',
                'reason',
                'contract',
                'contractor',
                'materialsRequired',
                'leasingRequired',
                'powerRequired',
                'project',
                'supplementaryFiles',
                'explanation',
                'jobWorks',
                'sapPRFileXLS',
                'sapPRNo',
                'kcellWarehouseMaterialsList',
                'contractorZIPWarehouseMaterialsList',
                'kcellWarehouseMaterialsListName',
                'kcellWarehouseMaterialsAdditionalList',
                'contractorZIPWarehouseMaterialsListName',
                'sapTransferRequestFile',
                'eLicenseResolutionFile',
                'eLicenseResolutionFileName',
                'actOfMaterialsDispatchingFile',
                'actOfMaterialsDispatchingFileName',
                'actOfMaterialsDispatchingFiles',
                'resolutions',
                'summaries',
                'jrBlank',
                'tssrssidFile',
                'tssrssidFileName',
                'relatedTo',
                'worksBelongsTo',
                'priority',
                'mlApprovalAdditionalInfoFile',
                'contractorJobAssignedDate',
                'acceptanceDate',
                'mainContract',
                'siteStatus',
                'siteSubStatusId'
            ];
            $scope.jobModel = {};

            var permitWorks = ['3', '4', '5', '6', '7', '8', '9', '10', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '86', '87', '91', '94', '95', '96', '155', '156', '157', '158', '159', '160'];
            var subContractorsMaterials = ['6.1', '6.2', '6.3', '6.4', '6.5', '6.8', '6.9', '6.10', '6.12', '6.13', '6.14', '6.15', '6.16', '6.17', '6.18', '6.19', '6.21', '6.22', '6.23', '6.24', '6.25', '6.27', '6.28', '6.29', '7.1', '7.2', '7.3', '7.5', '7.6', '7.7', '7.8', '7.9', '7.10', '7.11', '8.7', '9.58'];
            var kcellMaterials = ['1.1', '1.2', '1.3', '1.4', '2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7', '2.8', '2.9', '2.10', '2.11', '2.12', '2.13', '2.14', '2.15', '2.16', '2.17', '2.18', '2.19', '2.20', '2.21', '2.22', '2.23', '2.24', '2.26', '2.28', '2.29', '2.30', '2.31', '2.32', '2.33', '2.34', '2.35', '2.36', '2.37', '2.38', '2.39', '2.40', '2.41', '2.42', '2.43', '2.44', '2.45', '2.46',
                                    '2.47', '2.48', '2.49', '2.50', '2.51', '2.52', '2.53', '2.54', '2.63', '3.1', '3.2', '3.3', '3.4', '3.5', '3.6', '3.7', '3.8', '3.9', '3.10', '3.11', '3.12', '3.13', '3.14', '3.15', '3.16', '3.17', '3.18', '3.19', '3.20', '3.21', '3.22', '3.23', '3.24', '3.25', '3.26', '3.27', '3.28', '3.29', '3.30', '3.31', '3.40', '3.41', '3.49', '3.54', '4.14', '4.15', '5.1',
                                    '5.2', '5.3', '5.4', '5.9', '5.13', '6.7', '6.11', '6.20', '6.26', '7.4', '8.8', '8.13', '8.14', '8.15', '8.16', '8.20', '8.21', '8.22', '8.23', '8.24', '8.25', '9.3', '9.4', '9.5', '9.6', '9.7', '9.8', '9.9', '9.10', '9.11', '9.12', '9.13', '9.14', '9.15', '9.16', '9.17', '9.18', '9.19', '9.20', '9.21', '9.22', '9.23', '9.24', '9.25', '9.26', '9.27', '9.28', '9.29',
                                    '9.30', '9.31', '9.32', '9.33', '9.34', '9.35', '9.36', '9.37', '9.38', '9.39', '9.40', '9.41', '9.42', '9.43', '9.44', '9.45', '9.46', '9.47', '9.48', '9.49', '9.50', '9.51', '9.52', '9.53', '9.54', '9.55', '9.56', '9.61', '9.63', '9.65', '9.66', '9.67', '9.68', '9.69', '9.70', '9.71', '9.72', '9.73', '9.74', '9.77', '9.78', '9.79', '9.81', '9.82', '9.83', '9.84',
                                    '9.85', '9.86', '9.87', '9.88', '9.89', '9.90', '9.91', '9.92', '9.93', '9.94', '9.95', '9.96', '9.97', '9.98', '9.99', '9.100', '9.101', '9.102', '9.103', '9.104', '9.105', '9.106', '9.107', '10.1', '10.2'];
            var allMaterials = ['2.25', '2.27', '2.55', '2.56', '2.57', '2.58', '2.59', '2.60', '2.61', '2.62', '3.32', '3.33', '3.34', '3.35', '3.36', '3.37', '3.38', '3.39', '3.42', '3.43', '3.44', '3.45', '3.46', '3.47', '3.48', '3.50', '3.51', '3.52', '3.53', '4.1', '4.2', '4.3', '4.4', '4.5', '4.6', '4.7', '4.8', '4.9', '4.10', '4.11', '4.12', '4.13', '4.16', '4.17', '4.18', '4.19', '5.5', '5.6',
                                '5.7', '5.8', '5.10', '5.11', '5.12', '5.14', '5.15', '5.16', '5.17', '6.6', '8.1', '8.2', '8.3', '8.4', '8.5', '8.6', '8.9', '8.10', '8.11', '8.12', '8.17', '8.18', '8.19', '9.1', '9.2', '9.57', '9.59', '9.60', '9.62', '9.64', '9.75', '9.76', '9.80'];

            $scope.jobWorkReasons = [
                {id: 'installation', expenseType: 'CAPEX', name: 'Installation', detail: 'Монтаж - установка нового оборудования'},
                {id: 'modernization', expenseType: 'CAPEX', name: 'Modernization', detail: 'Модернизация - замена оборудования на более производительное'},
                {id: 'change_support', expenseType: 'OPEX', name: 'Change for support', detail: 'Замена - восстановление вышедшего из строя оборудования/OC для поддержания их в рабочем состоянии  с целью их профилактики'},
                {id: 'change_improvement', expenseType: 'CAPEX', name: 'Change for improvement', detail: 'Замена - восстановление вышедшего из строя оборудования/ОС для улучшения состояния объекта, повышающего его первоначально оцененные нормативные показатели: срок службы, производственную мощность и т. д'},
                {id: 'replacement', expenseType: 'OPEX', name: 'Replacement', detail: 'Перемещение - в пределах одного сайта'},
                {id: 'removal', expenseType: 'OPEX', name: 'Removal', detail: 'Демонтаж - снятие оборудования'}
            ];

            $scope.defineExpenseType = function(index){
                for(var i=0;i<$scope.jobWorkReasons.length;i++){
                    if($scope.jobWorks[index].reason === $scope.jobWorkReasons[i].id){
                        $scope.jobWorks[index].expenseType = $scope.jobWorkReasons[i].expenseType;
                        $scope.jobWorks[index].reasonDetail = $scope.jobWorkReasons[i].detail;
                    }
                }
                $(function () {
                    $('[data-toggle="tooltip"]').tooltip('fixTitle');
                });
            };

            $http.get('/camunda/api/engine/engine/default/task/' + camForm.taskId).then(
                    function(result){
                        $scope.processInstanceId = result.data.processInstanceId;
                    },
                    function (error) {
                        console.log(error.data);
                    }
            );

            $scope.showJump = false;

            if($rootScope.authentication.name === 'demo'){
                $scope.showJump = true;
            }

            camForm.on('form-loaded', function () {
                $scope.custom = {
                    contract: 1,
                    contractor: undefined
                };
                camForm.variableManager.createVariable({
                    name: 'modifyJrResult',
                    type: 'String',
                    value: ''
                });
                variables.forEach(function (el) {
                    camForm.variableManager.fetchVariable(el);
                });

                $http.get($rootScope.getCatalogsHttpByName('catalogs')).then(
                        function(result){
                            angular.extend($scope, result.data);
                            $scope.conts = [];
                            if($scope.contracts){
                                for(var i=0;i<$scope.contracts.length;i++){
                                    if($scope.contracts[i].service.id === $scope.custom.contract){
                                        $scope.conts.push($scope.contracts[i].contractor);
                                    }
                                }
                            }
                        },
                        function(error){
                            console.log(error.data);
                        }
                );
            });

            camForm.on('variables-fetched', function () {
                variables.forEach(function (el) {
                    $scope.jobModel[el] = camForm.variableManager.variables[el].value;
                    if(camForm.variableManager.variables[el].type == 'Date'){
                        $scope[el] = new Date(camForm.variableManager.variables[el].value);
                    } else if(el == 'supplementaryFiles'){
                        $scope[el] = camForm.variableManager.variables[el];
                        $scope[el].type = 'Json';
                    } else {
                        $scope[el] = camForm.variableManager.variables[el].value;
                    }
                    if (el === 'resolutions') {
                        $scope[el] = camForm.variableManager.variables[el].value;
                    }
                });
                if($scope['materialsRequired'] === 'Yes'){
                    $scope.materialsRequiredCheckbox = true;
                }
                if($scope['leasingRequired'] === 'Yes'){
                    $scope.leasingRequiredCheckbox = true;
                }
                if($scope['powerRequired'] === 'Yes'){
                    $scope.powerRequiredCheckbox = true;
                }
                if(camForm.variableManager.variableValue('contract')){
                    $scope.custom.contract = parseInt(camForm.variableManager.variableValue('contract'));
                }
                if(camForm.variableManager.variableValue('contractor')){
                    $scope.custom.contractor = parseInt(camForm.variableManager.variableValue('contractor'));
                }
                try{
                    if(camForm.variableManager.variableValue('requestedDate')){
                        $scope.requestedDate = new Date(camForm.variableManager.variableValue('requestedDate'));
                    } else {
                        $scope.requestedDate = new Date();
                    }
                } catch(e){
                    $scope.requestedDate = new Date();
                }
                try{
                    if(camForm.variableManager.variableValue('jobWorks')){
                        $scope.jobWorks = JSON.parse(angular.toJson(camForm.variableManager.variableValue('jobWorks')));
                    } else {
                        $scope.jobWorks = [{relatedSites:[]}];
                    }
                } catch(e){
                    $scope.jobWorks = [{relatedSites:[]}];
                }
                refreshJobRequests();
                serviceChanged();
                $scope.oldWorks = angular.copy($scope.jobWorks);
                $http.get("/camunda/api/engine/engine/default/user/" + $rootScope.authentication.name+ "/profile").then(function(result){
                    $rootScope.authentication.assigneeName = (result.data.firstName ? result.data.firstName : "") + " " + (result.data.lastName ? result.data.lastName : "");
                });
                $(function () {
                    $('[data-toggle="tooltip"]').tooltip('fixTitle');
                });
                $scope.isOldContracts = $scope.mainContract === 'Roll-out' || $scope.mainContract === 'Revision';
            });

            camForm.on('submit', function (e) {
                var files = [];

                var sendNotifyToRegionHeads = false;
                var isOptical = false;
                if ($scope.jobWorks.length > 0 && !$scope.isOldContracts){
                    sendNotifyToRegionHeads = !!$scope.jobWorks.filter(work => ['2.4', '9.9', '9.10', '9.11', '9.20', '9.21', '9.22', '9.23', '9.24', '9.25','9.26', '9.27', '9.28']
                    .includes(work.displayServiceName.slice(0, work.displayServiceName.indexOf(' ')))).length
                }
                if ($scope.jobWorks.length > 0 && !$scope.isOldContracts) {
                    isOptical = !!$scope.jobWorks.filter(work => ['9.90', '9.91', '9.92', '9.93', '9.94', '9.95', '9.96', '9.97', '9.98', '9.99', '9.100', '9.101', '9.102', '9.103', '9.104', '9.105', '9.106']
                    .includes(work.sapServiceNumber)).length
                }

                if (camForm.variableManager.variables['sendNotifyToRegionHeads'].value) {
                    camForm.variableManager.variableValue('sendNotifyToRegionHeads', sendNotifyToRegionHeads);
                } else {
                    if (camForm.variableManager.variables['sendNotifyToRegionHeads']) {
                        camForm.variableManager.destroyVariable('sendNotifyToRegionHeads')
                    }
                    camForm.variableManager.createVariable({
                        name: 'sendNotifyToRegionHeads',
                        type: 'Boolean',
                        value: sendNotifyToRegionHeads
                    });
                }
                if (camForm.variableManager.variables['isOptical'].value) {
                    camForm.variableManager.variableValue('isOptical', isOptical);
                } else {
                    if (camForm.variableManager.variables['isOptical']) {
                        camForm.variableManager.destroyVariable('isOptical')
                    }
                    camForm.variableManager.createVariable({
                        name: 'isOptical',
                        type: 'Boolean',
                        value: isOptical
                    });
                }

                if($scope.ptypeCheckbox){
                    camForm.variableManager.createVariable({
                        name: 'ptype',
                        type: 'String',
                        value: 'test'
                    });
                    camForm.variableManager.createVariable({
                        name: 'createJRResult',
                        type: 'String',
                        value: 'approved'
                    });
                } else {
                    camForm.variableManager.createVariable({
                        name: 'ptype',
                        type: 'String',
                        value: 'prod'
                    });
                    camForm.variableManager.createVariable({
                        name: 'createJRResult',
                        type: 'String',
                        value: 'approved'
                    });
                }

                camForm.variableManager.variableValue('modifyJrResult', $scope.modifyJrResult);
                camForm.variableManager.createVariable({
                    name: 'modify_jrTaskResult',
                    type: 'String',
                    value: $scope.modifyJrResult
                });
                if($scope.modifyJrResult === 'canceled'){
                    camForm.variableManager.variableValue('createJRResult', 'rejected');
                }

                camForm.variableManager.createVariable({
                    name: 'cancelPrComment',
                    type: 'String',
                    value: $scope.explanation
                });

                console.log('fskdjfsdkfjdskfj');
                console.log($scope.modifyJrResult);
                if($scope.modifyJrResult === 'modified'){
                    if($scope.materialsRequiredCheckbox){
                        camForm.variableManager.variableValue('materialsRequired', 'Yes');
                    } else {
                        camForm.variableManager.variableValue('materialsRequired', 'No');
                    }
                    if($scope.leasingRequiredCheckbox){
                        camForm.variableManager.variableValue('leasingRequired', 'Yes');
                    } else {
                        camForm.variableManager.variableValue('leasingRequired', 'No');
                    }
                    if($scope.powerRequiredCheckbox){
                        camForm.variableManager.variableValue('powerRequired', 'Yes');
                    } else {
                        camForm.variableManager.variableValue('powerRequired', 'No');
                    }
                    camForm.variableManager.variableValue('explanation', $scope.explanation);

                    camForm.variableManager.createVariable({
                        name: 'worksChanged',
                        type: 'String',
                        value: $scope.worksChanged
                    });
                    if($scope.isPermitDocsNeeded){
                        camForm.variableManager.createVariable({
                            name: 'isPermitDocsNeeded',
                            type: 'String',
                            value: 'true'
                        });
                    } else {
                        camForm.variableManager.createVariable({
                            name: 'isPermitDocsNeeded',
                            type: 'String',
                            value: 'false'
                        });
                    }

                    console.log('fkljsflksdjfkjdsf');
                    console.log($scope.soaComplaintId);
                    camForm.variableManager.variableValue('soaComplaintId', $scope.soaComplaintId);

                    var validityDate = new Date($scope.validityDate);
                    camForm.variableManager.variableValue('validityDate', validityDate);
                    camForm.variableManager.variableValue('worksBelongsTo', $scope.worksBelongsTo);
                    camForm.variableManager.variableValue('contract', parseInt($scope.custom.contract));
                    camForm.variableManager.variableValue('relatedTo', $scope.relatedTo);
                    camForm.variableManager.variableValue('project', $scope.project);
                    camForm.variableManager.variableValue('jobWorks', JSON.parse(angular.toJson($scope.jobWorks)));
                    if(camForm.variableManager.variables['priority'].value){
                        camForm.variableManager.variableValue('priority', $scope.priority);
                    } else {
                        camForm.variableManager.destroyVariable('priority');
                        camForm.variableManager.createVariable({
                            name: 'priority',
                            type: 'String',
                            value: $scope.priority
                        });
                    }

                    if($scope.supplementaryFiles && $scope.supplementaryFiles.value){
                        $scope.supplementaryFiles.value.forEach(function (file) {
                            if (file.name){
                                if(file.isNew){
                                    files.push(file);
                                    delete file.isNew;
                                }
                            }
                        });

                        if(camForm.variableManager.variables['supplementaryFiles']){
                            camForm.variableManager.variableValue('supplementaryFiles', $scope.supplementaryFiles.value);
                        } else {
                            camForm.variableManager.createVariable($scope.supplementaryFiles);
                        }
                    }
                }

                if($scope.explanation){
                    var visibility = 'all';
                    if($scope.explanation && $scope.explanationVisibility){
                        visibility = $scope.explanationVisibility;
                    }
                    camForm.variableManager.createVariable({
                        name: 'modify_jrTaskCommentVisibility',
                        type: 'String',
                        value: visibility
                    });
                }
                camForm.variableManager.createVariable({
                    name: 'modify_jrTaskComment',
                    type: 'String',
                    value: $scope.explanation
                });
                camForm.variableManager.createVariable({
                    name: 'modify_jrFiles',
                    type: 'Json',
                    value: files
                });
                camForm.variableManager.destroyVariable('resolutions');
            });

            $scope.open = open;
            $scope.toggleJr = toggleJr;
            $scope.getJobs = getJobs;
            $scope.addJobWork = addJobWork;
            $scope.showMoreJobRequests = showMoreJobRequests;
            $scope.refreshJobRequests = refreshJobRequests;
            $scope.showMore = false;
            $scope.page = 0;
            $scope.jobRequestsCount = 0;
            $scope.download = download;
            $scope.removeWork = removeWork;
            $scope.serviceChanged = serviceChanged;
            $scope.jobWorks = [{relatedSites:[]}];
            $scope.jobRequests = {};

            $scope.regionsMap = {
                '0': 'Alm',
                '11':'Astana',
                '1': 'N&C',
                '2': 'N&C',
                '3': 'East',
                '4': 'South',
                '5': 'West',
                '6': 'West',
                '7': 'West',
                '8': 'West',
                '9': 'Alm'
            };
            $scope.regionsMapLC = {
                '0': 'alm',
                '11':'astana',
                '1': 'nc',
                '2': 'nc',
                '3': 'east',
                '4': 'south',
                '5': 'west',
                '6': 'west',
                '7': 'west',
                '8': 'west',
                '9': 'alm'
            };
            $scope.contractorShortName = {
                '-1': '##',
                '4': 'LSE',
                '5': 'KR'
            };
            $scope.reasonShortName = {
                '1': 'P&O',
                '2': 'TNU',
                '3': 'S&FM',
                '4': 'SAO'
            };

            $scope.requestedDate = new Date();

            var currentDate = new Date();

            $scope.datepickerOptions = {
                minDate: currentDate
            };

            function removeWork(index){
                $scope.jobWorks.splice(index,1);
            }

            function toggleJr(index){
                if($scope.jrIndex === index){
                    $scope.jrIndex = undefined;
                } else {
                    $scope.jrIndex = index;
                }
            }

            function open($event) {
                $event.preventDefault();
                $event.stopPropagation();
                $scope.dateFieldOpened = true;
            };

            function getJobs(){
                var query = {
                    "processDefinitionKey" : "Revision",
                    "active" : true,
                    "variables" :
                            [{
                                "name": "reason",
                                "operator": "eq",
                                "value": $scope.reason
                            },{
                                "name": "site",
                                "operator": "eq",
                                "value" : $scope.site
                            }]
                };
                var path  = '/camunda/api/engine/engine/default/process-instance?firstResult='+($scope.page*5)+'&maxResults=5';
                $http.post(path,query).then(
                        function(result){
                            $scope.page = $scope.page + 1;
                            var piIds = [];
                            if(result.data.length < 5){
                                $scope.showMore = false;
                            } else {
                                $scope.showMore = true;
                            }
                            for(var i=0;i<result.data.length;i++){
                                piIds.push(result.data[i].id);
                            }
                            var variableQuery = {
                                processInstanceIdIn: piIds
                            };
                            if(piIds.length > 0){
                                $http.post('/camunda/api/engine/engine/default/variable-instance?deserializeValues=false', variableQuery).then(
                                        function(variables){
                                            for(var i=0;i<variables.data.length;i++){
                                                if(!$scope.jobRequests[variables.data[i].processInstanceId]){
                                                    $scope.jobRequestsCount++;
                                                    $scope.jobRequests[variables.data[i].processInstanceId] = {};
                                                }
                                                if(variables.data[i].name === 'jobWorks'){
                                                    $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = JSON.parse(variables.data[i].value);
                                                } else if(variables.data[i].name === 'supplementaryFiles'){
                                                    $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i];
                                                } else if(variables.data[i].name === 'initiatorFull'){
                                                    $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = JSON.parse(variables.data[i].value);
                                                } else {
                                                    $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i].value;
                                                }

                                            }
                                        },
                                        function(error){
                                            console.log(error);
                                        }
                                );
                            }
                        },
                        function(error){
                            console.log(error);
                        }
                );
            }

            function addJobWork(){
                $scope.jobWorks.push({relatedSites:[]});
            }

            function showMoreJobRequests(){
                getJobs();
            }

            function refreshJobRequests(){
                $scope.page = 0;
                $scope.jobRequestsCount = 0;
                $scope.jobRequests = {};
                getJobs();
            }

            $scope.fileSelected = function(el, bindedInput){
                if(el.files[0]){
                    $timeout(function () {
                        $scope.$apply(function () {
                            uploadFileToMinio(el.files[0], bindedInput);
                        });
                    })
                }
            };

            function uploadFileToMinio(file, bindedInput) {

                var fileValue = {
                    name: file.name.replace(/[/\\?%#*:|"<>]/g, '-'),
                    path: $scope.processInstanceId + '/' + camForm.taskId + '/' + file.name.replace(/[/\\?%*:|"<>]/g, '-'),
                    isNew: true
                };
                $http({method: 'GET', url: '/camunda/uploads/put/' + fileValue.path, transformResponse: [] }).
                then(function(response) {
                    $http.put(response.data, file, {headers: {'Content-Type': undefined}}).then(
                            function () {
                                if(!$scope.supplementaryFiles.value){
                                    $scope.supplementaryFiles.value = [];
                                }
                                $scope.supplementaryFiles.value.push(fileValue);
                                angular.element(document.querySelector('#supplementaryFiles')).val(null);
                                $(bindedInput).val('');
                            },
                            function (error) {
                                console.log(error.data);
                            }
                    );
                }, function(error){
                    console.log(error.data);
                });
            }

            function download(file) {
                $http({method: 'GET', url: '/camunda/uploads/get/' + file.path, transformResponse: [] }).
                then(function(response) {
                    document.getElementById('fileDownloadIframe').src = response.data;
                }, function(error){
                    console.log(error.data);
                });
            }

            function serviceChanged(){
                $scope.conts = [];
                if($scope.contracts){
                    for(var i=0;i<$scope.contracts.length;i++){
                        if($scope.contracts[i].service.id == $scope.custom.contract){
                            $scope.conts.push($scope.contracts[i].contractor);
                        }
                    }
                }
            }

<!--            $scope.getUnits = function(index){-->
<!--                for(var i=0;i<$scope.works.length;i++){-->
<!--                    if($scope.jobWorks[index].sapServiceNumber === $scope.works[i].sapServiceNumber){-->
<!--                        $scope.jobWorks[index].materialUnit = $scope.works[i].units;-->
<!--                    }-->
<!--                }-->
<!--            };-->
            $scope.getUnits = function($item, index){
                if($item.id === -1){
                    $scope.jobWorks[index].sapServiceNumber = undefined;
                    $scope.jobWorks[index].displayServiceName = undefined;
                    $scope.jobWorks[index].materialUnit = undefined;
                    $scope.jobWorks[index].materialsProvidedBy = undefined;
                    $scope.jobWorks[index].materialsProvidedByDisabled = false;
                } else {
                    $scope.jobWorks[index].materialsProvidedBy = null;
                    $scope.jobWorks[index].sapServiceNumber = $item.sapServiceNumber;
                    $scope.jobWorks[index].displayServiceName = $item.displayServiceName;
                    $scope.jobWorks[index].materialUnit = $item.units;
                    $scope.jobWorks[index].materialsProvidedByDisabled = true;
                    if (subContractorsMaterials.includes($scope.jobWorks[index].sapServiceNumber)) {
                        $scope.jobWorks[index].materialsProvidedBy = 'subcontractor'
                    }
                    if (kcellMaterials.includes($scope.jobWorks[index].sapServiceNumber)) {
                        $scope.jobWorks[index].materialsProvidedBy = 'kcell'
                    }
                    if (allMaterials.includes($scope.jobWorks[index].sapServiceNumber)) {
                        $scope.jobWorks[index].materialsProvidedByDisabled = false;
                    }
                }
            };
            $scope.getWorks = function(val) {
                var result = _.filter($scope.works, function(work){
                    return work.displayServiceName.indexOf(val) !== -1;
                })

                result = _.filter(result, function(element){
                    if(!$scope.mainContract || !$scope.custom.contractor){
                        return false;
                    } else {
                        if($scope.mainContract === 'Roll-outRevision2020'){
                            return element.id >= 3000;
                        } else if($scope.mainContract === 'Roll-out'){
                            return (element.id > 1000 && element.id < 2000);
                        } else if($scope.mainContract === 'Revision'){
                            if($scope.contractorShortName[$scope.custom.contractor] === 'KR'){
                                return (element.id < 1000 || (element.id > 2000 && element.id < 3000));
                            } else {
                                return element.id < 1000;
                            }
                        }
                    }
                });

                result = _.filter(result, function(element){
                    if($scope.mainContract === 'Roll-out') {
                        if(element.id !== 1013 && _.some($scope.jobWorks, function(w){ return w.sapServiceNumber === 'RO13' })){
                            return false;
                        } else if(element.id === 1013 && _.some($scope.jobWorks, function(w){ return w.sapServiceNumber && w.sapServiceNumber !== 'RO13' })) {
                            return false;
                        } else {
                            return true;
                        }
                    } else if($scope.mainContract === 'Revision') {
                        if(element.id === 9){
                            return $scope.siteStatus && $scope.siteStatus === 'will be dismantled';
                        } else if(element.id === 8){
                            return $scope.siteStatus && $scope.siteStatus === 'will be replacement';
                        } else {
                            return true;
                        }
                    } else if($scope.mainContract === 'Roll-outRevision2020') {
                        if ($scope.siteStatus !== 'will be dismantled' && $scope.siteStatus !== 'will be replacement') {
                            return element.id !== 3007
                        } else {
                            return true;
                        }
                    } else return true;
                });

                result = _.filter(result, function(element){
                    if($scope.mainContract === 'Roll-out' || $scope.mainContract === 'Revision'){
                        return true;
                    } else if($scope.mainContract === 'Roll-outRevision2020') {
                       if($scope.custom.contractor === '5') {
                            if($scope.reason === '1') {
                               return $scope.notAllowedANRUjobs.indexOf(element.sapServiceNumber) === -1;
                            } else if($scope.reason === '2') {
                                return $scope.notAllowedTNUjobs.indexOf(element.sapServiceNumber) === -1;
                            } else if($scope.reason === '3') {
                                return $scope.notAllowedSFMjobs.indexOf(element.sapServiceNumber) === -1;
                            } else return true;

                       } else return true;
                    } else return true;
                });

                if(result.length === 0){
                    result.push({
                        "id":-1,
                        "sapServiceNumber":"",
                        "sapPOServiceName":"Не найдено",
                        "displayServiceName":"Не найдено",
                        "currency":"",
                        "units":""
                    });
                }
                return result;
            }

            $scope.getSite = function(val) {
                return $http.get('/camunda/sites/name/contains/'+val).then(
                    function(response){
                        return response.data.map(el => ({ id: el.id, name: el.siteid, site_name: el.site_name }))
                    });
            };

            $scope.siteSelected = function($item){
                $scope.siteName = $item.name;
                $scope.site = $item.siteid;
                $scope.site_name = $item.site_name;
                if($scope.siteName.startsWith('11')){
                    $scope.regionShortName = $scope.regionsMap['11'];
                    $scope.siteRegion  = $scope.regionsMapLC['11'];
                } else {
                    $scope.regionShortName = $scope.regionsMap[$scope.siteName.substring(0,1)];
                    $scope.siteRegion = $scope.regionsMapLC[$scope.siteName.substring(0,1)];
                }
                refreshJobRequests();
            };

            $scope.workSiteSelected = function($item, $index){
                if(!$scope.jobWorks[$index].relatedSites){
                    $scope.jobWorks[$index].relatedSites = [];
                }
                if(!_.some($scope.jobWorks[$index].relatedSites, function(value){
                    return value.site_name === $item.site_name;
                })){
                    $scope.jobWorks[$index].relatedSites.push($item);
                }
                $scope.tempSite = {};
            };

            $scope.removeRelatedSite = function(i, j){
                $scope.jobWorks[i].relatedSites.splice(j,1);
            }

            $scope.siteJobWorkSelected = function($item, $index){
                $scope.jobWorks[$index].sites.name = $item.name;
                $scope.jobWorks[$index].sites.id = $item.id;
            };
            $scope.clearWorkSiteId = function($index){
                if(!$scope.jobWorks[$index].sites){
                    $scope.jobWorks[$index].sites = {id:undefined};
                }
                $scope.jobWorks[$index].sites.id = undefined;
            };
            var diff;
            if(window.requirejs){
                diff = window.requirejs('deep-diff').diff;
            } else {
                diff = window.DeepDiff;
            }

            $scope.preSubmit = function(){
                var deferred = $q.defer();
                var a = JSON.stringify($scope.oldWorks, function(key, value) {
                    if (typeof key === 'string' && (key.charAt(0) === '$' || key === 'this')) {
                        return undefined;
                    }
                    return value;
                });
                var b = JSON.stringify($scope.jobWorks, function(key, value) {
                    if (typeof key === 'string' && (key.charAt(0) === '$' || key === 'this')) {
                        return undefined;
                    }
                    return value;
                });
                var delta = diff(a, b);
                if(delta){
                    $scope.worksChanged = 'true';
                } else {
                    $scope.worksChanged = 'false';
                }

                var containsPermit = _.intersection(_.map($scope.jobWorks, 'sapServiceNumber'), permitWorks);
                $scope.isPermitDocsNeeded = containsPermit.length > 0;
                var promises = [];

                if($scope.modifyJrResult === 'modified'){
                    var contains = _.some(_.flatMap($scope.jobWorks, 'relatedSites'), function(value){
                        return value.site_name === $scope.site_name;
                    });
                    if(!contains){
                        deferred.reject('At least one job should contains Main Site');
                    } else {
                        deferred.resolve();
                    }
                } else {
                    deferred.resolve();
                }
                return $q.all(promises);
            };

            $scope.clearFile = function(index){
                $scope.supplementaryFiles.value.splice(index, 1);
            }

            $scope.isVisible = function (resolution) {
                return !resolution.visibility || resolution.visibility === 'all' || (resolution.visibility === 'kcell' && $rootScope.hasGroup('kcellUsers'));
            }

            $scope.hasComment = function () {
                return $scope.explanation && $rootScope.hasGroup('kcellUsers');
            }

            $scope.filterByContractor = function(element) {
                if(!$scope.mainContract || !$scope.custom.contractor) return false;
                if($scope.mainContract === 'Roll-outRevision2020'){
                    return element.id >= 3000;
                } else if($scope.mainContract === 'Roll-out'){
                    return (element.id > 1000 && element.id < 2000);
                } else if($scope.mainContract === 'Revision'){
                    if($scope.contractorShortName[$scope.custom.contractor] === 'KR'){
                        return (element.id < 1000 || (element.id > 2000 && element.id < 3000));
                    } else {
                        return element.id < 1000;
                    }
                } else return true;
            };

            $scope.filterByStatus = function(element) {
                if($scope.mainContract === 'Roll-out') {
                    if(element.id !== 1013 && _.some($scope.jobWorks, function(w){ return w.sapServiceNumber === 'RO13' })){
                        return false;
                    } else if(element.id === 1013 && _.some($scope.jobWorks, function(w){ return w.sapServiceNumber && w.sapServiceNumber !== 'RO13' })) {
                        return false;
                    } else {
                        return true;
                    }
                } else if($scope.mainContract === 'Revision') {
                    if(element.id === 9){
                        if($scope.siteStatus && $scope.siteStatus == 'will be dismantled'){
                            return true;
                        } else {
                            return false;
                        }
                    } else if(element.id === 8){
                        if($scope.siteStatus && $scope.siteStatus == 'will be replacement'){
                            return true;
                        } else {
                            return false;
                        }
                    } else {
                        return true;
                    }
                } else if($scope.mainContract === 'Roll-outRevision2020') {
                        // siteSubStatus == Will be rqeplacement or Will be dismantled
                    if ($scope.jobModel.siteSubStatusId !== 6 && $scope.jobModel.siteSubStatusId !== 7) {
                        return element.id !== 3007
                    } else {
                        return true;
                    }
                } else return true;
            };
        }]);
    </script>
    <h4>Create job request</h4>
    <div class="form-group">
        <label class="col-sm-4 control-label">JR Number:</label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{jrNumber}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Contract</label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{mainContract === 'Roll-outRevision2020' ? 'Roll-out and Revision 2020' : mainContract}}</div>
        </div>
    </div>
    <div class="form-group" ng-if="!isOldContracts">
        <label class="col-sm-4 control-label">Job to:</label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{contractorsTitle[contractor]}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Creation date</label>
        <div class="col-sm-3">
            <div class="form-control">{{requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Validity date:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="validityDate" name="validityDate" ng-required="modifyJrResult == 'modified'" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="dateFieldOpened" id="validityDate" min-date="datepickerOptions.minDate" />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="open($event)">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>
    <div class="form-group" ng-show="isOldContracts">
        <label class="col-sm-4 control-label">SA&O Complaint Id:</label>
        <div class="col-sm-3">
            <input type="text" ng-model="soaComplaintId" name="soaComplaintId" class="form-control" maxlength="20"/>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Site: </label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{siteName}} | status: {{siteStatus}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Site Name: </label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{site_name}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Reason:</label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{reasonsTitle[reason]}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Related to the:</label>
        <div class="col-sm-8">
            <label class="radio-inline">
                <input type="radio" name="relatedTo" ng-required="modifyJrResult == 'modified'" ng-model="relatedTo" value="Capacity"> Capacity
            </label>
            <label class="radio-inline">
                <input type="radio" name="relatedTo" ng-required="modifyJrResult == 'modified'" ng-model="relatedTo" value="Coverage"> Coverage
            </label>
            <label class="radio-inline">
                <input type="radio" name="relatedTo" ng-required="modifyJrResult == 'modified'" ng-model="relatedTo" value="Quality"> Quality
            </label>
            <label class="radio-inline">
                <input type="radio" name="relatedTo" ng-required="modifyJrResult == 'modified'" ng-model="relatedTo" value="Field works"> Field works
            </label>
            <label class="error" ng-if="kcell_form.relatedTo.$error.required && ( kcell_form.relatedTo.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group" ng-show="isOldContracts">
        <label class="col-sm-4 control-label">Contractor:</label>
        <div class="col-sm-3">
            <div class="form-control disabled">{{contractorsTitle[contractor]}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Type of project:</label>
        <div class="col-sm-3">
            <select ng-model="project" name="project" class="form-control" ng-required="modifyJrResult == 'modified'">
                <option value="N/A">N/A</option>
                <option value="4G Sharing">4G Sharing</option>
                <option ng-if="reason === '2'" value="Other - (Re-routing, re-planning, etc.)">Other - (Re-routing, re-planning, etc.)</option>
                <option ng-if="reason === '2'" value="Transmission FIX/IPVPN">Transmission FIX/IPVPN</option>
                <option ng-if="reason === '2'" value="Transmission PBX">Transmission PBX</option>
                <option ng-if="reason === '2'" value="Transmission 1+1">Transmission 1+1</option>
                <option ng-if="reason === '2'" value="Transmission Upgrades">Transmission Upgrades</option>
                <option ng-if="reason === '2'" value="Transmission Revision LTE">Transmission Revision LTE</option>

                <!-- <option ng-if="reason === '3'" value="Air conditioner planned installation 1+1 for transmission (53 sites)">Air conditioner planned installation 1+1 for transmission (53 sites)</option> -->
                <!-- <option ng-if="reason === '3'" value="Power system planned modernization 40 sites(ZTE B121)">Power system planned modernization 40 sites(ZTE B121)</option> -->
                <!-- <option ng-if="reason === '3'" value="Termobox installation for «4G sharing» project">Termobox installation for «4G sharing» project</option> -->
                <option ng-if="reason === '3'" value="Termobox installation for transmission (TN)">Termobox installation for transmission (TN)</option>
                <!-- <option ng-if="reason === '3'" value="Termobox installation for «rollout»">Termobox installation for «rollout»</option> -->
                <option ng-if="reason === '3'" value="Установка ИБП для организации услуги fix клиенту (по запросу от группы трансмиссии)">Установка ИБП для организации услуги fix клиенту (по запросу от группы трансмиссии)</option>
                <option ng-if="reason === '1'" value="LTE 2019">LTE 2019</option>
                <option ng-if="reason === '1'" value="LTE 2100 2019">LTE 2100 2019</option>
                <option ng-if="reason === '1'" value="LTE 1800 2019">LTE 1800 2019</option>
                <option ng-if="reason === '1'" value="2G+3G Roll-Out 2019">2G+3G Roll-Out 2019</option>
                <option ng-if="reason === '1'" value="3CCA_LTE2100">3CCA_LTE2100</option>
                <option ng-if="reason === '1'" value="CA_LTE1800">CA_LTE1800</option>
                <option ng-if="reason === '1'" value="CEM">CEM</option>
                <option ng-if="reason === '1'" value="MIMO 4x4">MIMO 4x4</option>
                <option ng-if="reason === '1'" value="ZTE SWAP">ZTE SWAP</option>
                <option ng-if="reason === '1'" value="CA_LTE1800">CA_LTE1800</option>
                <option ng-if="reason === '1'" value="3CCA_LTE2100">3CCA_LTE2100</option>
                <option ng-if="reason === '1'" value="MIMO 4x4">MIMO 4x4</option>
                <option ng-if="reason === '1'" value="CEM">CEM</option>
                <option ng-if="reason === '1'" value="SES">SES</option>
                <option value="Roll-Out 2020">Roll-Out 2020</option>
                <option value="250+">250+</option>
                <option value="Roll-Out 2021">Roll-Out 2021</option>
                <option ng-if="reason === '5'" value=" 2G/3G from 2019"> 2G/3G from 2019 </option>
                <option ng-if="reason === '5'" value=" 65 - Com. Block"> 65 - Com. Block </option>
                <option ng-if="reason === '5'" value=" RND 2020"> RND 2020 </option>
                <option ng-if="reason === '5'" value=" LTE from 2019"> LTE from 2019 </option>
                <option ng-if="reason === '5'" value=" LTE 2020"> LTE 2020 </option>
                <option ng-if="reason === '5'" value=" Com. Block 2020"> Com. Block 2020 </option>
                <option ng-if="reason === '5'" value=" LTE 2019"> LTE 2019 </option>
                <option ng-if="reason === '5'" value=" B2B 2020"> B2B 2020 </option>
                <option ng-if="reason === '5'" value=" 250+"> 250+ </option>
                <option ng-if="reason === '5'" value=" Com. Block (3 Reg.)"> Com. Block (3 Reg.) </option>
                <option ng-if="reason === '5'" value=" ERG"> ERG </option>
                <option ng-if="reason === '5'" value=" License settlement"> License settlement </option>
                <option ng-if="reason === '5'" value=" Kazminerals LTE Project"> Kazminerals LTE Project </option>

                <option ng-if="reason === '4'" value="Facility Improvement"> Facility Improvement</option> 
                <option ng-if="reason === '4'" value="ППР крупно-узловых сайтов"> ППР крупно-узловых сайтов</option> 

                <option ng-if="reason === '2'" value="Модернизация сети трансмиссии (строительство новых хопов и апгрейд старых для увеличения емкости сети, кроме работ по проектам Roll-Out и 250+)"> Модернизация сети трансмиссии (строительство новых хопов и апгрейд старых для увеличения емкости сети, кроме работ по проектам Roll-Out и 250+)</option>
                <option ng-if="reason === '2'" value="Roll-Out - вспомогательные работы для запуска новых сайтов (кроме работ по проекту 250+)"> Roll-Out - вспомогательные работы для запуска новых сайтов (кроме работ по проекту 250+)</option>
                <option ng-if="reason === '2'" value="Проект 250+ (включая модернизацию сети для запуска сайтов по данному проекту)"> Проект 250+ (включая модернизацию сети для запуска сайтов по данному проекту)</option>
                <option ng-if="reason === '2'" value="Надежность сети трансмиссии (добавление 1+1, перенос, укрепление антенн для лучшей настройки, добавление PFU 1+1 и т.д.) "> Надежность сети трансмиссии (добавление 1+1, перенос, укрепление антенн для лучшей настройки, добавление PFU 1+1 и т.д.) </option>
                <option ng-if="reason === '2'" value="Перенос оборудования трансмиссии (re-routing, re-planning)"> Перенос оборудования трансмиссии (re-routing, re-planning)</option>
                <option ng-if="reason === '2'" value="Подключение сторонних клиентов (FIX/IPVPN/PBX)"> Подключение сторонних клиентов (FIX/IPVPN/PBX)</option>
                <option ng-if="reason === '2'" value="Межоператорские соединения (sharing, ТПТ и т.д.)"> Межоператорские соединения (sharing, ТПТ и т.д.)</option>
                <option ng-if="reason === '2'" value="Перевод спутниковых сайтов на наземную трансмиссию"> Перевод спутниковых сайтов на наземную трансмиссию</option>

                <option ng-if="reason === '3'" value="Power system modernization"> Power system modernization</option>
                <option ng-if="reason === '3'" value="Power system installation"> Power system installation</option>
                <option ng-if="reason === '3'" value="Air conditioner installation"> Air conditioner installation</option>
                <option ng-if="reason === '3'" value="Termobox installation"> Termobox installation</option>
                <option ng-if="reason === '3'" value="Строительство HOP-POINT"> Строительство HOP-POINT</option>
                <option ng-if="reason === '3'" value="Revision works for transmission "> Revision works for transmission </option>
                <option ng-if="reason === '3'" value="Revision works по причинам необходимой модернизации инфраструктуры"> Revision works по причинам необходимой модернизации инфраструктуры</option>
            </select>
            <label class="error" ng-if="kcell_form.project.$error.required && ( kcell_form.project.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Priority:</label>
        <div class="col-sm-3">
            <select ng-model="priority" name="priority" class="form-control" ng-required="modifyJrResult == 'modified'" ng-disabled="reason && reason !== '4'">
                <option value="regular">Regular</option>
                <option value="emergency">Emergency</option>
            </select>
            <label class="error" ng-if="kcell_form.priority.$error.required && ( kcell_form.priority.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Works belongs to KZT, Beeline, ODS:</label>
        <div class="col-sm-8">
            <!-- NOT REQUIRED -->
            <label class="radio-inline">
                <input type="radio" name="worksBelongsTo" ng-model="worksBelongsTo" id="worksBelongsTo1" value="Yes" ng-required="modifyJrResult == 'modified'"> Yes
            </label>
            <label class="radio-inline">
                <input type="radio" name="worksBelongsTo" ng-model="worksBelongsTo" id="worksBelongsTo2" value="No" ng-required="modifyJrResult == 'modified'"> No
            </label>
            <label class="error" ng-if="kcell_form.worksBelongsTo.$error.required && ( kcell_form.worksBelongsTo.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Supplementary files:</label>
        <div class="col-sm-8">
            <div class="input-group" ng-repeat="file in supplementaryFiles.value">
                <a ng-click="download(file)">{{file.name}}</a>| <a ng-click="clearFile($index)"><i class="glyphicon glyphicon-trash"></i></a>
                <div class="input-group-addon" ng-show="file.name && hasGroup('kcellUsers')">
                    <label class="radio-inline">
                        <input type="radio" name="supplementaryFile_{{$index}}" ng-model="file.visibility"
                               value="all" ng-required="file.name && hasGroup('kcellUsers')"> Visible for all
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="supplementaryFile_{{$index}}" ng-model="file.visibility"
                               value="kcell" ng-required="file.name && hasGroup('kcellUsers')"> Kcell staff only
                    </label>
                    <label class="error" ng-show="kcell_form['supplementaryFile_'+$index].$error.required && ( kcell_form['supplementaryFile_'+$index].$touched || view.submitted)">Required field</label>
                </div>
            </div>
            <div class="input-group">
                <label class="input-group-btn">
                    <span class="btn btn-default">
                        Choose File <input type="file" id="supplementaryFiles" name="supplementaryFiles" style="display: none;" onchange="angular.element(this).scope().fileSelected(this, '#supplementaryFilesName');$('#supplementaryFilesName').val(this.files[0].name)" >
                    </span>
                </label>
                <input type="text" class="form-control upload-filename" id="supplementaryFilesName" placeholder="No File Chosen" readonly>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Running job requests for these sites ({{jobRequestsCount}} JRs)</label>
        <div class="col-sm-8">
            <div ng-repeat="(k,job) in jobRequests">
                <a ng-click="toggleJr($index)">JR No. {{job.jrNumber}}, Reason: {{reasonsTitle[job.reason]}}, Created at: {{job.requestedDate | date: 'dd.MM.yyyy'}}</a>
                <div ng-if="jrIndex === $index" class="animate-if" ng-animate-children>
                    <div class="row">
                        <div class="col-md-4"><b>Initiator</b>: {{job.initiatorFull.firstName}} {{job.initiatorFull.lastName}}</div>
                        <div class="col-md-8"><b>JR Number</b>: {{job.jrNumber}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><b>Creation date</b>: {{job.requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
                        <div class="col-md-4"><b>Reason</b>: {{reasonsTitle[job.reason]}}</div>
                        <div class="col-md-4"><b>Materials required</b>: {{job.materialsRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><b>Validity date</b>: {{job.validityDate.value | date: 'dd.MM.yyyy'}}</div>
                        <div class="col-md-4"><b>Contract</b>: {{servicesTitle[job.contract]}}</div>
                        <div class="col-md-4"><b>Leasing required</b>: {{job.leasingRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><b>SA&O Complaint Id</b>: {{job.soaComplaintId}}</div>
                        <div class="col-md-4"><b>Contractor</b>: {{contractorsTitle[job.contractor]}}</div>
                        <div class="col-md-4"><b>Site (near end)</b>: {{job.siteName}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4"><b>Power engineering required</b>: {{job.powerRequired}}</div>
                        <div class="col-md-4"><b>Project</b>: {{job.project}}</div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">Creation date: {{job.requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
                        <div class="col-md-4">Reason: {{reasonsTitle[job.reason]}}</div>
                        <div class="col-md-4">Materials required: {{job.materialsRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">Validity date: {{job.validityDate | date: 'dd.MM.yyyy'}}</div>
                        <div class="col-md-4">Contract: {{servicesTitle[job.contract]}}</div>
                        <div class="col-md-4">Leasing required: {{job.leasingRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">SA&O Complaint Id: {{job.soaComplaintId}}</div>
                        <div class="col-md-4">Contractor: {{contractorsTitle[job.contractor]}}</div>
                        <div class="col-md-4">Site (near end): {{job.siteName}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">Supplementary files:</div>
                        <iframe id="fileDownloadIframe" style="display:none;"></iframe>
                        <div class="col-md-12" ng-repeat="file in supplementaryFiles.value">
                            <a ng-click="download(file)">{{file.name}}</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">Works:</div>
                        <div class="col-md-12" ng-repeat="work in job.jobWorks">
                            <a href="javascript:void(0)">{{$index+1}}. {{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}},</span> on sites: {{work.sites}} (Near end)</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">{{work.explanation}}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <button type="button" ng-click="showMoreJobRequests()" class="btn btn-sm btn-primary" ng-disabled="!showMore"><i class="glyphicon glyphicon-th-list"></i> <span ng-if="showMore">Show more</span><span ng-if="!showMore">No more similar job requests</span></span></button>
            </div>
        </div>
    </div>
    <h4>Works</h4>
    <div class="col-sm-12">
        <div class="row">
            <table class="table table-condensed">
                <thead>
                <tr>
                    <th width="40%">Works</th>
                    <th width="7%">Works Qty</th>
                    <th width="13%" ng-if="isOldContracts">Materials Qty</th>
                    <th width="16%" ng-if="!isOldContracts">Materials By</th>
                    <th width="30%">Sites involved</th>
                    <th></th>
                </tr>
                </thead>
                <tbody ng-repeat="jobWork in jobWorks">
                <tr>
                    <ng-form name="workForm">
                        <td ng-if="isOldContracts">
                            <select ng-model="jobWork.sapServiceNumber" name="sapServiceNumber" ng-required="modifyJrResult == 'modified'" class="form-control" ng-change="getUnits($index)">
                                <option value="">Select work</option>
                                <option ng-repeat="work in works | filter: filterByContractor | filter: filterByStatus" ng-selected="{{work.sapServiceNumber == jobWork.sapServiceNumber}}" value="{{work.sapServiceNumber}}">{{work.displayServiceName}}</option>
                            </select>
                            <label class="error" ng-if="workForm.sapServiceNumber.$error.required && ( workForm.sapServiceNumber.$touched || view.submitted)">Required field</label>
                        </td>
                        <td ng-if="!isOldContracts">
                            <div>
                                <input type="text" ng-model="jobWork.displayServiceName" name="displayServiceName{{$index}}"
                                       ng-disabled="!mainContract || !siteName || !custom.contractor"
                                       typeahead="works as works.displayServiceName for works in getWorks($viewValue)"
                                       typeahead-on-select="getUnits($item, $index)"
                                       class="form-control works-container"  required autocomplete="off" placeholder="Search works">
                                <label class="error" ng-if="kcell_form['displayServiceName'+$index].$error.required && ( kcell_form['displayServiceName'+$index].$touched || view.submitted)">Required field</label>
                                <label class="error" ng-if="kcell_form['sapServiceNumber'+$index].$error.required && ( kcell_form['displayServiceName'+$index].$touched || view.submitted)">Please select from list</label>
                            </div>
                            <label class="error" ng-if="workForm.sapServiceNumber.$error.required && ( workForm.sapServiceNumber.$touched || view.submitted)">Required field</label>
                        </td>
                        <td>
                            <input type="number" class="form-control" name="quantity" ng-required="modifyJrResult == 'modified'" ng-model="jobWork.quantity" min="1"/>
                            <label class="error" ng-if="workForm.quantity.$error.required && ( workForm.quantity.$touched || view.submitted)">Required field</label>
                        </td>
                        <td ng-if="isOldContracts">
                            <div class="input-group">
                                <input type="number" class="form-control" name="materialQuantity" ng-required="modifyJrResult == 'modified'" ng-model="jobWork.materialQuantity" min="0" style="min-width: 55px;"/>
                                <span class="input-group-addon">{{jobWork.materialUnit}}</span>
                            </div>
                            <label class="error" ng-if="workForm.materialQuantity.$error.required && ( workForm.materialQuantity.$touched || view.submitted)">Required field</label>
                        </td>
                        <td style="padding-left: 40px" ng-if="!isOldContracts">
                            <input id="subContractorMaterial{{$index}}" type="radio" ng-model="jobWork.materialsProvidedBy" name="materialsProvidedBy{{$index}}" value="subcontractor" required ng-disabled="jobWork.materialsProvidedByDisabled">
                            <label class="bolder" for="subContractorMaterial{{$index}}">Subcontractor</label>
                            <br/>
                            <input id="kcellMaterials{{$index}}" type="radio" ng-model="jobWork.materialsProvidedBy" name="materialsProvidedBy{{$index}}" value="kcell" required ng-disabled="jobWork.materialsProvidedByDisabled">
                            <label class="bolder" for="kcellMaterials{{$index}}">Kcell</label>
                            <label class="error" ng-show="kcell_form['materialsProvidedBy'+$index].$error.required && ( kcell_form['materialsProvidedBy'+$index].$touched || view.submitted)">Required field</label>
                        </td>
                        <td>
                            <span ng-repeat="rs in jobWork.relatedSites" class="my-tag" ng-class="{'main-site':rs.site_name===site_name}"><span ng-if="rs.site_name===site_name">Main Site: </span>{{rs.site_name}} <a ng-click="removeRelatedSite($parent.$index, $index)">&times;</a></span>
                            <input type="text" ng-model="tempSite.name" style="display: inline-block; width:100px;" name="tempSiteName" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="workSiteSelected($item, $index); tempSite={};" class="form-control" autocomplete="off" placeholder="Add Site">
                        </td>
                        <td><div class="col-md-1"><button type="button" class="btn btn-sm btn-warning" ng-if="$index !== 0" ng-click="removeWork($index)"><i class="glyphicon glyphicon-trash"></i> Remove</button></div></td>
                    </ng-form>
                </tr>
                <tr>
                    <td>
                        <div class="input-group">
                                <span class="input-group-addon">
                                    Work Request Reason
                                    <a role="button" data-toggle="collapse" href="#collapseReasonGeneralInfo" aria-expanded="false" aria-controls="collapseReasonGeneralInfo">
                                        <i class="glyphicon glyphicon-question-sign"></i>
                                    </a>
                                </span>
                            <select ng-model="jobWork.reason" name="reason{{$index}}" required class="form-control" ng-change="defineExpenseType($index)">
                                <option value="">Select work request reason</option>
                                <option ng-repeat="reason in jobWorkReasons" ng-selected="{{reason.id == jobWork.reason}}" value="{{reason.id}}">{{reason.name}}</option>
                            </select>
                        </div>
                        <label class="error" ng-if="kcell_form['reason'+$index].$error.required && ( kcell_form['reason'+$index].$touched || view.submitted)">Required field</label>
                    </td>
                    <td colspan="4">
                        <i ng-show="jobWork.reasonDetail" class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="right" title="{{jobWork.reasonDetail}}"></i>
                    </td>
                </tr>
                <tr>
                    <td style="border-width: 0px" colspan="4">
                        <div class="collapse" id="collapseReasonGeneralInfo">
                            <div class="well">
                                <b>Installation</b> Монтаж - установка нового оборудования <br />
                                <b>Modernization</b> Модернизация - замена оборудования на более производительное <br />
                                <b>Change for support</b> Замена - восстановление вышедшего из строя оборудования/OC для поддержания их в рабочем состоянии  с целью их профилактики <br />
                                <b>Change for improvement</b> Замена - восстановление вышедшего из строя оборудования/ОС для улучшения состояния объекта, повышающего его первоначально оцененные нормативные показатели: срок службы, производственную мощность и т. д<br />
                                <b>Replacement</b> Перемещение - в пределах одного сайта<br />
                                <b>Removal</b> Демонтаж - снятие оборудования
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="5"><button type="button" class="btn btn-sm btn-primary" style="margin-top: 10px;" ng-click="addJobWork()"><i class="glyphicon glyphicon-plus"></i> Add work</button></td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="row">

        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Materials ordering Required:</label>
        <div class="col-sm-8">
            <input type="checkbox" ng-model="materialsRequiredCheckbox" />
        </div>
        <div class="col-sm-12" style="padding-left: 40px; padding-top: 10px"><span>*Галочка нужна в случае необходимости заказа/одобрения/выдачи материалов</span></div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Leasing required:</label>
        <div class="col-sm-8">
            <input type="checkbox" ng-model="leasingRequiredCheckbox" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Power engineering required:</label>
        <div class="col-sm-8">
            <input type="checkbox" ng-model="powerRequiredCheckbox" />
        </div>
    </div>
    <div class="form-group" ng-show="showJump">
        <label class="col-sm-4 control-label">Jump to Fill applied changed (test only):</label>
        <div class="col-sm-8">
            <input type="checkbox" ng-model="ptypeCheckbox" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Resolution</label>
        <div class="col-sm-8">
            <label class="radio-inline">
                <input type="radio" ng-model="modifyJrResult" name="modifyJrResult" value="modified" required> Modified
            </label>
            <label class="radio-inline">
                <input type="radio" ng-model="modifyJrResult" name="modifyJrResult" value="canceled" required> Cancel
            </label>
            <label class="error" ng-show="kcell_form.modifyJrResult.$error.required && ( kcell_form.modifyJrResult.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Explanation of works</label>
        <div class="col-sm-8">
            <!-- NOT REQUIRED -->
            <textarea class="form-control" name="explanation" ng-model="explanation" placeholder="Explanation of works..." maxlength="1500" rows="4" required></textarea>
            <label class="error" ng-if="kcell_form.explanation.$error.required && ( kcell_form.explanation.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group" ng-show="hasComment()">
        <label class="col-sm-4 control-label">Comments visibility</label>
        <div class="col-sm-8">
            <label class="radio-inline">
                <input type="radio" name="explanationVisibility"
                       ng-model="explanationVisibility" value="all" ng-required="hasComment()"> Visible for all
            </label>
            <label class="radio-inline">
                <input type="radio" name="explanationVisibility"
                       ng-model="explanationVisibility" value="kcell" ng-required="hasComment()"> Kcell staff only
            </label>
            <label class="error" ng-show="kcell_form.explanationVisibility.$error.required && ( kcell_form.explanationVisibility.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <accordion>
        <accordion-group is-open="isHistoryOpen">
            <accordion-heading>
                History <i class="pull-right glyphicon" ng-class="{'glyphicon-chevron-up': status.isCustomHeaderOpen, 'glyphicon-chevron-down': !status.isCustomHeaderOpen}"></i>
            </accordion-heading>
            <resolution-history resolutions="resolutions" procDef="Revision"></resolution-history>
        </accordion-group>
    </accordion>
</form>
