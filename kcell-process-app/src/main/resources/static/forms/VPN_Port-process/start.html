<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script" type="text/javascript">
        inject(['$scope', '$http', '$rootScope', '$q', '$timeout', 'exModal', function ($scope, $http, $rootScope, $q) {
            $scope.addedPorts = [];
            $scope.disbandPorts = [];
            $scope.modifyPorts = [];
            $scope.addedServices = [];
            $scope.disbandServices= [];
            $scope.modifyServices= [];
            $scope.channel = 'VPN';
            $scope.request_type = 'Organize';
            $scope.priority = 'Regular';
            $scope.dateCreated = undefined;

            $scope.clearArrays = function () {
                $scope.addedPorts = [];
                $scope.disbandPorts = [];
                $scope.modifyPorts = [];
                $scope.addedServices = [];
                $scope.disbandServices= [];
                $scope.modifyServices= [];
            }

            $http.get('/camunda/catalogs/api/get/id/30').then(
                function (response) {
                    $scope.oblastCatalog = response.data.data.$list;
                }
            );

            $http.get('/camunda/catalogs/api/get/id/31').then(
                function (response) {
                    $scope.districtCatalog = response.data.data.$list;
                }
            );

            $http.get('/camunda/catalogs/api/get/id/32').then(
                function (response) {
                    $scope.cityVillageCatalog = response.data.data.$list.sort(el => el.value);
                }
            );

            $http.get('/camunda/catalogs/api/get/id/83').then(
                function (response) {
                    $scope.serviceTypeCatalog = response.data.data.$list;
                }
            );

            $scope.preSubmit = function () {
                const deferred = $q.defer();
                if ($scope.request_type === 'Organize' && $scope.channel === 'Port' && $scope.addedPorts.length === 0) {
                    deferred.reject('Please add ports');
                } else if ($scope.request_type === 'Disband' && $scope.channel === 'Port' && $scope.disbandPorts.length === 0) {
                    deferred.reject('Please select ports to disband');
                } else if ($scope.request_type === 'Modify' && $scope.channel === 'Port' && $scope.modifyPorts.length === 0) {
                    deferred.reject('Please select ports to disband');
                } else if ($scope.request_type === 'Organize' && $scope.channel === 'VPN' && $scope.addedServices.length === 0) {
                    deferred.reject('Please add services');
                } else if ($scope.request_type === 'Disband' && $scope.channel === 'VPN' && $scope.disbandServices.length === 0) {
                    deferred.reject('Please select services to disband');
                } else if ($scope.request_type === 'Modify' && $scope.channel === 'VPN' && $scope.modifyServices.length === 0) {
                    deferred.reject('Please select services to modify');
                } else {
                    deferred.resolve();
                }
                return deferred.promise;
            }

            camForm.on('submit', function (e) {
                camForm.variableManager.createVariable({
                    name: 'channel',
                    type: 'String',
                    value: $scope.channel
                });
                camForm.variableManager.createVariable({
                    name: 'request_type',
                    type: 'String',
                    value: $scope.request_type
                });
                camForm.variableManager.createVariable({
                    name: 'priority',
                    type: 'String',
                    value: $scope.priority
                });

                if ($scope.request_type === 'Organize' && $scope.channel === 'Port') {
                    camForm.variableManager.createVariable({
                        name: 'addedPorts',
                        type: 'Json',
                        value: $scope.addedPorts
                    });
                } else if ($scope.request_type === 'Disband' && $scope.channel === 'Port') {
                    camForm.variableManager.createVariable({
                        name: 'disbandPorts',
                        type: 'Json',
                        value: $scope.disbandPorts
                    });
                }else if ($scope.request_type === 'Modify' && $scope.channel === 'Port') {
                    camForm.variableManager.createVariable({
                        name: 'modifyPorts',
                        type: 'Json',
                        value: $scope.modifyPorts
                    });
                } else if ($scope.request_type === 'Organize' && $scope.channel === 'VPN') {
                    camForm.variableManager.createVariable({
                        name: 'addedServices',
                        type: 'Json',
                        value: $scope.addedServices
                    });
                } else if ($scope.request_type === 'Disband' && $scope.channel === 'VPN') {
                    camForm.variableManager.createVariable({
                        name: 'disbandServices',
                        type: 'Json',
                        value: $scope.disbandServices
                    });
                } else if ($scope.request_type === 'Modify' && $scope.channel === 'VPN') {
                    camForm.variableManager.createVariable({
                        name: 'modifyServices',
                        type: 'Json',
                        value: $scope.modifyServices
                    });
                }

                $scope.businessKey = $scope.channel + '-' + new Date().getFullYear().toString().slice(-2) + '-' + Math.floor(1000 + Math.random() * 9000);
                camForm.businessKey = $scope.businessKey;
                camForm.variableManager.createVariable({
                    name: 'businessKey',
                    type: 'String',
                    value: $scope.businessKey
                });
                camForm.variableManager.createVariable({
                    name: 'dateCreated',
                    type: 'Date',
                    value: new Date().toISOString()
                });
            });
        }]);
    </script>
    <div class="form-group">
        <div class="col-sm-3 text-center">
            <label class="radio-inline">
                <input type="radio" id="channel_vpn" name="channel" value="VPN" ng-model="channel"
                       ng-change="clearArrays()" required>VPN
            </label>
            <label class="radio-inline">
                <input type="radio" id="channel_port" name="channel" value="Port" ng-model="channel"
                       ng-change="clearArrays()" required>Port
            </label>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3"><label class="control-label" for="request_type">Request Type</label></div>
        <div class="col-sm-6">
            <select class="form-control" select-picker id="request_type" name="request_type" ng-model="request_type"
                    ng-change="clearArrays()" required>
                <option value="Organize">Organize</option>
                <option value="Disband">Disband</option>
                <option value="Modify">Modify</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-3"><label class="control-label" for="priority">Priority</label></div>
        <div class="col-sm-6">
            <select class="form-control " select-picker id="priority" name="priority" ng-model="priority" required>
                <option value="Regular">Regular</option>
                <option value="Emergency">Emergency</option>
            </select>
        </div>
    </div>

    <organize-port ng-if="channel === 'Port' && request_type === 'Organize'" added-ports="addedPorts"
                   oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                   city-village-catalog="cityVillageCatalog" form="kcell_form" view="view"></organize-port>
    <disband-port ng-if="channel === 'Port' && request_type === 'Disband'" disband-ports="disbandPorts"
                  oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                  city-village-catalog="cityVillageCatalog" form="kcell_form" view="view"></disband-port>
    <modify-port ng-if="channel === 'Port' && request_type === 'Modify'" modify-ports="modifyPorts"
                 oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                 city-village-catalog="cityVillageCatalog" form="kcell_form" view="view"></modify-port>
    <organize-vpn ng-if="channel === 'VPN' && request_type === 'Organize'" added-services="addedServices"
                  oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                  city-village-catalog="cityVillageCatalog" service-type-catalog="serviceTypeCatalog"
                  form="kcell_form" view="view"></organize-vpn>
    <disband-vpn ng-if="channel === 'VPN' && request_type === 'Disband'" disband-services="disbandServices"
                 oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                 city-village-catalog="cityVillageCatalog" service-type-catalog="serviceTypeCatalog"
                 form="kcell_form" view="view"></disband-vpn>
    <modify-vpn ng-if="channel === 'VPN' && request_type === 'Modify'" modify-services="modifyServices"
                 oblast-catalog="oblastCatalog" district-catalog="districtCatalog"
                 city-village-catalog="cityVillageCatalog" service-type-catalog="serviceTypeCatalog"
                 form="kcell_form" view="view"></modify-vpn>
</form>
