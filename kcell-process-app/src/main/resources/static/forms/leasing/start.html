<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', 'Uri', '$rootScope', '$q', '$timeout', function ($scope, $http, Uri, $rootScope, $q, $timeout) {
            camForm.on('form-loaded', function () {
                var currentDate = new Date();
                $scope.finalBands = {};
                $scope.bands = [];
                $scope.dictionary = {};
                $scope.project = '';
                $scope.years = [currentDate.getFullYear(), currentDate.getFullYear()-1, currentDate.getFullYear()-2, currentDate.getFullYear()-3, currentDate.getFullYear()-4];

                $http.get('/api/leasingCatalogs?version=1').then(
                    function(result){
                        angular.extend($scope.dictionary, result.data);
                        $scope.dictionary.rbsTypes = [];
                        angular.forEach($scope.dictionary.rbsType, function (rbs) {
                            if($scope.dictionary.rbsTypes.indexOf(rbs.rbsType) < 0){
                                $scope.dictionary.rbsTypes.push(rbs.rbsType);
                            }
                        })
                        $scope.bands = $scope.dictionary.bands;
                    },
                    function(error){
                        console.log(error);
                    }
                );

                camForm.variableManager.createVariable({
                    name: 'bands',
                    value: [],
                    type: 'Json'
                });

                camForm.variableManager.createVariable({
                    name: 'regionName',
                    value: '',
                    type: 'String'
                });
            });

            camForm.on('submit', function (evt) {
                camForm.variableManager.variableValue('bands', $scope.selectedBands);
                camForm.variableManager.variableValue('regionName', $scope.regionName);
                camForm.variableManager.createVariable({
                    name: 'resolutions',
                    type: 'Json',
                    value: []
                });
                if($scope.project){
                    camForm.variableManager.createVariable({
                        name: 'project',
                        value: $scope.project,
                        type: 'String'
                    });
                }
                if($scope.reason){
                    camForm.variableManager.createVariable({
                        name: 'reason',
                        value: $scope.reason,
                        type: 'String'
                    });
                }
            });

            $scope.$watch('bands', function (bands) {
                $scope.selectedBands = [];
                bands.forEach(function(b){
                    if (b.value) {
                        $scope.selectedBands.push(b)
                    }
                })
            }, true);

            $scope.$watch('initiator', function (initiator) {
                $scope.projectsByInitiator = {};
                $scope.reasonsByProject = [];
                $scope.projectsByInitiator = _.find($scope.dictionary.projects, function (p) {
                    return p.initiator === initiator;
                })
            }, true);

            $scope.$watch('project', function (project) {
                $scope.reasonsByProject = [];
                $scope.reasonsByProject = _.filter($scope.dictionary.reasons, function (r) {
                    if (_.find(r.project, function (p) {return p === project; }) ) { return true} else return false;
                })
            }, true);

            $scope.$watch('ncpID', function (ncpID) {
                if(ncpID && ncpID.length === 5){
                    var firstElement = ncpID.charAt(0);
                    var secondElement = ncpID.charAt(0);
                    if(firstElement === '0'){
                        $scope.region = 'almaty';
                    } else if(firstElement === '1' && secondElement === '1'){
                        $scope.region = 'astana';
                    } else if(firstElement === '1' || firstElement === '2'){
                        $scope.region = 'nc';
                    } else if(firstElement === '3'){
                        $scope.region = 'east';
                    } else if(firstElement === '4'){
                        $scope.region = 'south';
                    } else if(firstElement === '5' || firstElement === '6' || firstElement === '7'  || firstElement === '8'){
                        $scope.region = 'west';
                    } else if(firstElement === '9'){
                        $scope.region = undefined;
                    }

                    if(firstElement !== '9'){
                        $scope.regionSelected($scope.region);
                    }
                }
            }, true);

            $scope.regionSelected = function(region){
                $scope.regionName = _.find($scope.dictionary.regions, function (r) {
                    return r.id === region;
                }).name;
            }

            $scope.types = function(rbsType){
                return Number(rbsType);
            }
        }]);

    </script>
    <div class="form-group">
        <h4>Create NCP</h4>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">NCP ID:</label>
        <div class="col-sm-4">
            <input class="form-control" id="ncpID" name="ncpID" required ng-model="ncpID" cam-variable-name="ncpID" cam-variable-type="String" limit-to="5" numbers-only>
            <label class="error" ng-show="kcell_form.ncpID.$error.required && ( kcell_form.ncpID.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Type:</label>
        <div class="col-sm-4">
            <select class="form-control" id="siteType" name="siteType"
                    cam-variable-name="siteType" cam-variable-type="String"
                    ng-model="siteType"
                    required>
                <option ng-repeat="type in dictionary.siteType">{{type}}</option>
            </select>
            <label class="error" ng-show="kcell_form.siteType.$error.required && ( kcell_form.siteType.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Region name:</label>
        <div class="col-sm-4">
            <select class="form-control" id="region" name="region"
                    cam-variable-name="region" cam-variable-type="String"
                    ng-model="region"
                    ng-change="regionSelected(region)"
                    required ng-disabled="!ncpID.startsWith('9')">
                <option value="{{r.id}}" ng-repeat="r in dictionary.regions" ng-selected="{{r.id == region}}">{{r.name}}</option>
            </select>
            <label class="error" ng-show="kcell_form.region.$error.required && ( kcell_form.region.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Latitude:</label>
        <div class="col-sm-4">
            <input class="form-control" id="latitude" name="latitude" required ng-model="latitude" cam-variable-name="latitude" cam-variable-type="String">
            <label class="error" ng-show="kcell_form.latitude.$error.required && ( kcell_form.latitude.$touched || view.submitted)">Required field</label>
        </div>
        <label class="col-sm-4 control-label">E.g. "N 12 34 56,7" or "N 12,345678"</label>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Longitude:</label>
        <div class="col-sm-4">
            <input class="form-control" id="longitude" name="longitude" required ng-model="longitude" cam-variable-name="longitude" cam-variable-type="String">
            <label class="error" ng-show="kcell_form.longitude.$error.required && ( kcell_form.longitude.$touched || view.submitted)">Required field</label>
        </div>
        <label class="col-sm-4 control-label">E.g. "E 12 34 56,7" or "E 12,345678"</label>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Initiator:</label>
        <div class="col-sm-4">
            <select class="form-control" id="initiator" name="initiator"
                    cam-variable-name="initiator" cam-variable-type="String"
                    ng-model="initiator"
                    required>
                <option ng-repeat="i in dictionary.initiators">{{i}}</option>
            </select>
            <label class="error" ng-show="kcell_form.initiator.$error.required && ( kcell_form.initiator.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">Project:</label>
        <div class="col-sm-4">
            <select class="form-control" id="project" name="project"
                    ng-disabled="!projectsByInitiator"
                    ng-model="project"
                    ng-required="projectsByInitiator">
                <option ng-repeat="pr in projectsByInitiator.project">{{pr}}</option>
            </select>
            <label class="error" ng-show="kcell_form.project.$error.required && ( kcell_form.project.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">Reason:</label>
        <div class="col-sm-4">
            <select class="form-control" id="reason" name="reason"
                    ng-disabled="!reasonsByProject || reasonsByProject.length == 0"
                    ng-required="reasonsByProject && reasonsByProject.length !== 0"
                    ng-model="reason"
                    required>
                <option ng-repeat="r in reasonsByProject">{{r.reason}}</option>
            </select>
            <label class="error" ng-show="kcell_form.reason.$error.required && ( kcell_form.reason.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">Part:</label>
        <div class="col-sm-4">
            <select class="form-control" id="part" name="part"
                    cam-variable-name="part" cam-variable-type="String"
                    ng-model="part"
                    required>
                <option ng-repeat="y in years">{{y}}</option>
            </select>
            <label class="error" ng-show="kcell_form.part.$error.required && ( kcell_form.part.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="control-label col-sm-4">Target Coverage</label>
        <div class="col-sm-4" style="margin-top: 5px">
            <textarea style="resize:vertical;"  class="form-control" rows="4" maxlength="500" name="targetCoverage" cam-variable-name="targetCoverage" cam-variable-type="String" ng-model="targetCoverage"></textarea>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">Planned cabinet type:</label>
        <div class="col-sm-4">
            <select class="form-control" id="plannedCabinetType" name="plannedCabinetType"
                    ng-model="plannedCabinetType"
                    cam-variable-name="plannedCabinetType" cam-variable-type="String"
                    required>
                <option value="Indoor">Indoor</option>
                <option value="Outdoor">Outdoor</option>
            </select>
            <label class="error" ng-show="kcell_form.plannedCabinetType.$error.required && ( kcell_form.plannedCabinetType.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-4 control-label">RBS type:</label>
        <div class="col-sm-4">
            <select class="form-control" id="rbsType" name="rbsType"
                    cam-variable-name="rbsType" cam-variable-type="String"
                    ng-model="rbsType" required>
                <option ng-repeat="r in dictionary.rbsTypes | orderBy: types">{{r}}</option>
            </select>
            <label class="error" ng-show="kcell_form.rbsType.$error.required && ( kcell_form.rbsType.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Bands:</label>
        <div class="col-sm-4">
            <div class="form-check col-sm-6" ng-repeat="band in bands track by $index">
                <input type="checkbox" name="bandValues" ng-model="band.value" class="form-check-input" id="{{'check' + $index}}" ng-required="!selectedBands || selectedBands.length==0">
                <label class="form-check-label" for="{{'check' + $index}}">{{ band.title }}</label>
            </div>
            <label class="error" ng-show="kcell_form.bandValues.$error.required && ( kcell_form.bandValues.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <label class="col-sm-8 control-label pull-left">Selected bands: <span ng-repeat="band in selectedBands" >{{$index == 0?' ': ' + ' }}{{band.title}}</span></label>
</form>
