<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', 'Uri', '$rootScope', '$q', '$timeout', 'SearchCurrentSelectedProcessService', 'disconnectSelectedProcessService', function ($scope, $http, Uri, $rootScope, $q, $timeout, SearchCurrentSelectedProcessService, disconnectSelectedProcessService) {
            camForm.on('form-loaded', function () {
                $scope.relatedProcessInstance = SearchCurrentSelectedProcessService();
                $scope.isDisconnectProcess = disconnectSelectedProcessService();
                $scope.baseUrl = '/camunda/api/engine/engine/default';
                $scope.variableList = [
                    'identifiers',
                    'finalIDs',
                    'previouslyBought',
                    'operatorType',
                    'connectionType',
                    'clientBIN',
                    'contractNumber',
                    'clientCompanyLatName',
                    'officialClientCompanyName',
                    'description',
                    'ipNumber',
                    'startDate',
                    'abonentTarif',
                    'amdocsBilling',
                    'orgaBilling',
                    'techSpecFIO',
                    'techSpecNumber',
                    'techSpecEmail',
                    'contractScanCopyFileName',
                    'applicationScanCopyFileName',
                    'responsibleB2BDelivery',
                    'responsibleB2BSales',
                    'channel',
                    'region',
                    'transmitNumber',
                    'coordinates',
                    'addressATS',
                    'VPNchannel',
                    'identifierType',
                    'deliveryReport',
                    'smsServiceType',
                    'MSGGWaccount',
                    'testNumber',
                    'receivingServerAddress',
                    'receivingServerLogin',
                    'receivingServerPass',
                    'addressServerMO',
                    'tarifPlane',
                    'provider'
                ];

                $http({
                    method: 'POST',
					headers:{'Accept':'application/hal+json, application/json; q=0.5'},
					data: {
							sorting:[{sortBy: "startTime",sortOrder: "desc"}],
							variables: [{"name": "relatedProcessInstanceId", "operator": "eq", "value": $scope.relatedProcessInstance.id}],
							processDefinitionKey:  'after-sales-ivr-sms'
					},
					url: $scope.baseUrl+'/history/process-instance'
				}).then(
				    function(response){
                        if (response && response.data) {
                            $scope.processInstancesAftersales = angular.copy(response.data);
                            if($scope.processInstancesAftersales.length>0){
                                $scope.allowToStart = !$scope.processInstancesAftersales.filter(function(pi){return ['EXTERNALLY_TERMINATED','INTERNALLY_TERMINATED','COMPLETED'].indexOf(pi.state) === -1}).length > 0;

                                if($scope.allowToStart) {
                                    $scope.aftersalesInstance = $scope.processInstancesAftersales.find(function(pi){
                                        if(pi.state === 'COMPLETED') {
                                            return true;
                                        }
                                    });
                                    if($scope.aftersalesInstance && $scope.aftersalesInstance.id){
                                        $scope.relatedAftersalesProcess = true;
                                        $http.get($scope.baseUrl+'/history/variable-instance?deserializeValues=false&processInstanceId='+$scope.aftersalesInstance.id).then(
                                            function(result){
                                                result.data.forEach(function(el){
                                                    if($scope.variableList.indexOf(el.name)>-1){
                                                        if(el.type === 'Json'){
                                                            $scope[el.name] = JSON.parse(el.value);
                                                        } else {
                                                            $scope[el.name] = el.value;
                                                        }
                                                    }
                                                });
                                            },
                                            function(error){
                                                console.log(error.data);
                                                $scope.allowToStart = false;
                                            }
                                        );
                                    };

                                }
                            }
                            if($scope.processInstancesAftersales.length = 0 || !$scope.aftersalesInstance) {
                                $http.get($scope.baseUrl + '/history/variable-instance?deserializeValues=false&processInstanceId='+$scope.relatedProcessInstance.id).then(
                                    function(result){
                                        var relatedProcessInstanceVariables = angular.copy(result.data);
                                        angular.forEach(relatedProcessInstanceVariables, function(el, index){
                                            try {
                                                if($scope.variableList.indexOf(el.name)>-1){
                                                    $scope[el.name] = el;
                                                    if(el.type === 'File' || el.type === 'Bytes'){
                                                        $scope[el.name].contentUrl = $scope.baseUrl+'/history/variable-instance/'+el.id+'/data';
                                                    } else if(el.type === 'Json'){
                                                        if(['contractScanCopyFileName', 'applicationScanCopyFileName', 'vpnQuestionnaireFileName'].indexOf(el.name) > -1) {
                                                            if (!$scope.files) {
                                                                $scope.files = [];
                                                            }
                                                            $scope.files.push(JSON.parse(el.value));
                                                            $scope[el.name] = JSON.parse(el.value);
                                                        } else {
                                                            $scope[el.name] = JSON.parse(el.value);
                                                        }
                                                    } else if(el.type === 'Date' && (el.value || el.value === "")) {
                                                        $scope[el.name] = new Date(el.value);
                                                    } else if(el.value || el.value === "" || el.type === 'Boolean') {
                                                        if(el.name === 'VPNchannel'){
                                                            $scope.buildVPN = (el.value === 'build' ? true : false);
                                                        } else {
                                                            $scope[el.name] = el.value;
                                                        }
                                                    }
                                                }
                                            }
                                            catch(e) {
                                                console.log(e);
                                            }
                                        });
                                        $scope.allowToStart = true;
                                    },
                                    function(error){
                                        console.log(error.data);
                                        $scope.allowToStart = false;
                                    }
                                );
                            }
                        }
                    },
                    function(error){
                        console.log(error.data);
                        $scope.allowToStart = false;
                    }
                );

                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstanceId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessBusinessKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstance',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'connectionType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'operatorType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'previouslyBought',
                    value: undefined,
                    type: 'Boolean'
                });
                camForm.variableManager.createVariable({
                    name: 'identifiers',
                    type: 'json',
                    value: ''
                });
                camForm.variableManager.createVariable({
                    name: 'finalIDs',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'disconnectProcess',
                    type: 'Boolean',
                    value: false
                });
                camForm.variableManager.createVariable({
                    name: 'startDate',
                    value: '',
                    type: 'Date'
                });
                camForm.variableManager.createVariable({
                    name: 'contractScanCopyFileName',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'applicationScanCopyFileName',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'responsibleB2BSales',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'responsibleB2BDelivery',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'clientBIN',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'contractNumber',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'clientCompanyLatName',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'officialClientCompanyName',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'description',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'ipNumber',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'abonentTarif',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'amdocsBilling',
                    value: false,
                    type: 'Boolean'
                });
                camForm.variableManager.createVariable({
                    name: 'orgaBilling',
                    value: false,
                    type: 'Boolean'
                });
                camForm.variableManager.createVariable({
                    name: 'techSpecFIO',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'techSpecNumber',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'techSpecEmail',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'channel',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'region',
                    value: '',
                    type: 'String'
                });
                if($scope.relatedProcessInstance.processDefinitionKey === 'freephone'){
                    camForm.variableManager.createVariable({
                        name: 'transmitNumber',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'coordinates',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'addressATS',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'VPNchannel',
                        value: '',
                        type: 'String'
                    });
                    // There is no identifier type in Freephone, but we use "digital" since process diagramm transition the same as in BulkSMS with "digital" Identifier Type
                    camForm.variableManager.createVariable({
                        name: 'identifierType',
                        value: '',
                        type: 'String'
                    });
                } else if($scope.relatedProcessInstance.processDefinitionKey === 'bulksmsConnectionKAE') {
                    camForm.variableManager.createVariable({
                        name: 'identifierType',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'deliveryReport',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'smsServiceType',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'MSGGWaccount',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'testNumber',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'receivingServerAddress',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'receivingServerLogin',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'receivingServerPass',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'addressServerMO',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'tarifPlane',
                        value: '',
                        type: 'String'
                    });
                    camForm.variableManager.createVariable({
                        name: 'provider',
                        value: '',
                        type: 'String'
                    });
                };
            });

            $scope.preSubmit = function() {
                var checkForActiveAfterSalesProcessInstances = function() {
                    var deferred = $q.defer();
                    return $http({
                                    method: 'POST',
									headers:{'Accept':'application/hal+json, application/json; q=0.5'},
									data: {
										variables: [{"name": "relatedProcessInstanceId", "operator": "eq", "value": $scope.relatedProcessInstance.id}],
										processDefinitionKey:  'after-sales-ivr-sms'
									},
									url: $scope.baseUrl+'/history/process-instance'
					        }).then(function(response){
					            if (response && response.data) {
									$scope.processInstancesAftersales = angular.copy(response.data);
									if($scope.processInstancesAftersales.length>0){
										var allowToStart = !$scope.processInstancesAftersales.filter(function(pi){return ['EXTERNALLY_TERMINATED','INTERNALLY_TERMINATED','COMPLETED'].indexOf(pi.state) === -1}).length > 0;
										if(allowToStart) {
										    deferred.resolve('No active Aftersales instances');
										} else {
										    deferred.reject('Can not start Aftersales due to Active Aftersales instances');
										}
									} else {
										deferred.resolve('No active Aftersales instances');
									}
								} else {
								    deferred.resolve('Empty response for active aftersales process instances');
								}
								return deferred.promise;
							},
							function(error){
								console.log(error.data);
							}
						);
                };
                return checkForActiveAfterSalesProcessInstances();
            };

            camForm.on('submit', function (evt) {
                var date = new Date();
                var businessKey = 'AFTERSALES_' + $scope.identifiers[0].title + '_' + ("0" + date.getDate().toString()).slice(-2) + ("0" + (date.getMonth() + 1)).toString().slice(-2) + date.getFullYear().toString();
                camForm.businessKey = businessKey;

                camForm.variableManager.variableValue('relatedProcessInstance', $scope.relatedProcessInstance);
                camForm.variableManager.variableValue('relatedProcessInstanceId', $scope.relatedProcessInstance.id);
                camForm.variableManager.variableValue('relatedProcessDefinitionId', $scope.relatedProcessInstance.processDefinitionId);
                camForm.variableManager.variableValue('relatedProcessDefinitionKey', $scope.relatedProcessInstance.processDefinitionKey);
                camForm.variableManager.variableValue('relatedProcessBusinessKey', $scope.relatedProcessInstance.businessKey);
                camForm.variableManager.variableValue('disconnectProcess', $scope.isDisconnectProcess);
                camForm.variableManager.variableValue('connectionType', $scope.connectionType);
                camForm.variableManager.variableValue('finalIDs', $scope.finalIDs);
                camForm.variableManager.variableValue('operatorType', $scope.operatorType);
                camForm.variableManager.variableValue('previouslyBought', $scope.previouslyBought);
                camForm.variableManager.variableValue('identifiers', $scope.identifiers);
                camForm.variableManager.variableValue('clientBIN', $scope.clientBIN);
                camForm.variableManager.variableValue('contractNumber', $scope.contractNumber);
                camForm.variableManager.variableValue('clientCompanyLatName', $scope.clientCompanyLatName);
                camForm.variableManager.variableValue('officialClientCompanyName', $scope.officialClientCompanyName);
                camForm.variableManager.variableValue('description', $scope.description);
                camForm.variableManager.variableValue('ipNumber', $scope.ipNumber);
                camForm.variableManager.variableValue('startDate', $scope.startDate instanceof Date ? $scope.startDate : new Date($scope.startDate));
                camForm.variableManager.variableValue('abonentTarif', $scope.abonentTarif);
                camForm.variableManager.variableValue('amdocsBilling', $scope.amdocsBilling);
                camForm.variableManager.variableValue('orgaBilling', $scope.orgaBilling);
                camForm.variableManager.variableValue('techSpecFIO', $scope.techSpecFIO);
                camForm.variableManager.variableValue('techSpecNumber', $scope.techSpecNumber);
                camForm.variableManager.variableValue('techSpecEmail', $scope.techSpecEmail);
                camForm.variableManager.variableValue('contractScanCopyFileName', $scope.contractScanCopyFileName);
                camForm.variableManager.variableValue('applicationScanCopyFileName', $scope.applicationScanCopyFileName);
                camForm.variableManager.variableValue('responsibleB2BDelivery', $scope.responsibleB2BDelivery);
                camForm.variableManager.variableValue('responsibleB2BSales', $scope.responsibleB2BSales);
                camForm.variableManager.variableValue('channel', $scope.channel);
                camForm.variableManager.variableValue('region', $scope.region);

                if($scope.relatedProcessInstance.processDefinitionKey === 'freephone'){
                    camForm.variableManager.variableValue('transmitNumber', $scope.transmitNumber);
                    camForm.variableManager.variableValue('coordinates', $scope.coordinates);
                    camForm.variableManager.variableValue('addressATS', $scope.addressATS);
                    camForm.variableManager.variableValue('VPNchannel', $scope.buildVPN?'build':'not-build');
                    // For freephone there is no identifier type, USE "digital" just to have the same logic as in BulkSMS
                    camForm.variableManager.variableValue('identifierType', 'digital');
                } else if($scope.relatedProcessInstance.processDefinitionKey === 'bulksmsConnectionKAE') {
                    camForm.variableManager.variableValue('identifierType', $scope.identifierType);
                    if($scope.deliveryReport){
                        camForm.variableManager.variableValue('deliveryReport', $scope.deliveryReport);
                    }
                    camForm.variableManager.variableValue('smsServiceType', $scope.smsServiceType);
                    camForm.variableManager.variableValue('MSGGWaccount', $scope.MSGGWaccount);
                    camForm.variableManager.variableValue('testNumber', $scope.testNumber);
                    camForm.variableManager.variableValue('receivingServerAddress', $scope.receivingServerAddress);
                    camForm.variableManager.variableValue('receivingServerLogin', $scope.receivingServerLogin);
                    camForm.variableManager.variableValue('receivingServerPass', $scope.receivingServerPass);
                    camForm.variableManager.variableValue('addressServerMO', $scope.addressServerMO);
                    camForm.variableManager.variableValue('tarifPlane', $scope.tarifPlane);
                    camForm.variableManager.variableValue('provider', $scope.provider);
                };
            });
        }]);

    </script>
    <div>
        <div ng-show="isDisconnectProcess">
            <p>Start Disconnection Process</p>
        </div>
        <div class="row" ng-show="!isDisconnectProcess">
            <div class="col-md-7">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="officialClientCompanyName" name="officialClientCompanyName" cam-variable-name="changeOfficialClientCompanyName" cam-variable-type="Boolean">
                        <label class="form-check-label" for="officialClientCompanyName">Изменение Юридического наименования компании</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="contractNumber" name="contractNumber" cam-variable-name="changeContractNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="contractNumber">Изменение номера договора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="disconnectOperator" name="disconnectOperator" cam-variable-name="disconnectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="disconnectOperator">Отключение оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectOperator" name="connectOperator" cam-variable-name="connectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectOperator">Добавление оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectionType" name="connectionType" cam-variable-name="changeConnectionType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectionType">Изменение типа подключения</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="ipNumber" name="ipNumber" cam-variable-name="changeIpNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="ipNumber">Добавление/Изменение IP адреса</label>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="identifier" name="identifier" cam-variable-name="changeIdentifier" cam-variable-type="Boolean">
                        <label class="form-check-label" for="identifier">Изменение заголовка</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'bulksmsConnectionKAE'">
                        <input type="checkbox" class="form-check-input" id="smsServiceType" name="smsServiceType" cam-variable-name="changeSmsServiceType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="smsServiceType">Подключение МО</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="provider" name="provider" cam-variable-name="changeProvider" cam-variable-type="Boolean">
                        <label class="form-check-label" for="provider">Смена провайдера</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'freephone'">
                        <input type="checkbox" class="form-check-input" id="transmitNumber" name="transmitNumber" cam-variable-name="changeTransmitNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="transmitNumber">Смена номера переадресации</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
