<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', 'Uri', '$rootScope', '$q', '$timeout', 'SearchCurrentSelectedProcessService', function ($scope, $http, Uri, $rootScope, $q, $timeout, SearchCurrentSelectedProcessService) {
            camForm.on('form-loaded', function () {
                $scope.relatedProcessInstance = SearchCurrentSelectedProcessService();
                console.log('$scope', $scope);

                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstanceId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessBusinessKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstance',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstanceVariables',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'connectionType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'operatorType',
                    value: '',
                    type: 'String'
                });
            });

            $scope.preSubmit = function() {
                var baseUrl = '/camunda/api/engine/engine/default';
                var deferred = $q.defer();
                $scope.relatedProcessInstanceVariables = {};
                console.log('preSubmit');
				return $http.get(baseUrl + '/history/variable-instance?deserializeValues=false&processInstanceId='+$scope.relatedProcessInstance.id).then(
				    function(result){
				        result.data.forEach(function(el){
				            $scope.relatedProcessInstanceVariables[el.name] = el;
							if(el.type !== 'Json' && (el.value || el.value === "" || el.type === 'Boolean')) {
					        	$scope.relatedProcessInstanceVariables[el.name] = el.value;
					        }
					        if(el.type === 'File' || el.type === 'Bytes'){
								$scope.relatedProcessInstanceVariables[el.name].contentUrl = baseUrl+'/history/variable-instance/'+el.id+'/data';
							}
							if(el.type === 'Json'){
								if(el.name === 'resolutions'){
									$scope.relatedProcessInstanceVariables[el.name].value = JSON.parse(el.value);
								} else if(['contractScanCopyFileName', 'applicationScanCopyFileName', 'vpnQuestionnaireFileName'].indexOf(el.name) > -1) {
									if (!$scope.relatedProcessInstanceVariables.files) {
										$scope.relatedProcessInstanceVariables.files = [];
									}
									$scope.relatedProcessInstanceVariables.files.push(JSON.parse(el.value));
								} else {
									$scope.relatedProcessInstanceVariables[el.name] = JSON.parse(el.value);
								}
							}
						});

						//$scope.relatedProcessInstanceVariables.showTarif = true;

						console.log('relatedProcessInstanceVariables', $scope.relatedProcessInstanceVariables);
						deferred.resolve('fetched vars');
						return deferred.promise;
					},
					function(error){
						console.log(error.data);
						deferred.reject(error.data);
						return deferred.promise;
					}
				);
            };

            camForm.on('submit', function (evt) {
                console.log('Submit');
                // evt.submitPrevented = true;
                var date = new Date();
                var businessKey = 'AFTERSALES_' + $scope.relatedProcessInstanceVariables.identifiers[0].title + '_' + ("0" + date.getDate().toString()).slice(-2) + ("0" + (date.getMonth() + 1)).toString().slice(-2) + date.getFullYear().toString();
                camForm.businessKey = businessKey;

                camForm.variableManager.variableValue('relatedProcessInstance', $scope.relatedProcessInstance);
                camForm.variableManager.variableValue('relatedProcessInstanceId', $scope.relatedProcessInstance.id);
                camForm.variableManager.variableValue('relatedProcessDefinitionId', $scope.relatedProcessInstance.processDefinitionId);
                camForm.variableManager.variableValue('relatedProcessDefinitionKey', $scope.relatedProcessInstance.processDefinitionKey);
                camForm.variableManager.variableValue('relatedProcessBusinessKey', $scope.relatedProcessInstance.businessKey);
                camForm.variableManager.variableValue('relatedProcessInstanceVariables', $scope.relatedProcessInstanceVariables);
                camForm.variableManager.variableValue('connectionType', $scope.relatedProcessInstanceVariables.connectionType);
                camForm.variableManager.variableValue('operatorType', $scope.relatedProcessInstanceVariables.operatorType);

            });
        }]);

    </script>
    <div>
        <!--button ng-click="preSubmit()">PRE SUBMIT</button-->
        <div class="row">
            <div class="col-md-7">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="officialClientCompanyName" name="officialClientCompanyName" cam-variable-name="changeOfficialClientCompanyName" cam-variable-type="Boolean">
                        <label class="form-check-label" for="officialClientCompanyName">Изменение Юридического наименования компании</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="contractNumber" name="contractNumber" cam-variable-name="changeContractNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="contractNumber">Изменение номера договора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="disconnectOperator" name="disconnectOperator" cam-variable-name="disconnectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="disconnectOperator">Отключение оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectOperator" name="connectOperator" cam-variable-name="connectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectOperator">Добавление оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectionType" name="connectionType" cam-variable-name="changeConnectionType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectionType">Изменение типа подключения</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="ipNumber" name="ipNumber" cam-variable-name="changeIpNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="ipNumber">Добавление/Изменение IP адреса</label>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="identifier" name="identifier" cam-variable-name="changeIdentifier" cam-variable-type="Boolean">
                        <label class="form-check-label" for="identifier">Изменение заголовка</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'bulksmsConnectionKAE'">
                        <input type="checkbox" class="form-check-input" id="smsServiceType" name="smsServiceType" cam-variable-name="changeSmsServiceType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="smsServiceType">Подключение МО</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="provider" name="provider" cam-variable-name="changeProvider" cam-variable-type="Boolean">
                        <label class="form-check-label" for="provider">Смена провайдера</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'freephone'">
                        <input type="checkbox" class="form-check-input" id="transmitNumber" name="transmitNumber" cam-variable-name="changeTransmitNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="transmitNumber">Смена номера переадресации</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
