<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', 'Uri', '$rootScope', '$q', '$timeout', 'SearchCurrentSelectedProcessService', 'disconnectSelectedProcessService', function ($scope, $http, Uri, $rootScope, $q, $timeout, SearchCurrentSelectedProcessService, disconnectSelectedProcessService) {
            camForm.on('form-loaded', function () {
                $scope.relatedProcessInstance = SearchCurrentSelectedProcessService();
                $scope.isDisconnectProcess = disconnectSelectedProcessService();
                $scope.baseUrl = '/camunda/api/engine/engine/default';
                $scope.variableList = ['relatedProcessInstanceId','relatedProcessDefinitionId','relatedProcessDefinitionKey','relatedProcessBusinessKey','relatedProcessInstance','relatedProcessInstanceVariables','connectionType','operatorType','identifierType','previouslyBought','identifiers'];

                $http({
                    method: 'POST',
					headers:{'Accept':'application/hal+json, application/json; q=0.5'},
					data: {
							sorting:[{sortBy: "startTime",sortOrder: "desc"}],
							variables: [{"name": "relatedProcessInstanceId", "operator": "eq", "value": $scope.relatedProcessInstance.id}],
							processDefinitionKey:  'after-sales-ivr-sms'
					},
					url: $scope.baseUrl+'/history/process-instance'
				}).then(
				    function(response){
                        if (response && response.data) {
                            $scope.processInstancesAftersales = angular.copy(response.data);
                            if($scope.processInstancesAftersales.length>0){
                                $scope.allowToStart = !$scope.processInstancesAftersales.filter(function(pi){return ['EXTERNALLY_TERMINATED','COMPLETED'].indexOf(pi.state) === -1}).length > 0;

                                if($scope.allowToStart) {
                                    $scope.aftersalesInstance = $scope.processInstancesAftersales.find(function(pi){
                                        if(pi.state === 'COMPLETED') {
                                            return true;
                                        }
                                    });
                                    if($scope.aftersalesInstance && $scope.aftersalesInstance.id){
                                        $scope.relatedAftersalesProcess = true;
                                        $http.get($scope.baseUrl+'/history/variable-instance?deserializeValues=false&processInstanceId='+$scope.aftersalesInstance.id).then(
                                            function(result){
                                                result.data.forEach(function(el){
                                                    if(variableList.indexOf(el.name)>-1){
                                                        if(el.type === 'Json'){
                                                            $scope[el.name] = JSON.parse(el.value);
                                                        } else {
                                                            $scope[el.name] = el.value;
                                                        }
                                                    }
                                                });
                                            },
                                            function(error){
                                                console.log(error.data);
                                                $scope.allowToStart = false;
                                            }
                                        );
                                    };

                                }
                            }
                            if($scope.processInstancesAftersales.length = 0 || !$scope.aftersalesInstance) {
                                $http.get($scope.baseUrl + '/history/variable-instance?deserializeValues=false&processInstanceId='+$scope.relatedProcessInstance.id).then(
                                    function(result){
                                        $scope.relatedProcessInstanceVariables = {};
                                        var relatedPiVarsResponse = angular.copy(result.data);
                                        angular.forEach(relatedPiVarsResponse, function(el, index){
                                            try {
                                                $scope.relatedProcessInstanceVariables[el.name] = el;
                                                if(el.type !== 'Json' && (el.value || el.value === "" || el.type === 'Boolean')) {
                                                    $scope.relatedProcessInstanceVariables[el.name] = el.value;
                                                }
                                                if(el.type === 'File' || el.type === 'Bytes'){
                                                    $scope.relatedProcessInstanceVariables[el.name].contentUrl = $scope.baseUrl+'/history/variable-instance/'+el.id+'/data';
                                                }
                                                if(el.type === 'Json'){
                                                    if(el.name === 'resolutions'){
                                                        $scope.relatedProcessInstanceVariables[el.name].value = JSON.parse(el.value);
                                                    } else if(['contractScanCopyFileName', 'applicationScanCopyFileName', 'vpnQuestionnaireFileName'].indexOf(el.name) > -1) {
                                                        if (!$scope.relatedProcessInstanceVariables.files) {
                                                            $scope.relatedProcessInstanceVariables.files = [];
                                                        }
                                                        $scope.relatedProcessInstanceVariables.files.push(JSON.parse(el.value));
                                                    } else {
                                                        $scope.relatedProcessInstanceVariables[el.name] = JSON.parse(el.value);
                                                    }
                                                }
                                            }
                                            catch(e) {
                                                console.log(e);
                                            }
                                        });
                                        $scope.allowToStart = true;
                                        console.log('relatedProcessInstanceVariables', $scope.relatedProcessInstanceVariables);
                                    },
                                    function(error){
                                        console.log(error.data);
                                        $scope.allowToStart = false;
                                    }
                                );
                            }
                        }
                    },
                    function(error){
                        console.log(error.data);
                        $scope.allowToStart = false;
                    }
                );

                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstanceId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionId',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessDefinitionKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessBusinessKey',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstance',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'relatedProcessInstanceVariables',
                    value: undefined,
                    type: 'Json'
                });
                camForm.variableManager.createVariable({
                    name: 'connectionType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'operatorType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'identifierType',
                    value: '',
                    type: 'String'
                });
                camForm.variableManager.createVariable({
                    name: 'previouslyBought',
                    value: undefined,
                    type: 'Boolean'
                });
                camForm.variableManager.createVariable({
                    name: 'identifiers',
                    type: 'json',
                    value: ''
                });
                camForm.variableManager.createVariable({
                    name: 'disconnectProcess',
                    type: 'Boolean',
                    value: false
                });
            });

            $scope.preSubmit = function() {
                var checkForActiveAfterSalesProcessInstances = function() {
                    var deferred = $q.defer();
                    return $http({
                                    method: 'POST',
									headers:{'Accept':'application/hal+json, application/json; q=0.5'},
									data: {
										variables: [{"name": "relatedProcessInstanceId", "operator": "eq", "value": $scope.relatedProcessInstance.id}],
										processDefinitionKey:  'after-sales-ivr-sms'
									},
									url: $scope.baseUrl+'/history/process-instance'
					        }).then(function(response){
					            if (response && response.data) {
									$scope.processInstancesAftersales = angular.copy(response.data);
									if($scope.processInstancesAftersales.length>0){
										var allowToStart = !$scope.processInstancesAftersales.filter(function(pi){return ['EXTERNALLY_TERMINATED','COMPLETED'].indexOf(pi.state) === -1}).length > 0;
										if(allowToStart) {
										    deferred.resolve('No active Aftersales instances');
										} else {
										    deferred.reject('Can not start Aftersales due to Active Aftersales instances');
										}
									} else {
										deferred.resolve('No active Aftersales instances');
									}
								} else {
								    deferred.resolve('Empty response for active aftersales process instances');
								}
								return deferred.promise;
							},
							function(error){
								console.log(error.data);
							}
						);
                };
                return checkForActiveAfterSalesProcessInstances();
            };

            camForm.on('submit', function (evt) {
                var date = new Date();
                var businessKey = 'AFTERSALES_' + $scope.relatedProcessInstanceVariables.identifiers[0].title + '_' + ("0" + date.getDate().toString()).slice(-2) + ("0" + (date.getMonth() + 1)).toString().slice(-2) + date.getFullYear().toString();
                camForm.businessKey = businessKey;

                camForm.variableManager.variableValue('relatedProcessInstance', $scope.relatedProcessInstance);
                camForm.variableManager.variableValue('relatedProcessInstanceId', $scope.relatedProcessInstance.id);
                camForm.variableManager.variableValue('relatedProcessDefinitionId', $scope.relatedProcessInstance.processDefinitionId);
                camForm.variableManager.variableValue('relatedProcessDefinitionKey', $scope.relatedProcessInstance.processDefinitionKey);
                camForm.variableManager.variableValue('relatedProcessBusinessKey', $scope.relatedProcessInstance.businessKey);
                camForm.variableManager.variableValue('relatedProcessInstanceVariables', $scope.relatedProcessInstanceVariables);
                camForm.variableManager.variableValue('disconnectProcess', $scope.isDisconnectProcess);

                if($scope.relatedAftersalesProcess){
                    camForm.variableManager.variableValue('connectionType', $scope.connectionType);
                    camForm.variableManager.variableValue('operatorType', $scope.operatorType);
                    camForm.variableManager.variableValue('identifierType', $scope.identifierType);
                    camForm.variableManager.variableValue('previouslyBought', $scope.previouslyBought);
                    camForm.variableManager.variableValue('identifiers', $scope.identifiers);
                } else {
                    camForm.variableManager.variableValue('connectionType', $scope.relatedProcessInstanceVariables.connectionType);
                    camForm.variableManager.variableValue('operatorType', $scope.relatedProcessInstanceVariables.operatorType);
                    camForm.variableManager.variableValue('identifierType', $scope.relatedProcessInstanceVariables.identifierType);
                    camForm.variableManager.variableValue('previouslyBought', $scope.relatedProcessInstanceVariables.previouslyBought);
                    camForm.variableManager.variableValue('identifiers', $scope.relatedProcessInstanceVariables.identifiers);
                }
            });
        }]);

    </script>
    <div>
        <!--button ng-click="preSubmit()">PRE SUBMIT</button-->
        <div ng-show="isDisconnectProcess">
            <p>Start Disconnection Process</p>
        </div>
        <div class="row" ng-show="!isDisconnectProcess">
            <div class="col-md-7">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="officialClientCompanyName" name="officialClientCompanyName" cam-variable-name="changeOfficialClientCompanyName" cam-variable-type="Boolean">
                        <label class="form-check-label" for="officialClientCompanyName">Изменение Юридического наименования компании</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="contractNumber" name="contractNumber" cam-variable-name="changeContractNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="contractNumber">Изменение номера договора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="disconnectOperator" name="disconnectOperator" cam-variable-name="disconnectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="disconnectOperator">Отключение оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectOperator" name="connectOperator" cam-variable-name="connectOperator" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectOperator">Добавление оператора</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="connectionType" name="connectionType" cam-variable-name="changeConnectionType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="connectionType">Изменение типа подключения</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="ipNumber" name="ipNumber" cam-variable-name="changeIpNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="ipNumber">Добавление/Изменение IP адреса</label>
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-check">
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="identifier" name="identifier" cam-variable-name="changeIdentifier" cam-variable-type="Boolean">
                        <label class="form-check-label" for="identifier">Изменение заголовка</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'bulksmsConnectionKAE'">
                        <input type="checkbox" class="form-check-input" id="smsServiceType" name="smsServiceType" cam-variable-name="changeSmsServiceType" cam-variable-type="Boolean">
                        <label class="form-check-label" for="smsServiceType">Подключение МО</label>
                    </div>
                    <div class="col-sm-12">
                        <input type="checkbox" class="form-check-input" id="provider" name="provider" cam-variable-name="changeProvider" cam-variable-type="Boolean">
                        <label class="form-check-label" for="provider">Смена провайдера</label>
                    </div>
                    <div class="col-sm-12" ng-show="relatedProcessInstance.processDefinitionKey === 'freephone'">
                        <input type="checkbox" class="form-check-input" id="transmitNumber" name="transmitNumber" cam-variable-name="changeTransmitNumber" cam-variable-type="Boolean">
                        <label class="form-check-label" for="transmitNumber">Смена номера переадресации</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
