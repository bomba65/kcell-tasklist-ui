<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', 'Uri', '$rootScope', '$q', 'Upload', '$timeout', function ($scope, $http, Uri, $rootScope, $q, Upload, $timeout) {
            var variables = [
                'siteInformation',
                'alternativePlaces',
                'siteRegion',
                'sdrCreationDate',
                'validityDate',
                'siteName',
                'site',
                'site_name',
                'gsmAntennaTypes',
                'coverageAreaFile',
                'transmissionAntennaType',
                'project',
                'band',
                'rbsLocation',
                'otherRbsLocation',
                'contractType',
                'rbsType',
                'requestType',
                'soaComplaintId',
                'dismantlingInitiator',
                'otherInitiator',
                'priority',
                'contractId',
                'rbsQuantity',
                'legallyName',
                'squareMeter',
                'contactInformation',
                'address',
                'dismantlingReason',
                'startComment',
                'resolutions',
                'sdrNumber'
            ];

            $scope.catalogs = {};
            $scope.regions = [
                {id: 'alm', name: 'Almaty', value: 'Alm'},
                {id: 'astana', name: 'Astana', value: 'Astana'},
                {id: 'nc', name: 'North and Center', value: 'N\&C'},
                {id: 'east', name: 'East', value: 'East'},
                {id: 'south', name: 'South', value: 'South'},
                {id: 'west', name: 'West', value: 'West'}
            ]
            $scope.regionsMap = {
                '0': 'Alm',
                '11':'Astana',
                '1': 'N&C',
                '2': 'N&C',
                '3': 'East',
                '4': 'South',
                '5': 'West',
                '6': 'West',
                '7': 'West',
                '8': 'West'
            };
            $scope.regionsMapLC = {
                '0': 'alm',
                '11':'astana',
                '1': 'nc',
                '2': 'nc',
                '3': 'east',
                '4': 'south',
                '5': 'west',
                '6': 'west',
                '7': 'west',
                '8': 'west'
            };

            camForm.on('form-loaded', function () {
                variables.forEach(function (el) {
                    camForm.variableManager.fetchVariable(el);
                });
                $http.get($rootScope.getCatalogsHttpByName('dismantleCatalogs')).then(
                        function(result){
                            angular.extend($scope.catalogs, result.data);
                        },
                        function(error){
                            console.log(error.data);
                        }
                );
                $http.get('/camunda/api/engine/engine/default/task/' + camForm.taskId).then(
                        function(result){
                            $scope.processInstanceId = result.data.processInstanceId;
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );
                $scope.dismantleInfo = [];
            });

            camForm.on('variables-fetched', function () {
                variables.forEach(function (el) {
                    if(camForm.variableManager.variables[el].value){
                        if(camForm.variableManager.variables[el].type === 'Date'){
                            $scope[el] = new Date(camForm.variableManager.variables[el].value);
                            $scope.dismantleInfo[el] = new Date(camForm.variableManager.variables[el].value);
                        } else {
                            $scope[el] = camForm.variableManager.variables[el].value;
                            $scope.dismantleInfo[el] = camForm.variableManager.variables[el].value;
                        }
                    }
                });
                camForm.variableManager.createVariable({
                    name: 'region_modifyTaskResult',
                    type: 'String',
                    value: ''
                });

                camForm.variableManager.createVariable({
                    name: 'region_modifyTaskComment',
                    type: 'String',
                    value: ''
                });

                $scope.region_modifyTaskResult = '';
                $scope.region_modifyTaskComment = '';

                console.log(camForm.variableManager);
            });

            camForm.on('submit', function () {
                camForm.variableManager.variableValue('region_modifyTaskComment', $scope.region_modifyTaskComment);
                camForm.variableManager.variableValue('validityDate', $scope.validityDate);
                camForm.variableManager.variableValue('dismantlingInitiator', $scope.dismantlingInitiator);
                camForm.variableManager.variableValue('priority', $scope.priority);
                camForm.variableManager.variableValue('siteInformation', $scope.siteInformation);
                camForm.variableManager.variableValue('gsmAntennaTypes', $scope.gsmAntennaTypes);
                camForm.variableManager.variableValue('band', $scope.band);
                camForm.variableManager.variableValue('contractId', $scope.contractId);
                camForm.variableManager.variableValue('transmissionAntennaType', $scope.transmissionAntennaType);
                camForm.variableManager.variableValue('rbsLocation', $scope.rbsLocation);
                camForm.variableManager.variableValue('contractType', $scope.contractType);
                camForm.variableManager.variableValue('rbsQuantity', $scope.rbsQuantity);
                camForm.variableManager.variableValue('otherRbsLocation', $scope.otherRbsLocation);
                camForm.variableManager.variableValue('legallyName', $scope.legallyName);
                camForm.variableManager.variableValue('rbsType', $scope.rbsType);
                camForm.variableManager.variableValue('squareMeter', $scope.squareMeter);
                camForm.variableManager.variableValue('contactInformation', $scope.contactInformation);
                camForm.variableManager.variableValue('address', $scope.address);
                camForm.variableManager.variableValue('coverageAreaFile', $scope.coverageAreaFile);
                camForm.variableManager.variableValue('dismantlingReason', $scope.dismantlingReason);

                if(!camForm.variableManager.variables['project'].type){
                    camForm.variableManager.variables['project'].type = 'String';
                }
                camForm.variableManager.variableValue('project', $scope.project);

                if(!camForm.variableManager.variables['soaComplaintId'].type){
                    camForm.variableManager.variables['soaComplaintId'].type = 'String';
                }
                camForm.variableManager.variableValue('soaComplaintId', $scope.soaComplaintId);

                if($scope.dismantlingInitiator === 'other'){
                    if(!camForm.variableManager.variables['otherInitiator'].type){
                        camForm.variableManager.variables['otherInitiator'].type = 'String';
                    }
                    camForm.variableManager.variableValue('otherInitiator', $scope.otherInitiator);
                }
                var alternativePlaces = [];
                angular.forEach($scope.alternativePlaces, function(ap){
                    if(ap && ap!==''){
                        alternativePlaces.push(ap);
                    }
                });
                $scope.alternativePlaces = alternativePlaces;
                camForm.variableManager.variableValue('alternativePlaces', $scope.alternativePlaces);
                camForm.variableManager.destroyVariable('resolutions');
            });

            $scope.addAlternativePlace = function() {
                $scope.alternativePlaces.push("");
            };

            $scope.fileSelected = function(el, fileName){
                if(el.files[0]){
                    $timeout(function () {
                        $scope.$apply(function () {
                            uploadFileToMinio(el.files[0], fileName);
                        });
                    })
                } else {
                    $scope.$apply(function(){
                        $scope[fileName] = undefined;
                    });
                }
            };

            function uploadFileToMinio(file, fileName) {
                var fileToUpload = {
                    name: file.name.replace(/[/\\?%*:|"<>]/g, '-'),
                    isNew : true,
                    path: $scope.processInstanceId + '/' + camForm.taskId + '/' + file.name.replace(/[/\\?%*:|"<>]/g, '-')
                };
                $http({method: 'GET', url: '/camunda/uploads/put/' + fileToUpload.path, transformResponse: [] }).
                then(function(response) {
                    $http.put(response.data, file, {headers: {'Content-Type': undefined}}).then(
                            function () {
                                $scope[fileName] = fileToUpload;
                                angular.element(document.querySelector('#'+fileName)).val(null);
                            },
                            function (error) {
                                console.log(error.data);
                            }
                    );
                }, function(error){
                    console.log(error.data);
                });
            }

            $scope.clearFile = function(filename){
                delete $scope[filename];
            };

            $scope.getGsmAntennaType = function(val) {
                var result = [];
                angular.forEach($scope.catalogs.gsmAntennaTypes, function (gat) {
                    if(gat.toUpperCase().indexOf(val.toUpperCase()) >= 0 && $scope.gsmAntennaTypes.indexOf(gat)===-1){
                        result.push(gat);
                    }
                });
                return result;
            };

            $scope.gsmAntennaSelected = function($item){
                $scope.gsmAntennaTypes.push($item);
            }

            $scope.removeGsmAntennaType = function(index){
                $scope.gsmAntennaTypes.splice(index,1);
            }

            $scope.download = function(file) {
                $http({method: 'GET', url: '/camunda/uploads/get/' + file.path, transformResponse: [] }).
                then(function(response) {
                    document.getElementById('fileDownloadIframe').src = response.data;
                }, function(error){
                    console.log(error.data);
                });
            };
        }]);
    </script>

    <iframe id="fileDownloadIframe" style="display:none;"></iframe>

    <div class="form-group">
        <div class="col-sm-3">
            <label>Site Dismantling Request number:</label>
        </div>
        <div class="col-sm-3">
            <span>{{sdrNumber}}</span>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">SDR Creation date:</label>
        <div class="col-sm-3">
            <input type="text" ng-model="sdrCreationDate" name="sdrCreationDate" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="sdrCreationDateFiledOpened" id="sdrCreationDate" disabled="disabled" />
        </div>

        <label class="col-sm-2 control-label">SA&O Complaint Id:</label>
        <div class="col-sm-3">
            <input type="text" name="soaComplaintId" ng-model="soaComplaintId" class="form-control" ng-blur="checkSOAComplaintId()" maxlength="20"/>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Validity date:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="validityDate" name="validityDate" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="validityDateFiledOpened" id="validityDate" min-date="datepickerOptions.minDate" required />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="validityDateFiledOpened = true">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
            <label class="error" ng-if="kcell_form.validityDate.$error.required && ( kcell_form.validityDate.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Initiator of dismantling:</label>
        <div class="col-sm-3">
            <select ng-model="dismantlingInitiator" name="dismantlingInitiator" class="form-control selectpicker" select-picker title="" required>
                <option value="">select initiator</option>
                <option value="planningUnit">Planning unit</option>
                <option value="siteAcquisionUnit">Site Acquisition unit</option>
                <option value="implementationUnit">Implementation Unit</option>
                <option value="other">Other</option>
            </select>
            <label class="error" ng-if="kcell_form.dismantlingInitiator.$error.required && ( kcell_form.dismantlingInitiator.$touched || view.submitted)">Required field</label>
        </div>
        <div class="col-sm-2">
            <input type="text" name="otherInitiator" ng-model="otherInitiator" class="form-control" ng-if="dismantlingInitiator == 'other'" placeholder = 'Other' required/>
            <label class="error" ng-if="kcell_form.otherInitiator.$error.required && ( kcell_form.otherInitiator.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Site:</label>
        <label class="col-sm-3 control-label">{{site_name}}</label>

        <label class="col-sm-2 control-label">Type of Project:</label>
        <div class="col-sm-3">
            <select class="form-control" id="project" name="project" ng-model="project" ng-options="pr as pr for pr in catalogs.projects">
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Priority:</label>
        <div class="col-sm-3">
            <select ng-model="priority" name="priority" class="form-control selectpicker" select-picker title="" required>
                <option value="">select priority</option>
                <option value="regular">Regular</option>
                <option value="critical">Critical</option>
            </select>
            <label class="error" ng-if="kcell_form.priority.$error.required && ( kcell_form.priority.$touched || view.submitted)">Required field</label>
        </div>
        <div class="form-group" ng-if="siteName.startsWith('9')">
            <label class="col-sm-2 control-label">Site region:</label>
            <label class="col-sm-3 control-label">{{siteRegion}}</label>
        </div>
    </div>

    <H4 style="margin-top: 30px;">Alternative places for setting of site</H4>
    <div class="form-group">
        <label class="col-sm-2 control-label">Alternative {{alternativePlaces.length}}: </label>
        <div class="col-sm-10">
            <div ng-repeat="i in alternativePlaces track by $index" style="float: left; margin-right: 20px;">
                <input type="text" name="alternativePlaces{{$index}}" ng-model="alternativePlaces[$index]" class="form-control" style="width: 200px;" ng-required="alternativePlaces[0].length == 0" />
            </div>
            <a ng-click="addAlternativePlace()" style="float: left;"><i class="glyphicon glyphicon-plus-sign"></i></a>
            <label class="error" ng-if="alternativePlaces[0].length == 0 && kcell_form.alternativePlaces0.$error.required && ( kcell_form.alternativePlaces0.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <H4 style="margin-top: 30px;">Site Information</H4>

    <div class="form-group">
        <label class="col-sm-2 control-label">
            Traffic: <br />
            (average monthly)
        </label>
        <div class="col-sm-10">
            <table class="table table-bordered">
                <tbody>
                <tr ng-repeat="siteInfo in siteInformation">
                    <td>{{siteInfo.name}}</td>
                    <td>{{siteInfo.gsmLabel}}</td>
                    <td>
                        <input type="number" ng-model="siteInfo.gsmValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                    </td>
                    <td>{{siteInfo.umtsLabel}}</td>
                    <td>
                        <input type="number" ng-model="siteInfo.umtsValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                    </td>
                    <td>{{siteInfo.lteLabel}}</td>
                    <td>
                        <input type="number" ng-model="siteInfo.lteValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">GSM Antenna type:</label>
        <div class="col-sm-2">
            <span ng-repeat="gt in gsmAntennaTypes" class="my-tag">{{gt}} <a ng-click="removeGsmAntennaType($index)">&times;</a></span>
            <input type="text" ng-model="tempAntennaType" name="tempAntennaType" typeahead="result as result for result in getGsmAntennaType($viewValue)" typeahead-on-select="gsmAntennaSelected($item); tempAntennaType = undefined" class="form-control" autocomplete="off" placeholder="Add Gsm Antenna" ng-required="gsmAntennaTypes.length == 0">
            <label class="error" ng-if="kcell_form.tempAntennaType.$error.required && ( kcell_form.tempAntennaType.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Band:</label>
        <div class="col-sm-2">
            <select class="form-control" id="band" name="band" ng-model="band" ng-options="b as b for b in catalogs.bands" required></select>
            <label class="error" ng-if="kcell_form.band.$error.required && ( kcell_form.band.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Contract ID:</label>
        <div class="col-sm-2">
            <input type="text" name="contractId" ng-model="contractId" class="form-control" required/>
            <label class="error" ng-if="kcell_form.contractId.$error.required && ( kcell_form.contractId.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Transmission Antenna type:</label>
        <div class="col-sm-2">
            <select class="form-control" id="transmissionAntennaType" name="transmissionAntennaType" ng-model="transmissionAntennaType" ng-options="ta as ta for ta in catalogs.transmissionAntennaTypes" required>
            </select>
            <label class="error" ng-if="kcell_form.transmissionAntennaType.$error.required && ( kcell_form.transmissionAntennaType.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">RBS location:</label>
        <div class="col-sm-2">
            <select class="form-control" id="rbsLocation" name="rbsLocation" ng-model="rbsLocation" ng-options="r as r for r in catalogs.rbsLocations" required>
            </select>
            <label class="error" ng-if="kcell_form.rbsLocation.$error.required && ( kcell_form.rbsLocation.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Contract type:</label>
        <div class="col-sm-2">
            <select ng-model="contractType" name="contractType" class="form-control selectpicker" select-picker title="" required>
                <option value="">select contract type</option>
                <option value="rent">Rent</option>
                <option value="power">Power</option>
                <option value="rentAndPower">Rent and Power counter (АП и электропитание по счетчику отдельными статьями)</option>
                <option value="rentWithPower">Rent with Power (в АП включено электропитание)</option>
            </select>
            <label class="error" ng-if="kcell_form.contractType.$error.required && ( kcell_form.contractType.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">RBS Quantity:</label>
        <div class="col-sm-2">
            <input type="number" name="rbsQuantity" ng-model="rbsQuantity" class="form-control" required />
            <label class="error" ng-if="kcell_form.rbsQuantity.$error.required && ( kcell_form.rbsQuantity.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label"></label>
        <div class="col-sm-2">
            <input type="text" name="otherRbsLocation" ng-model="otherRbsLocation" class="form-control" placeholder="if Other..." ng-disabled="rbsLocation !== 'Other'" ng-required="rbsLocation == 'Other'" />
            <label class="error" ng-if="kcell_form.otherRbsLocation.$error.required && ( kcell_form.otherRbsLocation.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Legally name:</label>
        <div class="col-sm-2">
            <input type="text" name="legallyName" ng-model="legallyName" class="form-control" required />
            <label class="error" ng-if="kcell_form.legallyName.$error.required && ( kcell_form.legallyName.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">RBS type:</label>
        <div class="col-sm-2">
            <select class="form-control" id="rbsType" name="rbsType" ng-model="rbsType" ng-options="r as r for r in catalogs.rbsTypes" required>
            </select>
            <label class="error" ng-if="kcell_form.rbsType.$error.required && ( kcell_form.rbsType.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Square, m2:</label>
        <div class="col-sm-2">
            <input type="number" name="squareMeter" ng-model="squareMeter" class="form-control" required />
            <label class="error" ng-if="kcell_form.squareMeter.$error.required && ( kcell_form.squareMeter.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Contact information:</label>
        <div class="col-sm-2">
            <input type="text" name="contactInformation" ng-model="contactInformation" class="form-control" required />
            <label class="error" ng-if="kcell_form.contactInformation.$error.required && ( kcell_form.contactInformation.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">Address:</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="address" ng-model="address" maxlength="1500" rows="4" required></textarea>
            <label class="error" ng-if="kcell_form.address.$error.required && ( kcell_form.address.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">*Coverage area:</label>
        <div class="col-sm-10">
            <div ng-show="coverageAreaFile.name">
                <a ng-click="download(coverageAreaFile)">{{coverageAreaFile.name}}</a> | <a ng-click="clearFile('coverageAreaFile')"><i class="glyphicon glyphicon-trash"></i></a>
            </div>
            <input ng-hide="coverageAreaFile.name" type="file" class="form-control" id="coverageAreaFile" name="coverageAreaFile" ng-model="coverageAreaFile.name" required-file="!coverageAreaFile.name" onchange="angular.element(this).scope().fileSelected(this, 'coverageAreaFile')"/>
            <label class="has-error" ng-if="kcell_form.coverageAreaFile.$error.validFile && ( kcell_form.coverageAreaFile.$touched || view.submitted)">File is required</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-12 control-label">*Please attach print copy of coverage area from Google Earth program: {{coverageAreaFile}}</label>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">Reason of dismantling:</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="dismantlingReason" ng-model="dismantlingReason" maxlength="1500" rows="4" placeholder="Reason of dismantling" required></textarea>
            <label class="error" ng-if="kcell_form.dismantlingReason.$error.required && ( kcell_form.dismantlingReason.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">Comments</label>
        <div class="col-sm-10">
            <textarea class="form-control" ng-model="region_modifyTaskComment" name="region_modifyTaskComment" placeholder="Comments..." maxlength="500" rows="4" style="resize:none" ng-required="region_modifyTaskResult == 'reject' || region_modifyTaskResult == 'returnForCorrection'"></textarea>
            <label class="error" ng-show="kcell_form.region_modifyTaskComment.$error.required && ( kcell_form.region_modifyTaskComment.$touched || view.submitted)">Required field</label>
        </div>
    </div>
</form>

