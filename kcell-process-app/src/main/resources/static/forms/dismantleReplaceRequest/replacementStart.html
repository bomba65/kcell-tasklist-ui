<style>
    .my-group .form-control{
        width:50%;
    }
    .modal-lg.modal-dialog{
        width: 90%;
    }
</style>
<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        <!-- <script> -->
        inject(['$scope', '$http', '$rootScope', '$q', '$timeout', function ($scope, $http, $rootScope, $q, $timeout) {
            var variablesToCreate = [
                {
                    name: 'siteInformation',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'srrCreationDate',
                    type: 'Date',
                    submit: true,
                    store: true
                },
                {
                    name: 'validityDate',
                    type: 'Date',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteRegion',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteName',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'site',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'site_name',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToRegion',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToName',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteTo',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'site_to_name',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteFromRbsTypes',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToRbsTypes',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteFromBand',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToBand',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteFromRbsLocation',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToRbsLocation',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteFromGsmAntennaTypes',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToGsmAntennaTypes',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteFromTransmissionAntennaType',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToTransmissionAntennaType',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'requestType',
                    type: 'String',
                    submit: true,
                    store: true,
                },
                {
                    name: 'resolutions',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'centralGroups',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'srrNumber',
                    type: 'String',
                    submit: true,
                    store: true,
                },
                {
                    name: 'initiatorFull',
                    type: 'Json',
                    submit: true,
                    store: true,
                },
                {
                    name: 'priority',
                    type: 'String',
                    submit: true,
                    store: true,
                },
                {
                    name: 'coverageAreaFile',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToCoverageAreaFile',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteStatus',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'siteToStatus',
                    type: 'String',
                    submit: true,
                    store: true
                }
            ];
            var uuid = new Date().getTime();
            $scope.srrCreationDate = new Date();
            $scope.requestType = 'replacement';
            $scope.priority = 'regular';
            $scope.catalogs = {};
            $scope.siteStatus = undefined;
            $scope.siteToStatus = undefined;


            $scope.siteInformation = [
                { name: 'cell A:', gsmLabel: 'GSM-', gsmValue: undefined, umtsLabel: 'UMTS-', umtsValue: undefined, lteLabel: 'LTE-', lteValue: undefined},
                { name: 'cell B:', gsmLabel: 'GSM-', gsmValue: undefined, umtsLabel: 'UMTS-', umtsValue: undefined, lteLabel: 'LTE-', lteValue: undefined},
                { name: 'cell C:', gsmLabel: 'GSM-', gsmValue: undefined, umtsLabel: 'UMTS-', umtsValue: undefined, lteLabel: 'LTE-', lteValue: undefined}
            ];

            $scope.centralGroups = [
                "Central Leasing Unit",
                "Central Transmission Unit",
                "Central S&FM Unit",
                "Central Planning Unit",
                "Central SAO Unit"
            ];

            $scope.siteFromGsmAntennaTypes = [];
            $scope.siteToGsmAntennaTypes = [];
            $scope.siteFromRbsTypes = [];
            $scope.siteToRbsTypes = [];

            $scope.regions = [
                {id: 'alm', name: 'Almaty', value: 'Alm'},
                {id: 'astana', name: 'Astana', value: 'Astana'},
                {id: 'nc', name: 'North and Center', value: 'N\&C'},
                {id: 'east', name: 'East', value: 'East'},
                {id: 'south', name: 'South', value: 'South'},
                {id: 'west', name: 'West', value: 'West'}
            ]
            $scope.regionsMap = {
                '0': 'Alm',
                '11':'Astana',
                '1': 'N&C',
                '2': 'N&C',
                '3': 'East',
                '4': 'South',
                '5': 'West',
                '6': 'West',
                '7': 'West',
                '8': 'West'
            };
            $scope.regionsMapLC = {
                '0': 'alm',
                '11':'astana',
                '1': 'nc',
                '2': 'nc',
                '3': 'east',
                '4': 'south',
                '5': 'west',
                '6': 'west',
                '7': 'west',
                '8': 'west'
            };
            $scope.supplementaryFiles = [];

            camForm.on('form-loaded', function () {
                variablesToCreate.forEach(function (el) {
                    camForm.variableManager.fetchVariable(el.name);
                });

                $http.get($rootScope.getCatalogsHttpByName('dismantleCatalogs')).then(
                    function(result){
                        angular.extend($scope.catalogs, result.data);
                    },
                    function(error){
                        console.log(error.data);
                    }
                );
            });

            camForm.on('variables-fetched', function () {
                variablesToCreate.forEach(function (el) {
                    if (camForm.variableManager.variables[el.name].type === undefined) {
                        camForm.variableManager.variables[el.name].type = el.type;
                        if(el.value){
                            camForm.variableManager.variables[el.name].value = el.value;
                        }
                    }
                });
                $http.get('/camunda/api/engine/engine/default/user/'+$rootScope.authentication.name+'/profile').then(
                        function(result){
                            $scope.initiatorFull = result.data;
                        },
                        function(error){}
                );
                $http.get("/camunda/api/engine/engine/default/user/" + $rootScope.authentication.name+ "/profile").then(function(result){
                    $rootScope.authentication.assigneeName = (result.data.firstName ? result.data.firstName : "") + " " + (result.data.lastName ? result.data.lastName : "");
                });
            });

            camForm.on('submit', function (e) {
                try{
                    //e.submitPrevented = true;    
                    var attachments = [];
                    var attachmentsChanges = {"added": [], "removed":[]};
                    attachments.push($scope.coverageAreaFile);
                    attachments.push($scope.siteToCoverageAreaFile)
                    attachments.push($scope.supplementaryFiles)
                    attachments = _.flattenDeep(attachments)
                    
                    attachmentsChanges.added = attachments

                    camForm.variableManager.createVariable({
                        name: 'attachments',
                        type: 'json',
                        value: attachments
                    });      
                    camForm.variableManager.createVariable({
                        name: 'supplementaryFiles',
                        type: 'json',
                        value: $scope.supplementaryFiles
                    });                         

                    variablesToCreate.forEach(function (el) {
                        if(el.name === 'resolutions'){
                            $scope.resolutions = [];
                            $scope.resolutions.push({processInstanceId: 'noProcessInstanceId', assignee: $rootScope.authentication.name, assigneeName: $rootScope.authentication.assigneeName, resolution: 'created', comment: $scope.startComment, taskId: 'noTaskId', taskName:'SRR Start', taskEndDate:new Date(),  visibility: 'all', attachments: attachmentsChanges});
                        }
                        if (el.submit && $scope[el.name]) {
                            camForm.variableManager.variableValue(el.name, $scope[el.name]);
                        }
                    });
                    console.log($scope)
                } catch(error){
                    console.log(error)
                }
                
            });

            $scope.getSite = function(val) {
                return $http.get('https://asset.test-flow.kcell.kz/asset-management/sites/name/contains/'+val).then(
                    function(response){
                        response.data.forEach(function(e){
                            e.name = e.site_name;
                        });
                        return response.data;
                    }
                );
            };

            $scope.siteSelected = function ($item) {
                $scope.siteName = $item.site_name;
                $scope.site = $item.id;
                $scope.site_name = $item.site_name;
                $http.get('https://asset.test-flow.kcell.kz/asset-management/sites/id/'+$scope.site).then(
                    function(response){
                        $scope.siteStatus = response.data.site_status_id.name.toLowerCase();
                        if ($scope.siteName.startsWith('11')) {
                            $scope.regionShortName = $scope.regionsMap['11'];
                            $scope.siteRegion = $scope.regionsMapLC['11'];
                            refreshJobRequests();
                        } else if ($scope.siteName.startsWith('9')) {
                            $scope.regionShortName = undefined;
                            $scope.siteRegion = undefined;
                        } else {
                            $scope.regionShortName = $scope.regionsMap[$scope.siteName.substring(0, 1)];
                            $scope.siteRegion = $scope.regionsMapLC[$scope.siteName.substring(0, 1)];
                        }
                        $scope.siteAddress = (response.data.facility_id.address_id.city_id.district_id.oblast_id.region_id.name ? response.data.facility_id.address_id.city_id.district_id.oblast_id.region_id.name: '') +
                        (response.data.facility_id.address_id.city_id.district_id.oblast_id.name ? ', ' + response.data.facility_id.address_id.city_id.district_id.oblast_id.name : '') +
                        (response.data.facility_id.address_id.city_id.district_id.name ? ', ' + response.data.facility_id.address_id.city_id.district_id.name : '') +
                        (response.data.facility_id.address_id.city_id.name ? ', ' + response.data.facility_id.address_id.city_id.name : '') +
                        (response.data.facility_id.address_id.city_id.city_type_id.name ? ' (' + response.data.facility_id.address_id.city_id.city_type_id.name + ')' : '') +
                        (response.data.facility_id.address_id.street ? ', ' + response.data.facility_id.address_id.street : '') +
                        (response.data.facility_id.address_id.building ? ', ' + response.data.facility_id.address_id.building : '')+
                        (response.data.facility_id.address_id.note ? ', ' + response.data.facility_id.address_id.note : '')+
                        (response.data.facility_id.address_id.cadastral_number ? ', ' + response.data.facility_id.address_id.cadastral_number : '');

                        $(function () {
                            $('[data-toggle="tooltip"]').tooltip('fixTitle');
                        });
                    }
                );
            };

            $scope.siteToSelected = function ($item) {
                $scope.siteToName = $item.site_name;
                $scope.siteTo = $item.id;
                $scope.site_to_name = $item.site_name;
                $http.get('https://asset.test-flow.kcell.kz/asset-management/sites/id/'+$scope.siteTo).then(
                    function(response){
                        $scope.siteToStatus = response.data.site_status_id.name.toLowerCase();
                        if ($scope.siteToName.startsWith('11')) {
                            $scope.siteToRegionShortName = $scope.regionsMap['11'];
                            $scope.siteToRegion = $scope.regionsMapLC['11'];
                            refreshJobRequests();
                        } else if ($scope.siteToName.startsWith('9')) {
                            $scope.siteToRegionShortName = undefined;
                            $scope.siteToRegion = undefined;
                        } else {
                            $scope.siteToRegionShortName = $scope.regionsMap[$scope.siteToName.substring(0, 1)];
                            $scope.siteToRegion = $scope.regionsMapLC[$scope.siteToName.substring(0, 1)];
                        }
                        $scope.siteTAddress = (response.data.facility_id.address_id.city_id.district_id.oblast_id.region_id.name ? response.data.facility_id.address_id.city_id.district_id.oblast_id.region_id.name: '') +
                        (response.data.facility_id.address_id.city_id.district_id.oblast_id.name ? ', ' + response.data.facility_id.address_id.city_id.district_id.oblast_id.name : '') +
                        (response.data.facility_id.address_id.city_id.district_id.name ? ', ' + response.data.facility_id.address_id.city_id.district_id.name : '') +
                        (response.data.facility_id.address_id.city_id.name ? ', ' + response.data.facility_id.address_id.city_id.name : '') +
                        (response.data.facility_id.address_id.city_id.city_type_id.name ? ' (' + response.data.facility_id.address_id.city_id.city_type_id.name + ')' : '') +
                        (response.data.facility_id.address_id.street ? ', ' + response.data.facility_id.address_id.street : '') +
                        (response.data.facility_id.address_id.building ? ', ' + response.data.facility_id.address_id.building : '')+
                        (response.data.facility_id.address_id.note ? ', ' + response.data.facility_id.address_id.note : '')+
                        (response.data.facility_id.address_id.cadastral_number ? ', ' + response.data.facility_id.address_id.cadastral_number : '');

                        $(function () {
                            $('[data-toggle="tooltip"]').tooltip('fixTitle');
                        });
                    }
                );
            };

            $scope.regionSelected = function(siteRegion){
                $scope.regionShortName = _.find($scope.regions, function (r) {
                    return r.id === siteRegion;
                }).value;
            }

            $scope.siteToRegionSelected = function(siteRegion){
                $scope.siteToRegionShortName = _.find($scope.regions, function (r) {
                    return r.id === siteRegion;
                }).value;
            }

            $scope.getGsmAntennaType = function(val) {
                var result = [];
                angular.forEach($scope.catalogs.gsmAntennaTypes, function (gat) {
                    if(gat.toUpperCase().indexOf(val.toUpperCase()) >= 0 && $scope.siteFromGsmAntennaTypes.indexOf(gat)===-1){
                        result.push(gat);
                    }
                });
                return result;
            };

            $scope.gsmAntennaSelected = function($item){
                $scope.siteFromGsmAntennaTypes.push($item);
            }

            $scope.removeGsmAntennaType = function(index){
                $scope.siteFromGsmAntennaTypes.splice(index,1);
            }

            $scope.getSiteToGsmAntennaType = function(val) {
                var result = [];
                angular.forEach($scope.catalogs.gsmAntennaTypes, function (gat) {
                    if(gat.toUpperCase().indexOf(val.toUpperCase()) >= 0 && $scope.siteToGsmAntennaTypes.indexOf(gat)===-1){
                        result.push(gat);
                    }
                });
                return result;
            };

            $scope.siteToGsmAntennaSelected = function($item){
                $scope.siteToGsmAntennaTypes.push($item);
            }

            $scope.removeSiteToGsmAntennaType = function(index){
                $scope.siteToGsmAntennaTypes.splice(index,1);
            }

            $scope.getRbsType = function(val) {
                var result = [];
                angular.forEach($scope.catalogs.rbsTypes, function (rt) {
                    if(rt.toUpperCase().indexOf(val.toUpperCase()) >= 0 && $scope.siteFromRbsTypes.indexOf(rt)===-1){
                        result.push(rt);
                    }
                });
                return result;
            };

            $scope.rbsTypeSelected = function($item){
                $scope.siteFromRbsTypes.push($item);
            }

            $scope.removeRbsType = function(index){
                $scope.siteFromRbsTypes.splice(index,1);
            }

            $scope.getSiteToRbsType = function(val) {
                var result = [];
                angular.forEach($scope.catalogs.rbsTypes, function (rt) {
                    if(rt.toUpperCase().indexOf(val.toUpperCase()) >= 0 && $scope.siteToRbsTypes.indexOf(rt)===-1){
                        result.push(rt);
                    }
                });
                return result;
            };

            $scope.siteToRbsTypeSelected = function($item){
                $scope.siteToRbsTypes.push($item);
            }

            $scope.removeSiteToRbsType = function(index){
                $scope.siteToRbsTypes.splice(index,1);
            }

            $scope.preSubmit = function(){
                var deferred = $q.defer();
                if($scope.siteStatus !== 'working site'){
                    deferred.reject('Only working site allowed to be replaced');
                    return deferred.promise;
                } else if($scope.siteToRbsTypes.length === 0){
                    deferred.reject('Site (to) Rbs type is not selected');
                    return deferred.promise;
                } else if($scope.siteFromGsmAntennaTypes.length === 0){
                    deferred.reject('Site (from) GSM Antenna type is not selected');
                    return deferred.promise;
                } else if($scope.siteToGsmAntennaTypes.length === 0){
                    deferred.reject('Site (to) GSM Antenna type is not selected');
                    return deferred.promise;
                } else if($scope.siteFromRbsTypes.length === 0){
                    deferred.reject('Site (from) Rbs type is not selected');
                    return deferred.promise;
                } else {
                    var srrCounter = 'SRR-' + $scope.regionShortName+'-'+$scope.srrCreationDate.getFullYear().toString().substr(-2);
                    return $http.post('/asset-management/sdrrequestcounter/' + srrCounter).then(
                            function(result){
                                $scope.srrNumber = result.data;
                                camForm.businessKey = result.data;
                            }
                    );
                }
            }

            $scope.fileSelected = function(el, fileName){
                if(el.files[0]){
                    $timeout(function () {
                        $scope.$apply(function () {
                            uploadFileToMinio(el.files[0], fileName);
                        });
                    })
                } else {
                    $scope.$apply(function(){
                        $scope[fileName] = undefined;
                    });
                }
            };

            function uploadFileToMinio(file, fileName) {
                console.log(file)
                console.log(fileName)
                var fileToUpload = {
                    name: file.name.replace(/[/\\?%#*:|"<>]/g, '-'),
                    path: uuid + '/' + file.name.replace(/[/\\?%#*:|"<>]/g, '-')
                };
                $http({method: 'GET', url: '/camunda/uploads/tmp/put/' + fileToUpload.path, transformResponse: [] }).
                then(function(response) {
                    $http.put(response.data, file, {headers: {'Content-Type': undefined}}).then(
                            function () {
                                if(fileName == 'supplementaryFile'){
                                    $scope.supplementaryFiles.push(fileToUpload)
                                } else {
                                    $scope[fileName] = fileToUpload;
                                }
                                angular.element(document.querySelector('#'+fileName)).val(null);
                            },
                            function (error) {
                                console.log(error.data);
                            }
                    );
                }, function(error){
                    console.log(error.data);
                });
            }

            $scope.clearFile = function(filename){
                delete $scope[filename];
            };

            $scope.clearFileSupp = function(index){
                delete $scope.supplementaryFiles[index];
            };
            
            $scope.download = function(file) {
                $http({method: 'GET', url: '/camunda/uploads/get/' + file.path, transformResponse: [] }).
                then(function(response) {
                    document.getElementById('fileDownloadIframe').src = response.data;
                }, function(error){
                    console.log(error.data);
                });
            };
        }]);
    </script>
    <iframe id="fileDownloadIframe" style="display:none;"></iframe>

    <div class="form-group">
        <div class="col-sm-6">
            <h4>Create SITE REPLACEMENT REQUEST</h4>
        </div>
        <div class="col-sm-3">
            <label>Site Replacement Request number:</label>
        </div>
        <div class="col-sm-3">
            <span>SRR-{{regionShortName?regionShortName:'###'}}-{{srrCreationDate.getFullYear().toString().substr(-2)}}-{{siteCounter?siteCounter:'####'}}</span>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">SRR Creation date:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="srrCreationDate" name="srrCreationDate" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="srrCreationDateFiledOpened" id="srrCreationDate" disabled="disabled" />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="srrCreationDateFiledOpened = true">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
        </div>

        <label class="col-sm-2 control-label">SA&O Complaint Id:</label>
        <div class="col-sm-3">
            <input type="text" cam-variable-name="soaComplaintId" cam-variable-type="String" class="form-control" ng-blur="checkSOAComplaintId()" maxlength="20"/>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Validity date:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="validityDate" name="validityDate" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="validityDateFiledOpened" id="validityDate" min-date="datepickerOptions.minDate" required />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="validityDateFiledOpened = true">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
            <label class="error" ng-if="kcell_form.validityDate.$error.required && ( kcell_form.validityDate.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-2 control-label">Initiator of replacement:</label>
        <div class="col-sm-3">
            <select cam-variable-name="replacementInitiator" name="replacementInitiator" cam-variable-type="String" class="form-control selectpicker" select-picker title="" required>
                <option value="">select initiator</option>
                <option value="optimization">Optimization Unit</option>
                <option value="transmission">Transmission Unit</option>
                <option value="infrastructure">Infrastructure Unit</option>
                <option value="operation">Operation Unit</option>
            </select>
            <label class="error" ng-if="kcell_form.replacementInitiator.$error.required && ( kcell_form.replacementInitiator.$touched || view.submitted)">Required field</label>
        </div>
        <div class="col-sm-2" ng-show="replacementInitiator=='optimization'">
            <input type="checkbox" cam-variable-name="planningUnit" cam-variable-type="Boolean" >
            <label>Only for Planning</label>
            <label class="error" ng-if="kcell_form.planningUnit.$error.required && ( kcell_form.planningUnit.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Site (from):</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="site_name" name="site_name" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="siteSelected($item,$model,$label)" class="form-control" required autocomplete="off" placeholder="Site Name">
                <input type="hidden" ng-model="site" name="siteId" required/>
                <span class="input-group-btn" ng-if="siteName" data-toggle="tooltip" data-placement="right" title="Site (from) status">
                    <button type="button" class="btn btn-default">
                        {{siteStatus ? siteStatus : 'working site'}}
                    </button>
                </span>
            </div>
            <label class="error" ng-if="kcell_form.site_name.$error.required && ( kcell_form.site_name.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="kcell_form.siteId.$error.required && ( kcell_form.siteName.$touched || view.submitted)">Please choose site from list</label>
            <label class="error" ng-if="site_name && siteStatus !== 'working site'">Only working site allowed to be replaced</label>
        </div>
        <div class="col-sm-7">
            <input type="tel" class="form-control" name="siteAddress" cam-variable-name="siteAddress" cam-variable-type="String" maxlength="1500" rows="4" required placeholder="Site address..." />
        </div>

        <div ng-if="siteName.startsWith('9')">
            <label class="col-sm-2 control-label">Site (from) region:</label>
            <div class="col-sm-3">
                <select class="form-control selectpicker" select-picker title="" select-model="regions" ng-model="siteRegion" name="siteRegion" ng-change="regionSelected(siteRegion)" required="true">
                    <option value="">select region for mobile site</option>
                    <option value="{{r.id}}" ng-repeat="r in regions" ng-selected="{{r.id == siteRegion}}">{{r.name}}</option>
                </select>
                <label class="error" ng-if="siteName.startsWith('9') && kcell_form.siteRegion.$error.required && ( kcell_form.siteRegion.$touched || view.submitted)">Required field</label>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Site (to):</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="site_to_name" name="site_to_name" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="siteToSelected($item,$model,$label)" class="form-control" required autocomplete="off" placeholder="Site Name">
                <input type="hidden" ng-model="siteTo" name="siteToId" required/>
                <span class="input-group-btn" ng-if="siteToName" data-toggle="tooltip" data-placement="right" title="Site (to) status">
                    <button type="button" class="btn btn-default">
                        {{siteToStatus ? siteToStatus : 'working site'}}
                    </button>
                </span>
                <label class="error" ng-if="kcell_form.site_to_name.$error.required && ( kcell_form.site_to_name.$touched || view.submitted)">Required field</label>
                <label class="error" ng-if="kcell_form.siteToId.$error.required && ( kcell_form.siteToName.$touched || view.submitted)">Please choose site from list</label>
            </div>
        </div>
        <div class="col-sm-7">
            <input type="tel" class="form-control" name="siteTAddress" cam-variable-name="siteTAddress" cam-variable-type="String" maxlength="1500" rows="4" required placeholder="Site address..." />
        </div>

        <div ng-if="siteToName.startsWith('9')">
            <label class="col-sm-2 control-label">Site (to) region:</label>
            <div class="col-sm-3">
                <select class="form-control selectpicker" select-picker title="" select-model="regions" ng-model="siteToRegion" name="siteToRegion" ng-change="siteToRegionSelected(siteToRegion)" required="true">
                    <option value="">select region for mobile site</option>
                    <option value="{{r.id}}" ng-repeat="r in regions" ng-selected="{{r.id == siteToRegion}}">{{r.name}}</option>
                </select>
                <label class="error" ng-if="siteName.startsWith('9') && kcell_form.siteToRegion.$error.required && ( kcell_form.siteToRegion.$touched || view.submitted)">Required field</label>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">
            Traffic: <br />
            (sum monthly)
        </label>
        <div class="col-sm-10">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <td> </td>
                        <td> </td>
                        <td>Voice Traffic_Erlang</td>
                        <td> </td>
                        <td>Data Traffic_GB</td>
                        <td></td>
                        <td>Data Traffic_GB</td>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="siteInfo in siteInformation">
                        <td>{{siteInfo.name}}</td>
                        <td>{{siteInfo.gsmLabel}}</td>
                        <td>
                            <input type="number" ng-model="siteInfo.gsmValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                        </td>
                        <td>{{siteInfo.umtsLabel}}</td>
                        <td>
                            <input type="number" ng-model="siteInfo.umtsValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                        </td>
                        <td>{{siteInfo.lteLabel}}</td>
                        <td>
                            <input type="number" ng-model="siteInfo.lteValue" min="0" name="gsmValue{{$index}}" style="width: 50px;">
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <H4 style="margin-top: 30px;">Site Information</H4>

    <div class="form-group">
        <label class="col-sm-3 control-label"><h4>Site (from)</h4></label>
        <label class="col-sm-3 control-label"> {{site_name}}</label>

        <label class="col-sm-3 control-label"><h4>Site (to)</h4></label>
        <label class="col-sm-3 control-label"> {{site_to_name}}</label>
    </div>


    <div class="form-group">
        <label class="col-sm-3 control-label">RBS Quantity:</label>
        <div class="col-sm-3">
            <input type="number" name="siteFromRbsQuantity" cam-variable-name="siteFromRbsQuantity" cam-variable-type="Integer" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteFromRbsQuantity.$error.required && ( kcell_form.siteFromRbsQuantity.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">RBS Quantity:</label>
        <div class="col-sm-3">
            <input type="number" name="siteToRbsQuantity" cam-variable-name="siteToRbsQuantity" cam-variable-type="Integer" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteToRbsQuantity.$error.required && ( kcell_form.siteToRbsQuantity.$touched || view.submitted)">Required field</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label">Latitude:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromLatitude" cam-variable-name="siteFromLatitude" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteFromLatitude.$error.required && ( kcell_form.siteFromLatitude.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Latitude:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToLatitude" cam-variable-name="siteToLatitude" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteToLatitude.$error.required && ( kcell_form.siteToLatitude.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Longitude:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromLongitude" cam-variable-name="siteFromLongitude" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteFromLongitude.$error.required && ( kcell_form.siteFromLongitude.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Longitude:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToLongitude" cam-variable-name="siteToLongitude" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteToLongitude.$error.required && ( kcell_form.siteToLongitude.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">RBS type:</label>
        <div class="col-sm-3">
            <span ng-repeat="rt in siteFromRbsTypes" class="my-tag">{{rt}} <a ng-click="removeRbsType($index)">&times;</a></span>
            <input type="text" ng-model="tempRbsType" name="tempRbsType" typeahead="result as result for result in getRbsType($viewValue)" typeahead-on-select="rbsTypeSelected($item); tempRbsType = undefined" class="form-control" autocomplete="off" placeholder="Add Rbs Type" ng-required="siteFromRbsTypes.length == 0">
            <label class="error" ng-if="kcell_form.tempRbsType.$error.required && ( kcell_form.tempRbsType.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="siteFromRbsTypes.length == 0 && ( kcell_form.tempRbsType.$touched || view.submitted)">Select at least one from list</label>
        </div>

        <label class="col-sm-3 control-label">RBS type:</label>
        <div class="col-sm-3">
            <span ng-repeat="rt in siteToRbsTypes" class="my-tag">{{rt}} <a ng-click="removeSiteToRbsType($index)">&times;</a></span>
            <input type="text" ng-model="siteToTempRbsType" name="siteToTempRbsType" typeahead="result as result for result in getSiteToRbsType($viewValue)" typeahead-on-select="siteToRbsTypeSelected($item); siteToTempRbsType = undefined" class="form-control" autocomplete="off" placeholder="Add Rbs Type" ng-required="siteToRbsTypes.length == 0">
            <label class="error" ng-if="kcell_form.siteToTempRbsType.$error.required && ( kcell_form.siteToTempRbsType.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="siteToRbsTypes.length == 0 && ( kcell_form.siteToTempRbsType.$touched || view.submitted)">Select at least one from list</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Band:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteFromBand" name="siteFromBand" ng-model="siteFromBand" ng-options="b as b for b in catalogs.bands" required></select>
            <label class="error" ng-if="kcell_form.siteFromBand.$error.required && ( kcell_form.siteFromBand.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Band:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteToBand" name="siteToBand" ng-model="siteToBand" ng-options="b as b for b in catalogs.bands" required></select>
            <label class="error" ng-if="kcell_form.siteToBand.$error.required && ( kcell_form.siteToBand.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">RBS location:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteFromRbsLocation" name="siteFromRbsLocation" ng-model="siteFromRbsLocation" ng-options="r as r for r in catalogs.rbsLocations" required>
            </select>
            <label class="error" ng-if="kcell_form.siteFromRbsLocation.$error.required && ( kcell_form.siteFromRbsLocation.$touched || view.submitted)">Required field</label>
        </div>
        
        <label class="col-sm-3 control-label">RBS location:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteToRbsLocation" name="siteToRbsLocation" ng-model="siteToRbsLocation" ng-options="r as r for r in catalogs.rbsLocations" required>
            </select>
            <label class="error" ng-if="kcell_form.siteToRbsLocation.$error.required && ( kcell_form.siteToRbsLocation.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Square, m2:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromSquareMeter" cam-variable-name="siteFromSquareMeter" cam-variable-type="String" class="form-control" />
            <label class="error" ng-if="kcell_form.siteFromSquareMeter.$error.required && ( kcell_form.siteFromSquareMeter.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Square, m2:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToSquareMeter" cam-variable-name="siteToSquareMeter" cam-variable-type="String" class="form-control" />
            <label class="error" ng-if="kcell_form.siteToSquareMeter.$error.required && ( kcell_form.siteToSquareMeter.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">GSM Antenna type:</label>
        <div class="col-sm-3">
            <span ng-repeat="gt in siteFromGsmAntennaTypes" class="my-tag">{{gt}} <a ng-click="removeGsmAntennaType($index)">&times;</a></span>
            <input type="text" ng-model="tempAntennaType" name="tempAntennaType" typeahead="result as result for result in getGsmAntennaType($viewValue)" typeahead-on-select="gsmAntennaSelected($item); tempAntennaType = undefined" class="form-control" autocomplete="off" placeholder="Add Gsm Antenna" ng-required="siteFromGsmAntennaTypes.length == 0">
            <label class="error" ng-if="kcell_form.tempAntennaType.$error.required && ( kcell_form.tempAntennaType.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="siteFromGsmAntennaTypes.length == 0 && ( kcell_form.tempAntennaType.$touched || view.submitted)">Select at least one from list</label>
        </div>

        <label class="col-sm-3 control-label">GSM Antenna type:</label>
        <div class="col-sm-3">
            <span ng-repeat="gt in siteToGsmAntennaTypes" class="my-tag">{{gt}} <a ng-click="removeSiteToGsmAntennaType($index)">&times;</a></span>
            <input type="text" ng-model="tempSiteToAntennaType" name="tempSiteToAntennaType" typeahead="result as result for result in getSiteToGsmAntennaType($viewValue)" typeahead-on-select="siteToGsmAntennaSelected($item); tempSiteToAntennaType = undefined" class="form-control" autocomplete="off" placeholder="Add Gsm Antenna" ng-required="siteToGsmAntennaTypes.length == 0">
            <label class="error" ng-if="kcell_form.tempSiteToAntennaType.$error.required && ( kcell_form.tempSiteToAntennaType.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="siteToGsmAntennaTypes.length == 0 && ( kcell_form.tempSiteToAntennaType.$touched || view.submitted)">Select at least one from list</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Transmission Antenna type:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteFromTransmissionAntennaType" name="siteFromTransmissionAntennaType" ng-model="siteFromTransmissionAntennaType" ng-options="ta as ta for ta in catalogs.transmissionAntennaTypes" required>
            </select>
            <label class="error" ng-if="kcell_form.siteFromTransmissionAntennaType.$error.required && ( kcell_form.siteFromTransmissionAntennaType.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Transmission Antenna type:</label>
        <div class="col-sm-3">
            <select class="form-control" id="siteToTransmissionAntennaType" name="siteToTransmissionAntennaType" ng-model="siteToTransmissionAntennaType" ng-options="ta as ta for ta in catalogs.transmissionAntennaTypes" required>
            </select>
            <label class="error" ng-if="kcell_form.siteToTransmissionAntennaType.$error.required && ( kcell_form.siteToTransmissionAntennaType.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <H4 style="margin-top: 30px;">Contract Information</H4>

    <div class="form-group">
        <label class="col-sm-3 control-label">Contract ID:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromContractId" cam-variable-name="siteFromContractId" cam-variable-type="String" class="form-control" required/>
            <label class="error" ng-if="kcell_form.siteFromContractId.$error.required && ( kcell_form.siteFromContractId.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Contract ID:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToContractId" cam-variable-name="siteToContractId" cam-variable-type="String" class="form-control" />
            <label class="error" ng-if="kcell_form.siteToContractId.$error.required && ( kcell_form.siteToContractId.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Contract type:</label>
        <div class="col-sm-3">
            <select cam-variable-name="siteFromContractType" name="siteFromContractType" cam-variable-type="String" class="form-control selectpicker" select-picker title="">
                <option value="">select contract type</option>
                <option value="rent">Rent</option>
                <option value="power">Power</option>
                <option value="rentAndPower">Rent and Power counter (АП и электропитание по счетчику отдельными статьями)</option>
                <option value="rentWithPower">Rent with Power (в АП включено электропитание)</option>
            </select>
            <label class="error" ng-if="kcell_form.siteFromContractType.$error.required && ( kcell_form.siteFromContractType.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Contract type:</label>
        <div class="col-sm-3">
            <select cam-variable-name="siteToContractType" name="siteToContractType" cam-variable-type="String" class="form-control selectpicker" select-picker title="">
                <option value="">select contract type</option>
                <option value="rent">Rent</option>
                <option value="power">Power</option>
                <option value="rentAndPower">Rent and Power counter (АП и электропитание по счетчику отдельными статьями)</option>
                <option value="rentWithPower">Rent with Power (в АП включено электропитание)</option>
            </select>
            <label class="error" ng-if="kcell_form.siteToContractType.$error.required && ( kcell_form.siteToContractType.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Legally name:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromLegallyName" cam-variable-name="siteFromLegallyName" cam-variable-type="String" class="form-control" />
            <label class="error" ng-if="kcell_form.siteFromLegallyName.$error.required && ( kcell_form.siteFromLegallyName.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Legally name:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToLegallyName" cam-variable-name="siteToLegallyName" cam-variable-type="String" class="form-control" />
            <label class="error" ng-if="kcell_form.siteToLegallyName.$error.required && ( kcell_form.siteToLegallyName.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Address:</label>
        <div class="col-sm-3">
            <textarea class="form-control" name="siteFromAddress" cam-variable-name="siteFromAddress" cam-variable-type="String" maxlength="1500" rows="4" required></textarea>
            <label class="error" ng-if="kcell_form.siteFromAddress.$error.required && ( kcell_form.siteFromAddress.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Address:</label>
        <div class="col-sm-3">
            <textarea class="form-control" name="siteToAddress" cam-variable-name="siteToAddress" cam-variable-type="String" maxlength="1500" rows="4" required></textarea>
            <label class="error" ng-if="kcell_form.siteToAddress.$error.required && ( kcell_form.siteToAddress.$touched || view.submitted)">Required field</label>
        </div>        
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">*Coverage area:</label>
        <div class="col-sm-3">
            <div ng-show="coverageAreaFile.name">
                <a ng-click="download(coverageAreaFile)">{{coverageAreaFile.name}}</a> | <a ng-click="clearFile('coverageAreaFile')"><i class="glyphicon glyphicon-trash"></i></a>
            </div>
            <input ng-hide="coverageAreaFile.name" type="file" class="form-control" id="coverageAreaFile" name="coverageAreaFile" ng-model="coverageAreaFile" required-file="!coverageAreaFile" onchange="angular.element(this).scope().fileSelected(this, 'coverageAreaFile')"/>
            <label class="has-error" ng-if="kcell_form.coverageAreaFile.$error.validFile && ( kcell_form.coverageAreaFile.$touched || view.submitted)">File is required</label>
        </div>

        <label class="col-sm-3 control-label">*Coverage area:</label>
        <div class="col-sm-3">
            <div ng-show="siteToCoverageAreaFile.name">
                <a ng-click="download(siteToCoverageAreaFile)">{{siteToCoverageAreaFile.name}}</a> | <a ng-click="clearFile('siteToCoverageAreaFile')"><i class="glyphicon glyphicon-trash"></i></a>
            </div>
            <input ng-hide="siteToCoverageAreaFile.name" type="file" class="form-control" id="siteToCoverageAreaFile" name="siteToCoverageAreaFile" ng-model="siteToCoverageAreaFile" required-file="!siteToCoverageAreaFile" onchange="angular.element(this).scope().fileSelected(this, 'siteToCoverageAreaFile')"/>
            <label class="has-error" ng-if="kcell_form.siteToCoverageAreaFile.$error.validFile && ( kcell_form.siteToCoverageAreaFile.$touched || view.submitted)">File is required</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Contact information:</label>
        <div class="col-sm-3">
            <input type="text" name="siteFromContactInformation" cam-variable-name="siteFromContactInformation" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteFromContactInformation.$error.required && ( kcell_form.siteFromContactInformation.$touched || view.submitted)">Required field</label>
        </div>

        <label class="col-sm-3 control-label">Contact information:</label>
        <div class="col-sm-3">
            <input type="text" name="siteToContactInformation" cam-variable-name="siteToContactInformation" cam-variable-type="String" class="form-control" required />
            <label class="error" ng-if="kcell_form.siteToContactInformation.$error.required && ( kcell_form.siteToContactInformation.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Supplementary files:</label>
        <div class="col-sm-9">
            <div  ng-show="supplementaryF.name" ng-repeat="supplementaryF in supplementaryFiles track by $index">
                <a ng-click="download(supplementaryFiles[$index])">{{supplementaryF.name}}</a> | <a ng-click="clearFileSupp($index)"><i class="glyphicon glyphicon-trash"></i></a>
            </div>
            <input  type="file" class="form-control" id="supplementaryFile" name="supplementaryFile" ng-model="$parent.supplementaryFile" onchange="angular.element(this).scope().fileSelected(this, 'supplementaryFile')"/>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Reason of replacemant:</label>
        <div class="col-sm-9">
            <textarea class="form-control" name="replacementReason" cam-variable-name="replacementReason" cam-variable-type="String" maxlength="1500" rows="4" placeholder="Reason of replacement" required></textarea>
            <label class="error" ng-if="kcell_form.replacementReason.$error.required && ( kcell_form.replacementReason.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-3 control-label">Comments:</label>
        <div class="col-sm-9">
            <textarea class="form-control" name="startComment" cam-variable-name="startComment" cam-variable-type="String" maxlength="1500" rows="4" placeholder="Comments"></textarea>
        </div>
    </div>
</form>
