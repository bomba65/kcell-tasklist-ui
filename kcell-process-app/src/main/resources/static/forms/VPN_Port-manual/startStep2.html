<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script" type="text/javascript">
        inject(['$scope', '$http', '$rootScope', '$q', '$timeout', 'exModal', function ($scope, $http) {
            const variables = [
                'businessKey',
                'channel',
                'request_type',
                'priority'
            ];

            $http.get('/camunda/catalogs/api/get/id/30').then(
                function (response) {
                    $scope.oblastCatalog = response.data.data.$list;
                }
            );

            $http.get('/camunda/catalogs/api/get/id/31').then(
                function (response) {
                    $scope.districtCatalog = response.data.data.$list;
                }
            );

            $http.get('/camunda/catalogs/api/get/id/32').then(
                function (response) {
                    $scope.cityVillageCatalog = response.data.data.$list.sort(el => el.value);
                }
            );

            $scope.searchOblastSelected = function (obl) {
                $scope.filteredDistrictCatalog = _.filter($scope.districtCatalog, el => el.parent === obl);
                $scope.availablePorts = [];
                $scope.addedPorts = [];
                $scope.isSearched = false;
            }

            $scope.searchDistrictSelected = function (dis) {
                $scope.filteredCityVillageCatalog = _.filter($scope.cityVillageCatalog, el => el.parent === dis);
                $scope.availablePorts = [];
                $scope.addedPorts = [];
                $scope.isSearched = false;
            }

            $scope.searchCitySelected = function (city) {
                $scope.availablePorts = [];
                $scope.addedPorts = [];
                $scope.isSearched = false;
            }

            $scope.isSearched = false; // allow to add new ports only if available ports are searched

            $scope.availablePorts = [];

            $scope.searchPorts = function () {
                if (!$scope.search_oblast || !$scope.search_district || !$scope.search_city_village) return;
                if ($scope.availablePorts.length > 0) return;
                $scope.availablePorts.push(
                    {
                        "port_id": "БаканасСЕ1",
                        "channel_type": "Main",
                        "port_type": "Optic",
                        "capacity": 20,
                        "capacity_unit": "Gb",
                        "far_end_address": "Алматинская область, Балхашский район, п. Баканас, ул. Канаева, 32 АТС АО \"Казахтелеком\""
                    }
                )
                $scope.isSearched = true;
            }

            $scope.addedPorts = [];

            $scope.addPort = function () {
                if (!$scope.isSearched) return;
                if (!$scope.search_oblast || !$scope.search_district || !$scope.search_city_village) return;
                $scope.addedPorts.push(
                    {
                        "port_id": null,
                        "channel_type": null,
                        "port_type": null,
                        "capacity": null,
                        "capacity_unit": null,
                        "far_end_address": {
                            "oblast": $scope.search_oblast,
                            "district": $scope.search_district,
                            "city": $scope.search_city_village,
                            "address_not_full": false,
                            "street": null,
                            "building": null,
                            "cadastral_number": null,
                            "address_note": null
                        }
                    }
                )
            }

            $scope.removeAddedPort = function (addedPort) {
                const index = $scope.addedPorts.indexOf(addedPort);
                $scope.addedPorts.splice(index, 1);
            }

            $scope.getAddedPortId = function (index) {
                const cityName = $scope.getValueById('cityVillageCatalog', $scope.search_city_village).replace(' ', '');
                const number = $scope.availablePorts.length === 0 ? 1 : /(\d+)(?!.*\d)/g.exec($scope.availablePorts[$scope.availablePorts.length - 1].port_id)[1];
                return cityName + 'CE' + (parseInt(number) + 1 + index);
            }

            $scope.getValueById = function (name, id) {
                return _.find($scope[name], el => el.id === id).value;
            }

            camForm.on('form-loaded', function () {
                variables.forEach(function (el) {
                    camForm.variableManager.fetchVariable(el);
                });
            });

            camForm.on('variables-fetched', function () {
                variables.forEach(function (el) {
                    if (camForm.variableManager.variables[el].value) {
                        $scope[el] = camForm.variableManager.variables[el].value;
                    }
                });
            });

            camForm.on('submit', function (e) {
                camForm.variableManager.createVariable({
                    name: 'addedPorts',
                    type: 'Json',
                    value: $scope.addedPorts
                });
            });
        }]);
    </script>

    <div class="form-group">
        <div class="col-sm-3"><h3>Request {{businessKey}}</h3></div>
    </div>
    <div class="form-group">
        <div class="col-sm-3"><label>Request type & channel:</label></div>
        <div class="col-sm-3">{{request_type + ' ' + channel}}</div>
    </div>
    <div class="form-group">
        <div class="col-sm-3"><label>Priority:</label></div>
        <div class="col-sm-3">{{priority}}</div>
    </div>

    <div class="form-group">
        <div class="col-sm-3"><h3>Search</h3></div>
    </div>
    <div class="form-group">
        <div class="panel-group custom-panel col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">Search by Far end address</h4>
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <div class="col-sm-4"><label class="control-label">Oblast</label></div>
                        <div class="col-sm-8">
                            <select class="form-control" select-picker id="search_oblast" name="search_oblast" required
                                    ng-options="obl.id as obl.value for obl in oblastCatalog" ng-model="search_oblast"
                                    ng-change="searchOblastSelected(search_oblast)">
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-4"><label class="control-label" for="search_district">District</label></div>
                        <div class="col-sm-8">
                            <select class="form-control" select-picker id="search_district" name="search_district"
                                    required
                                    ng-options="dis.id as dis.value for dis in filteredDistrictCatalog"
                                    ng-model="search_district" ng-change="searchDistrictSelected(search_district)">
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-4"><label class="control-label" for="city_village">City/Village</label></div>
                        <div class="col-sm-8">
                            <select class="form-control" select-picker id="city_village" name="city_village" required
                                    ng-options="city.id as city.value for city in filteredCityVillageCatalog | orderBy: 'value'"
                                    ng-model="search_city_village" ng-change="searchCitySelected(city_village)">
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-6">
                            <button type="button" class="btn btn-success" ng-click="searchPorts()">Search</button>
                            <button type="button" class="btn btn-success" ng-click="addPort()">Add Port</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-3"><h3>Available Ports </h3></div>
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <table class="table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Port ID</th>
                    <th>Channel type</th>
                    <th>Port type</th>
                    <th>Capacity</th>
                    <th>Capacity unit</th>
                    <th>Far end address</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="availablePort in availablePorts">
                    <td>{{$index + 1}}</td>
                    <td>{{availablePort.port_id}}</td>
                    <td>{{availablePort.channel_type}}</td>
                    <td>{{availablePort.port_type}}</td>
                    <td>{{availablePort.capacity}}</td>
                    <td>{{availablePort.capacity_unit}}</td>
                    <td>{{availablePort.far_end_address}}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-3"><h3>Added Ports</h3></div>
        <input hidden ng-model="checkPortsAdded" ng-requred="addedPorts.length === 0">
    </div>
    <div class="form-group">
        <div class="col-sm-12">
            <div ng-repeat="addedPort in addedPorts track by $index">
                <div class="panel panel-default">
                    <div class="panel-heading clearfix" style="background-color: transparent; border: none;">
                        <div class="pull-left">{{ $index + 1 }}</div>
                        <button type="button" class="btn btn-danger pull-right" ng-click="removeAddedPort(addedPort)">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>
                    </div>
                    <div class="panel-body">

                        <div class="form-group row">
                            <div class="col-sm-2">
                                <label class="control-label">Port ID</label>
                            </div>
                            <div class="col-sm-4">
                                <input type="text" name="port_id_{{$index}}" class="form-control"
                                       ng-model="addedPort.port_id"
                                       ng-init="addedPort.port_id = getAddedPortId($index)"
                                       ng-value="addedPort.port_id = getAddedPortId($index)"
                                       required>
                                <label class="error" ng-show="kcell_form.port_id_{{$index}}.$error.required && ( kcell_form.port_id_{{$index}}.$touched || view.submitted)">Required field</label>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-2">
                                <label class="control-label">Channel type</label>
                            </div>
                            <div class="col-sm-4">
                                <select class="form-control" name="channel_type_{{$index}}" ng-model="addedPort.channel_type"
                                        required>
                                    <option value="Main">Main</option>
                                    <option value="Reserve">Reserve</option>
                                </select>
                                <label class="error" ng-show="kcell_form.channel_type_{{$index}}.$error.required && ( kcell_form.channel_type_{{$index}}.$touched || view.submitted)">Required field</label>
                            </div>
                            <div class="col-sm-2">
                                <label class="control-label">Port type</label>
                            </div>
                            <div class="col-sm-4">
                                <select class="form-control" name="port_type_{{$index}}" ng-model="addedPort.port_type"
                                        ng-disabled="addedPort.port_capacity_unit == 'Mb'" required>
                                    <option value="Copper" ng-selected="addedPort.port_capacity_unit == 'Mb'">Copper
                                    </option>
                                    <option value="Optic">Optic</option>
                                </select>
                                <label class="error" ng-show="kcell_form.port_type_{{$index}}.$error.required && ( kcell_form.port_type_{{$index}}.$touched || view.submitted)">Required field</label>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-2">
                                <label class="control-label">Capacity</label>
                            </div>
                            <div class="col-sm-4">
                                <input type="number" name="capacity_{{$index}}" class="form-control"
                                       ng-model="addedPort.capacity"
                                       required>
                                <label class="error" ng-show="kcell_form.capacity_{{$index}}.$error.required && ( kcell_form.capacity_{{$index}}.$touched || view.submitted)">Required field</label>
                            </div>
                            <div class="col-sm-2">
                                <label class="control-label">Capacity unit</label>
                            </div>
                            <div class="col-sm-4">
                                <select class="form-control" name="capacity_unit_{{$index}}"
                                        ng-model="addedPort.port_capacity_unit"
                                        required>
                                    <option value="Gb">Gb</option>
                                    <option value="Mb">Mb</option>
                                </select>
                                <label class="error" ng-show="kcell_form.capacity_unit_{{$index}}.$error.required && ( kcell_form.capacity_unit_{{$index}}.$touched || view.submitted)">Required field</label>
                            </div>

                        </div>

                        <div class="form-group row">
                            <div class="col-sm-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading clearfix">
                                        <h4 class="panel-title">Far end address</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label control-label">Oblast</label>
                                            <div class="col-sm-4 control-label">
                                                {{ getValueById("oblastCatalog", addedPort.far_end_address.oblast) }}
                                            </div>
                                            <label class="col-sm-2 col-form-label control-label">Street /
                                                Microdistrict</label>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" name="street_{{$index}}" ng-model="addedPort.far_end_address.street" ng-required="!addedPort.far_end_address.address_not_full">
                                                <label class="error" ng-show="kcell_form.street_{{$index}}.$error.required && ( kcell_form.street_{{$index}}.$touched || view.submitted)">Required field</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label control-label">District</label>
                                            <div class="col-sm-4 control-label">
                                                {{ getValueById("districtCatalog", addedPort.far_end_address.district)}}
                                            </div>
                                            <label class="col-sm-2 col-form-label control-label">Building</label>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" name="building_{{$index}}" ng-model="addedPort.far_end_address.building" ng-required="!addedPort.far_end_address.address_not_full">
                                                <label class="error" ng-show="kcell_form.building_{{$index}}.$error.required && ( kcell_form.building_{{$index}}.$touched || view.submitted)">Required field</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label control-label">City / Village</label>
                                            <div class="col-sm-4 control-label">
                                                {{ getValueById("cityVillageCatalog", addedPort.far_end_address.city) }}
                                            </div>
                                            <label class="col-sm-2 col-form-label control-label">Cadastral number</label>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" name="cadastral_number_{{$index}}" ng-model="addedPort.far_end_address.cadastral_number" ng-required="!addedPort.far_end_address.address_not_full">
                                                <label class="error" ng-show="kcell_form.cadastral_number_{{$index}}.$error.required && ( kcell_form.cadastral_number_{{$index}}.$touched || view.submitted)">Required field</label>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <div class="col-sm-2">Not full address</div>
                                            <div class="col-sm-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                           id="address_not_full"
                                                           ng-model="addedPort.far_end_address.address_not_full">
                                                </div>
                                            </div>
                                            <label class="col-sm-2 col-form-label control-label">Note
                                                to the address</label>
                                            <div class="col-sm-4">
                                                <input type="text" class="form-control" name="address_note_{{$index}}" ng-model="addedPort.far_end_address.address_note" ng-required="!addedPort.far_end_address.address_not_full">
                                                <label class="error" ng-show="kcell_form.address_note_{{$index}}.$error.required && ( kcell_form.address_note_{{$index}}.$touched || view.submitted)">Required field</label>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
