<style>
    .my-group .form-control{
        width:50%;
    }
    .modal-lg.modal-dialog{
        width: 90%;
    }
    .background-yellow-accordion .panel-body {
        background-color: #ffffcc;
        border: 1px solid #b3b3b3;
        color: #333;
    }
</style>

<form role="form" class="form-horizontal" name="kcell_form" novalidate>
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', '$rootScope', '$q', '$timeout', function ($scope, $http, $rootScope, $q, $timeout) {
            var variablesToCreate = [
                {
                    name: 'region_name',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_site_id',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_siteId',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_sitename',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_addressJson',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_site_id',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_siteId',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_sitename',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_addressJson',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'resolutions',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                {
                    name: 'date_of_visit',
                    type: 'Date',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_construction_type',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_construction_type',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'protection_mode',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'ne_diameter',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'fe_diameter',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'hop_link_capacity',
                    type: 'String',
                    submit: true,
                    store: true
                }
            ];
            $scope.date_of_visit = new Date();
            var catalogsServerUrl = "https://catalogs.test-flow.kcell.kz";
            var assetsServerUrl = "https://asset.test-flow.kcell.kz";

            $scope.ne_address_fetched = false;
            $scope.ne_addressJson = {};
            $scope.fe_addressJson = {};

            $scope.latitudePattern = '(4([1-9]{1}.[0-9]{6}|0.([6-9]{1}[0-9]{5}|5([7-9]{1}[0-9]{4}|6(9[0-9]{3}|8[0-9]{3}))))|5([0-4]{1}.[0-9]{6}|5.([0-3]{1}[0-9]{5}|4([0-3]{1}[0-9]{4}|40000))))';
            $scope.longitudePattern = '([5-7]{1}[0-9]{1}.[0-9]{6}|4([7-9]{1}.[0-9]{6}|6.([5-9]{1}[0-9]{5}|49([4-9]{1}|3)[0-9]{3}))|8([0-6]{1}.[0-9]{6}|7.([0-2]{1}[0-9]{5}|3(0[0-9]{4}|1([0-4]{1}[0-9]{3}|5000)))))';
            $scope.numbersPattern = '[-]?[0-9]+';
            $scope.azimuthPattern = '((?:[012]?[0-9]{1,2}|3(?:[0-5][0-9]|60))(?:\.[0-9]{0,2})?)';
            $scope.linkNxePattern = '((?:[0]?[0-9]{1,2}|1(?:[0-4][0-9]|5[0-5]))?)';

            $scope.regionsTitle = {
                'alm': 'Alm',
                'astana': 'Astana',
                'nc': 'N&C',
                'east': 'East',
                'south': 'South',
                'west': 'West'
            };

            $scope.regionsBussinesKey = {
                'alm': 'ALM',
                'astana': 'AST',
                'nc': 'NOR',
                'east': 'EAS',
                'south': 'SOU',
                'west': 'WES'
            };

            camForm.on('form-loaded', function () {
            });

            camForm.on('variables-fetched', function () {
                $http.get('/camunda/api/engine/engine/default/user/' + $rootScope.authentication.name + '/profile').then(
                        function (result) {
                            $scope.initiatorFull = result.data;
                        }, function (error) {
                        }
                );
                angular.forEach($rootScope.authUser.groups, function (group) {
                    if (group.id.endsWith('_tn_engineer')) {
                        $scope.region_name = group.id.replace('_tn_engineer', '');
                    }
                });
            });

            camForm.on('submit', function (e) {
                variablesToCreate.forEach(function (el) {
                    if (el.name === 'resolutions') {
                        $scope.resolutions = [];
                        $scope.resolutions.push({
                            processInstanceId: 'noProcessInstanceId',
                            assignee: $rootScope.authentication.name,
                            assigneeName: $rootScope.authentication.assigneeName,
                            resolution: 'created',
                            comment: $scope.startComment,
                            taskId: 'noTaskId',
                            taskName: 'TNU Start',
                            taskEndDate: new Date(),
                            visibility: 'all'
                        });
                    }
                    if (el.submit && $scope[el.name]) {
                        camForm.variableManager.createVariable({
                            name: el.name,
                            type: el.type,
                            value: $scope[el.name]
                        });
                    }
                });
                if (!$scope.ne_address_fetched && !$scope.ne_address) {
                    if ($scope.ne_addressJson.cn_addr_oblast) {
                        var oblast = _.filter($scope.oblastCatalogList, function (c) {
                            return c.id === $scope.ne_addressJson.cn_addr_oblast;
                        });
                        if (oblast && oblast.length > 0) {
                            $scope.ne_address = oblast[0].value;
                        }
                    }
                    if ($scope.ne_addressJson.cn_addr_district) {
                        var district = _.filter($scope.districtCatalogList, function (c) {
                            return c.id === $scope.ne_addressJson.cn_addr_district;
                        });
                        if (district && district.length > 0) {
                            $scope.ne_address = $scope.ne_address + ($scope.ne_address ? ', ' : '') + district[0].value;
                        }
                    }
                    if ($scope.ne_addressJson.cn_addr_city) {
                        var city = _.filter($scope.cityCatalogList, function (c) {
                            return c.id === $scope.ne_addressJson.cn_addr_city;
                        });
                        if (city && city.length > 0) {
                            $scope.ne_address = $scope.ne_address + ($scope.ne_address ? ', ' : '') + city[0].value;
                        }
                    }
                    if ($scope.ne_addressJson.ca_not_full_addres) {
                        if (ne_addressJson.cn_addr_cadastral_number) {
                            $scope.ne_address = $scope.ne_address +  ($scope.ne_address ? ', ' : '') + $scope.ne_addressJson.cn_addr_cadastral_number;
                        }
                        if (ne_addressJson.cn_addr_note) {
                            $scope.ne_address = $scope.ne_address + ($scope.ne_address ? ', ' : '') + $scope.ne_addressJson.cn_addr_note;
                        }
                    } else {
                        if ($scope.ne_addressJson.cn_addr_street) {
                            $scope.ne_address = $scope.ne_address + ($scope.ne_address ? ', ' : '') + $scope.ne_addressJson.cn_addr_street;
                        }
                        if ($scope.ne_addressJson.cn_addr_building) {
                            $scope.ne_address = $scope.ne_address + ($scope.ne_address ? ', ' : '') + $scope.ne_addressJson.cn_addr_building;
                        }
                    }
                }
                if (!$scope.fe_address_fetched && !$scope.fe_address) {
                    if ($scope.fe_addressJson.cn_addr_oblast) {
                        var oblast = _.filter($scope.oblastCatalogList, function (c) {
                            return c.id === $scope.fe_addressJson.cn_addr_oblast;
                        });
                        if (oblast && oblast.length > 0) {
                            $scope.fe_address = oblast[0].value;
                        }
                    }
                    if ($scope.fe_addressJson.cn_addr_district) {
                        var district = _.filter($scope.districtCatalogList, function (c) {
                            return c.id === $scope.fe_addressJson.cn_addr_district;
                        });
                        if (district && district.length > 0) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + district[0].value;
                        }
                    }
                    if ($scope.fe_addressJson.cn_addr_city) {
                        var city = _.filter($scope.cityCatalogList, function (c) {
                            return c.id === $scope.fe_addressJson.cn_addr_city;
                        });
                        if (city && city.length > 0) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + city[0].value;
                        }
                    }
                    if ($scope.fe_addressJson.ca_not_full_addres) {
                        if ($scope.fe_addressJson.cn_addr_cadastral_number) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + $scope.fe_addressJson.cn_addr_cadastral_number;
                        }
                        if ($scope.fe_addressJson.cn_addr_note) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + $scope.fe_addressJson.cn_addr_note;
                        }
                    } else {
                        if ($scope.fe_addressJson.cn_addr_street) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + $scope.fe_addressJson.cn_addr_street;
                        }
                        if ($scope.fe_addressJson.cn_addr_building) {
                            $scope.fe_address = $scope.fe_address + ($scope.fe_address ? ', ' : '') + fe_addressJson.cn_addr_building;
                        }
                    }
                }

                camForm.variableManager.createVariable({
                    name: 'ne_address',
                    type: 'String',
                    value: $scope.ne_address
                });
                camForm.variableManager.createVariable({
                    name: 'fe_address',
                    type: 'String',
                    value: $scope.fe_address
                });
            });

            $scope.getSite = function (val) {
                return $http.get(assetsServerUrl + '/asset-management/sites/name/contains/' + val).then(
                        function (response) {
                            var sites = _.flatMap(response.data, function (s) {
                                return {
                                    name: s.siteid,
                                    id: s.id,
                                    site_name: s.site_name
                                };
                            });
                            return sites;
                        }
                );
            };

            $scope.fillAddress = function (siteId, site, fetched) {
                $http.get(assetsServerUrl + '/asset-management/sites/id/' + siteId).then(
                        function (response) {
                            if (response.data.facility_id && response.data.facility_id.address_id) {
                                $scope[fetched] = true;
                                var address = response.data.facility_id.address_id;
                                if (address.artefactId) {
                                    $scope[site] = address.note;
                                } else {
                                    if (address.city_id && address.city_id.name) {
                                        if (address.city_id.district_id && address.city_id.district_id.name) {
                                            if (address.city_id.district_id.oblast_id && address.city_id.district_id.oblast_id.name) {
                                                $scope[site] = address.city_id.district_id.oblast_id.name;
                                            }
                                            $scope[site] = ($scope[site] ? ', ' : '') + address.city_id.district_id.name;
                                        }
                                        $scope[site] = ($scope[site] ? ', ' : '') + (address.city_id.city_type_id.name ? address.city_id.city_type_id.name + ' ' : '') + address.city_id.name;
                                    }
                                    if (address.street || address.building) {
                                        $scope[site] = ($scope[site] ? ', ' : '') + (address.street ? address.street + ' ' : '') + address.building;
                                    } else if (address.cadastral_number) {
                                        $scope[site] = ($scope[site] ? ', ' : '') + address.cadastral_number;
                                    }
                                    if (address.note) {
                                        $scope[site] = ($scope[site] ? ', ' : '') + address.note;
                                    }
                                }
                            } else {
                                $scope[site] = undefined;
                                $scope[fetched] = false;
                            }
                        }
                );
            }

            $scope.neSelected = function ($item) {
                $scope.ne_site_id = $item.name;
                $scope.ne_siteId = $item.id;
                $scope.ne_sitename = $item.site_name;
                $scope.fillAddress($item.id, 'ne_address', 'ne_address_fetched');
            };
            $scope.farendSelected = function ($item) {
                $scope.fe_site_id = $item.name;
                $scope.fe_siteId = $item.id;
                $scope.fe_sitename = $item.site_name;
                $scope.fillAddress($item.id, 'fe_address', 'fe_address_fetched');
            };

            $scope.populateSelectFromCatalog = function (containers, id,) {
                $http.get(catalogsServerUrl + '/camunda/catalogs/api/get/id/' + id).then(function (result) {
                    if (result && result.data) {
                        angular.forEach(containers, function (container) {
                            $scope[container] = result.data.data.$list;
                        });
                    }
                });
            }

            $scope.populateSelectFromCatalog(['oblastCatalogList', 'oblastList'], 30);   // Oblast
            $scope.populateSelectFromCatalog(['districtCatalogList', 'filteredDistricts', 'farendFilteredDistricts'], 31); // District
            $scope.populateSelectFromCatalog(['cityCatalogList', 'cityList', 'farendCityList'], 32);     // CityVillage
            $scope.populateSelectFromCatalog(['constructionTypeList'], 14);   // Construction_type
            $scope.populateSelectFromCatalog(['protectionModeList'], 44);     // Protection mode
            $scope.populateSelectFromCatalog(['trAntennasTypeList'], 20);     // TR Antennas Type
            $scope.populateSelectFromCatalog(['linkCapacityList'], 45);       // Link capacity

            $scope.filterDistrictAfterSelectObl = function (cn_addr_oblast) {
                $scope.ne_addressJson.cn_addr_oblast = cn_addr_oblast;
                $scope.ne_addressJson.cn_addr_district = '';
                $scope.ne_addressJson.cn_addr_city = '';
                if ($scope.ne_addressJson.cn_addr_oblast && $scope.ne_addressJson.cn_addr_oblast !== '') {
                    $scope.filteredDistricts = $scope.districtCatalogList.filter(d => {return d.parent === $scope.ne_addressJson.cn_addr_oblast}
                )
                    ;
                    $scope.cityList = $scope.cityCatalogList.filter(c => {
                        return _.some($scope.filteredDistricts, function (d) {
                            return d.id === c.parent
                        });
                })
                    ;
                } else {
                    $scope.filteredDistricts = $scope.districtCatalogList;
                    $scope.cityList = $scope.cityCatalogList;
                }
            };

            $scope.getCity = function (val) {
                if (val.length < 2) {
                    return []
                }
                return _.filter($scope.cityList, function (o) {
                    return o.value.toLowerCase().includes(val.toLowerCase());
                })
            };

            $scope.ne_addressJsonCitySelected = function ($item) {
                $scope.ne_addressJson.cn_addr_city = $item.id;
                $scope.ne_addressJson.cn_addr_district = $item.parent;
                if (!$scope.ne_addressJson.cn_addr_oblast || $scope.ne_addressJson.cn_addr_oblast !== $item.grandparent) {
                    $scope.ne_addressJson.cn_addr_oblast = $item.grandparent;
                }
            };

            $scope.filterDistrictAfterSelectOblFE = function (cn_addr_oblast) {
                $scope.fe_addressJson.cn_addr_oblast = cn_addr_oblast;
                $scope.fe_addressJson.cn_addr_district = '';
                $scope.fe_addressJson.cn_addr_city = '';
                if ($scope.fe_addressJson.cn_addr_oblast && $scope.fe_addressJson.cn_addr_oblast !== '') {
                    $scope.farendFilteredDistricts = $scope.districtCatalogList.filter(d => {return d.parent === $scope.fe_addressJson.cn_addr_oblast}
                )
                    ;
                    $scope.farendCityList = $scope.cityCatalogList.filter(c => {
                        return _.some($scope.farendFilteredDistricts, function (d) {
                            return d.id === c.parent
                        });
                })
                    ;
                } else {
                    $scope.farendFilteredDistricts = $scope.districtCatalogList;
                    $scope.farendCityList = $scope.cityCatalogList;
                }
            };

            $scope.getFarendCity = function (val) {
                if (val.length < 2) {
                    return []
                }
                return _.filter($scope.farendCityList, function (o) {
                    return o.value.toLowerCase().includes(val.toLowerCase());
                })
            };

            $scope.fe_addressJsonCitySelected = function ($item) {
                $scope.fe_addressJson.cn_addr_city = $item.id;
                $scope.fe_addressJson.cn_addr_district = $item.parent;
                if (!$scope.fe_addressJson.cn_addr_oblast || $scope.fe_addressJson.cn_addr_oblast !== $item.grandparent) {
                    $scope.fe_addressJson.cn_addr_oblast = $item.grandparent;
                }
            };
            $scope.hopLinkCapacitySelected = function () {
                var obj = _.filter($scope.linkCapacityList, function (c) {
                    return c.id === $scope.hop_link_capacity;
                });
                if (obj && obj.length > 0) {
                    $scope.hop_modulation_type = obj[0]['Modulation'].value;
                    $scope.hop_channel_bandwidth = obj[0]['Channel Bandwidth'].value;
                }
            }
        }]);
    </script>
    <iframe id="fileDownloadIframe" style="display:none;"></iframe>

    <div class="form-group">
        <div class="col-sm-6">
            <h4>Transmission Survey Data</h4>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label"><b>Process number:</b></label>
        <label class="col-sm-6 control-label">{{ne_sitename?ne_sitename:'##########'}}-{{fe_sitename?fe_sitename:'##########'}}({{region_name?regionsBussinesKey[region_name]:'###'}}####-{{date_of_visit? (date_of_visit | date: 'ddMMyy') : '######'}})</label>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label"><b>Region name:</b></label>
        <label class="col-sm-4 control-label">{{regionsTitle[region_name]}}</label>
        <label class="col-sm-2 control-label"><b>Date:</b></label>
        <div class="col-sm-4">
            <div class="input-group">
                <input type="text" ng-model="date_of_visit" name="dateOfVisit" class="form-control" datepicker-popup="dd.MM.yyyy" is-open="date_of_visitFieldOpened" id="dateOfVisit" required disabled />
            </div>
            <label class="error" ng-if="kcell_form.dateOfVisit.$error.required && ( kcell_form.dateOfVisit.$touched || view.submitted)">Required field</label>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">Sitename:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="ne_sitename" name="ne_sitename" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="neSelected($item,$model,$label)" class="form-control" required autocomplete="off" placeholder="Site Name">
                <input type="hidden" ng-model="ne_siteId" name="ne_siteId" required/>
            </div>
            <label class="error" ng-if="kcell_form.ne_sitename.$error.required && ( kcell_form.ne_sitename.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="kcell_form.ne_siteId.$error.required && ( kcell_form.ne_sitename.$touched || view.submitted)">Необходимо выбрать сайт из списка</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Site Address:</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="ne_address" cam-variable-name="ne_address" cam-variable-type="String" maxlength="1500" rows="2" disabled ng-if="!ne_siteId || ne_address_fetched"></textarea>
            <accordion class="content-visible-accordion background-yellow-accordion" ng-if="ne_siteId && !ne_address_fetched">
                <accordion-group is-open="true">
                    <accordion-heading>
                        Site Address <i class="pull-right glyphicon"
                                        ng-class="{'glyphicon-chevron-up': status.isCustomHeaderOpen, 'glyphicon-chevron-down': !status.isCustomHeaderOpen}"></i>
                    </accordion-heading>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Oblast:</label>
                        <div class="col-sm-8" class="form-check">
                            <select class="form-control" id="cn_addr_oblast" name="cn_addr_oblast" ng-model="ne_addressJson.cn_addr_oblast"
                                    ng-change="filterDistrictAfterSelectObl(ne_addressJson.cn_addr_oblast)">
                                <option ng-repeat="oblast in oblastList" ng-value="oblast.id">{{oblast.value}}</option>
                            </select>
                            <label class="error" ng-show="kcell_form.cn_addr_oblast.$error.required && ( kcell_form.cn_addr_oblast.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">District:</label>
                        <div class="col-sm-8" class="form-check">
                            <select class="form-control" id="cn_addr_district" name="cn_addr_district" ng-model="ne_addressJson.cn_addr_district" ng-disabled="!ne_addressJson.cn_addr_oblast">
                                <option ng-repeat="district in filteredDistricts" ng-value="district.id">{{district.value}}</option>
                            </select>
                            <label class="error" ng-show="kcell_form.cn_addr_district.$error.required && ( kcell_form.cn_addr_district.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">City / Village:</label>
                        <div class="col-sm-8">
                            <input type="text" ng-model="ne_addressJson.cn_addr_city_name" name="cn_addr_city" typeahead="city.value for city in getCity($viewValue)" typeahead-on-select="ne_addressJsonCitySelected($item,$model,$label)" class="form-control" required placeholder="Start typing...">
                            <input type="hidden" ng-model="ne_addressJson.cn_addr_city" name="cityId" required/>
                            <label class="error" ng-show="kcell_form.cn_addr_city.$error.required && ( kcell_form.cn_addr_city.$touched || view.submitted)">Required field</label>
                            <label class="error" ng-show="kcell_form.cityId.$error.required && ( kcell_form.cn_addr_city.$touched || view.submitted)">Please select from list</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label"></label>
                        <div class="col-sm-8">
                            <div class="form-check">
                                <input type="checkbox" ng-model="ne_addressJson.ca_not_full_addres" class="form-check-input" id="ca_not_full_addres">
                                <label class="form-check-label" for="ca_not_full_addres">Not full address</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{!ne_addressJson.ca_not_full_addres ? '*' : ''}}Street:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="cn_addr_street" name="cn_addr_street" ng-model="ne_addressJson.cn_addr_street" ng-required="!ne_addressJson.ca_not_full_addres" ng-disabled="ne_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_street.$error.required && ( kcell_form.cn_addr_street.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{!ne_addressJson.ca_not_full_addres ? '*' : ''}}Building:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="cn_addr_building" name="cn_addr_building" ng-model="ne_addressJson.cn_addr_building" ng-required="!ne_addressJson.ca_not_full_addres" ng-disabled="ne_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_building.$error.required && ( kcell_form.cn_addr_building.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{ne_addressJson.ca_not_full_addres ? '*' : ''}}Cadastral number:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="cn_addr_cadastral_number" name="cn_addr_cadastral_number" ng-model="ne_addressJson.cn_addr_cadastral_number" ng-required="ne_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_cadastral_number.$error.required && ( kcell_form.cn_addr_cadastral_number.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{ne_addressJson.ca_not_full_addres ? '*' : ''}}Note to the address:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="cn_addr_note" name="cn_addr_note" ng-model="ne_addressJson.cn_addr_note" ng-required="ne_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_note.$error.required && ( kcell_form.cn_addr_note.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                </accordion-group>
            </accordion>
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">Farend name:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="fe_sitename" name="fe_sitename" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="farendSelected($item,$model,$label)" class="form-control" required autocomplete="off" placeholder="Farend Name">
                <input type="hidden" ng-model="fe_siteId" name="fe_siteId" required/>
            </div>
            <label class="error" ng-if="kcell_form.fe_sitename.$error.required && ( kcell_form.fe_sitename.$touched || view.submitted)">Required field</label>
            <label class="error" ng-if="kcell_form.fe_siteId.$error.required && ( kcell_form.fe_sitename.$touched || view.submitted)">Необходимо выбрать сайт из списка</label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Farend Address:</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="fe_address" cam-variable-name="fe_address" cam-variable-type="String" maxlength="1500" rows="2" disabled ng-if="!fe_siteId || fe_address_fetched"></textarea>
            <accordion class="content-visible-accordion background-yellow-accordion" ng-if="fe_siteId && !fe_address_fetched">
                <accordion-group is-open="true">
                    <accordion-heading>
                        Farend Address <i class="pull-right glyphicon"
                                          ng-class="{'glyphicon-chevron-up': status.isCustomHeaderOpen, 'glyphicon-chevron-down': !status.isCustomHeaderOpen}"></i>
                    </accordion-heading>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Oblast:</label>
                        <div class="col-sm-8" class="form-check">
                            <select class="form-control" id="fe_cn_addr_oblast" name="fe_cn_addr_oblast" ng-model="fe_addressJson.cn_addr_oblast"
                                    ng-change="filterDistrictAfterSelectOblFE(fe_addressJson.cn_addr_oblast)">
                                <option ng-repeat="oblast in oblastList" ng-value="oblast.id">{{oblast.value}}</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">District:</label>
                        <div class="col-sm-8" class="form-check">
                            <select class="form-control" id="fe_cn_addr_district" name="fe_cn_addr_district" ng-model="fe_addressJson.cn_addr_district" ng-disabled="!fe_addressJson.cn_addr_oblast">
                                <option ng-repeat="district in farendFilteredDistricts" ng-value="district.id">{{district.value}}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">City / Village:</label>
                        <div class="col-sm-8">
                            <input type="text" ng-model="fe_addressJson.cn_addr_city_name" name="fe_cn_addr_city" typeahead="city.value for city in getFarendCity($viewValue)" typeahead-on-select="fe_addressJsonCitySelected($item,$model,$label)" class="form-control" placeholder="Start typing...">
                            <input type="hidden" ng-model="fe_addressJson.cn_addr_city" name="feCityId" ng-required="fe_addressJson.cn_addr_city_name"/>
                            <label class="error" ng-show="kcell_form.feCityId.$error.required && ( kcell_form.cn_addr_city.$touched || view.submitted)">Please select from list</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label"></label>
                        <div class="col-sm-8">
                            <div class="form-check">
                                <input type="checkbox" ng-model="fe_addressJson.ca_not_full_addres" class="form-check-input" id="fe_ca_not_full_addres">
                                <label class="form-check-label" for="ca_not_full_addres">Not full address</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Street:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="fe_cn_addr_street" name="fe_cn_addr_street" ng-model="fe_addressJson.cn_addr_street" ng-disabled="fe_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_street.$error.required && ( kcell_form.cn_addr_street.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{!address.ca_not_full_addres ? '*' : ''}}Building:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="fe_cn_addr_building" name="fe_cn_addr_building" ng-model="fe_addressJson.cn_addr_building" ng-disabled="fe_addressJson.ca_not_full_addres">
                            <label class="error" ng-show="kcell_form.cn_addr_building.$error.required && ( kcell_form.cn_addr_building.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Cadastral number:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="fe_cn_addr_cadastral_number" name="fe_cn_addr_cadastral_number" ng-model="fe_addressJson.cn_addr_cadastral_number">
                            <label class="error" ng-show="kcell_form.cn_addr_cadastral_number.$error.required && ( kcell_form.cn_addr_cadastral_number.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">Note to the address:</label>
                        <div class="col-sm-8">
                            <input class="form-control" id="fe_cn_addr_note" name="fe_cn_addr_note" ng-model="fe_addressJson.cn_addr_note">
                            <label class="error" ng-show="kcell_form.cn_addr_note.$error.required && ( kcell_form.cn_addr_note.$touched || view.submitted)">Required field</label>
                        </div>
                    </div>
                </accordion-group>
            </accordion>
        </div>
    </div>

    <div class="form-group">
        <div class="col-sm-12">

            <table class="table table-bordered">
                <thead>
                <tr align="center">
                    <td colspan="2">Position</td>
                    <td colspan="4">Near End</td>
                    <td colspan="4">Far End</td>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td align="right" colspan="2">Basic information</td>
                    <td align="center" colspan="4">{{ne_sitename}}</td>
                    <td align="center" colspan="4">{{fe_sitename}}</td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Coordinates (degree):</td>
                    <td>N</td>
                    <td align="center">
                        <input type="text" class="form-control" ng-model="ne_latitude" id="ne_latitude" name="ne_latitude" ng-pattern="latitudePattern" ui-mask="N9.999999" ui-mask-placeholder ui-mask-placeholder-char="_"
                               required cam-variable-name="ne_latitude" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.ne_latitude.$error.required && ( kcell_form.ne_latitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.ne_latitude.$error.pattern && ( kcell_form.ne_latitude.$touched || view.submitted)">Expected: 40.568000 <- Latitude <- 55.440000</label>
                    </td>
                    <td>E</td>
                    <td align="center">
                        <input type="text" class="form-control" ng-model="ne_longitude" id="ne_longitude" name="ne_longitude" ng-pattern="longitudePattern" ui-mask="E9.999999" ui-mask-placeholder ui-mask-placeholder-char="_"
                               required cam-variable-name="ne_longitude" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.ne_longitude.$error.required && ( kcell_form.ne_longitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.ne_longitude.$error.pattern && ( kcell_form.ne_longitude.$touched || view.submitted)">Expected: 46.493000 <- Longtitude <- 87.315000</label>
                    </td>
                    <td>N</td>
                    <td align="center">
                        <input type="text" class="form-control" ng-model="fe_latitude" id="fe_latitude" name="fe_latitude" ng-pattern="latitudePattern" ui-mask="N9.999999"  ui-mask-placeholder ui-mask-placeholder-char="_"
                               required cam-variable-name="fe_latitude" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.fe_latitude.$error.required && ( kcell_form.fe_latitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.fe_latitude.$error.pattern && ( kcell_form.fe_latitude.$touched || view.submitted)">Expected: 40.568000 <- Latitude <- 55.440000</label>
                    </td>
                    <td>E</td>
                    <td align="center">
                        <input type="text" class="form-control" ng-model="fe_longitude" id="fe_longitude" name="fe_longitude" ng-pattern="longitudePattern" ui-mask="E9.999999" ui-mask-placeholder ui-mask-placeholder-char="_"
                               required cam-variable-name="fe_longitude" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.fe_longitude.$error.required && ( kcell_form.fe_longitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.fe_longitude.$error.pattern && ( kcell_form.fe_latitude.$touched || view.submitted)">Expected: 46.493000 <- Longtitude <- 87.315000</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Altitude (m):</td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="ne_altitude" name="ne_altitude" ng-pattern="numbersPattern" required cam-variable-name="ne_altitude" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.ne_altitude.$error.required && ( kcell_form.ne_altitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.ne_altitude.$error.pattern && ( kcell_form.ne_altitude.$touched || view.submitted)">Uncorrect format</label>
                    </td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="fe_altitude" name="fe_altitude" ng-pattern="numbersPattern" cam-variable-name="fe_altitude" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.fe_altitude.$error.required && ( kcell_form.fe_altitude.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.fe_altitude.$error.pattern && ( kcell_form.fe_altitude.$touched || view.submitted)">Uncorrect format</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Azimuth (degree):</td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="ne_azimuth" name="ne_azimuth" ng-pattern="azimuthPattern" cam-variable-name="ne_azimuth" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.ne_azimuth.$error.required && ( kcell_form.ne_azimuth.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.ne_azimuth.$error.pattern && ( kcell_form.ne_azimuth.$touched || view.submitted)">Uncorrect format</label>
                    </td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="fe_azimuth" name="fe_azimuth" ng-pattern="azimuthPattern" cam-variable-name="fe_azimuth" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.fe_azimuth.$error.required && ( kcell_form.fe_azimuth.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.fe_azimuth.$error.pattern && ( kcell_form.fe_azimuth.$touched || view.submitted)">Uncorrect format</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Path distance (m):</td>
                    <td align="center" colspan="8">
                        <input type="number" class="form-control" ng-model="path_distance" name="path_distance" cam-variable-name="path_distance" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.path_distance.$error.required && ( kcell_form.path_distance.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Type of construction:</td>
                    <td align="center" colspan="4">
                        <select class="form-control" id="ne_construction_type" name="ne_construction_type" ng-model="ne_construction_type" required>
                            <option ng-repeat="ct in constructionTypeList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.ne_construction_type.$error.required && ( kcell_form.ne_construction_type.$touched || view.submitted)">Required field</label>
                    </td>
                    <td align="center" colspan="4">
                        <select class="form-control" id="fe_construction_type" name="fe_construction_type" ng-model="fe_construction_type" required>
                            <option ng-repeat="ct in constructionTypeList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.fe_construction_type.$error.required && ( kcell_form.fe_construction_type.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>


                <tr>
                    <td align="right" colspan="2">Height of construction (m):</td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="ne_construction_height" name="ne_construction_height" required cam-variable-name="ne_construction_height" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.ne_construction_height.$error.required && ( kcell_form.ne_construction_height.$touched || view.submitted)">Required field</label>
                    </td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="fe_construction_height" name="fe_construction_height" required cam-variable-name="fe_construction_height" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.fe_construction_height.$error.required && ( kcell_form.fe_construction_height.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Protection mode:</td>
                    <td align="center" colspan="8">
                        <select class="form-control" id="protection_mode" name="protection_mode" ng-model="protection_mode" required>
                            <option ng-repeat="ct in protectionModeList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.protection_mode.$error.required && ( kcell_form.protection_mode.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Antenna diameter:</td>
                    <td align="center" colspan="4">
                        <select class="form-control" id="ne_diameter" name="ne_diameter" ng-model="ne_diameter" required>
                            <option ng-repeat="ct in trAntennasTypeList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.ne_diameter.$error.required && ( kcell_form.ne_diameter.$touched || view.submitted)">Required field</label>
                    </td>
                    <td align="center" colspan="4">
                        <select class="form-control" id="fe_diameter" name="fe_diameter" ng-model="fe_diameter" required>
                            <option ng-repeat="ct in trAntennasTypeList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.fe_diameter.$error.required && ( kcell_form.fe_diameter.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Protection antenna diameter:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Height of suspension of MW ant (m):</td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="ne_suspension_height_antennas" name="ne_suspension_height_antennas" required cam-variable-name="ne_suspension_height_antennas" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.ne_suspension_height_antennas.$error.required && ( kcell_form.ne_suspension_height_antennas.$touched || view.submitted)">Required field</label>
                    </td>
                    <td align="center" colspan="4">
                        <input type="number" class="form-control" ng-model="fe_suspension_height" name="fe_suspension_height" required  cam-variable-name="fe_suspension_height" cam-variable-type="String">
                        <label class="error" ng-if="kcell_form.fe_suspension_height.$error.required && ( kcell_form.fe_suspension_height.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Height of suspension of prot. MW ant (m).:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Polarization:</td>
                    <td align="center" colspan="8"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Link type:</td>
                    <td align="center" colspan="8"></td>
                </tr>
                <tr>
                    <td align="right" rowspan="2">Link capacity :</td>
                    <td align="right">Capacity</td>
                    <td align="center" colspan="8">
                        <select class="form-control" id="hop_link_capacity" name="hop_link_capacity" ng-model="hop_link_capacity" required ng-change="hopLinkCapacitySelected()">
                            <option ng-repeat="ct in linkCapacityList" ng-value="ct.id">{{ct.value}}</option>
                        </select>
                        <label class="error" ng-if="kcell_form.hop_link_capacity.$error.required && ( kcell_form.hop_link_capacity.$touched || view.submitted)">Required field</label>
                    </td>
                </tr>
                <tr>
                    <td align="right">nxE1</td>
                    <td align="center" colspan="8">
                        <input type="text" class="form-control" name="hop_link_nxe1" ng-model="hop_link_nxe1" ng-pattern="linkNxePattern" cam-variable-name="hop_link_nxe1" cam-variable-type="String" required>
                        <label class="error" ng-if="kcell_form.hop_link_nxe1.$error.required && ( kcell_form.hop_link_nxe1.$touched || view.submitted)">Required field</label>
                        <label class="error" ng-if="kcell_form.hop_link_nxe1.$error.pattern && ( kcell_form.hop_link_nxe1.$touched || view.submitted)">Incorrect value</label>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Modulation type:</td>
                    <td align="center" colspan="8">
                        <input type="text" class="form-control" name="hop_modulation_type" ng-model="hop_modulation_type" cam-variable-name="hop_modulation_type" cam-variable-type="String" required disabled>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Channel bandwidth:</td>
                    <td align="center" colspan="8">
                        <input type="text" class="form-control" name="hop_channel_bandwidth" ng-model="hop_channel_bandwidth" cam-variable-name="hop_channel_bandwidth" cam-variable-type="String" required disabled>
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">RAU subband:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">protection RAU subband:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Tx/Rx frequencies, Mhz:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Protection Tx/Rx frequencies, Mhz:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Terminal ID:</td>
                    <td align="center" colspan="4"></td>
                    <td align="center" colspan="4"></td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Power levels:</td>
                    <td>Tx</td>
                    <td align="center">
                    </td>
                    <td>Rx</td>
                    <td align="center">
                    </td>
                    <td>Tx</td>
                    <td align="center">
                    </td>
                    <td>Rx</td>
                    <td align="center">
                    </td>
                </tr>
                <tr>
                    <td align="right" colspan="2">Protection line power levels:</td>
                    <td>Tx</td>
                    <td align="center">
                    </td>
                    <td>Rx</td>
                    <td align="center">
                    </td>
                    <td>Tx</td>
                    <td align="center">
                    </td>
                    <td>Rx</td>
                    <td align="center">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label">Comments</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="comments" cam-variable-name="comments" cam-variable-type="String" maxlength="1500" rows="4"></textarea>
        </div>
    </div>
</form>
