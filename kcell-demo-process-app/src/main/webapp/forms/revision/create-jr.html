<style>
    .my-group .form-control{
        width:50%;
    }
    .modal-lg.modal-dialog{
        width: 90%;
    }

    .animate-if {
        background:white;
        overflow: hidden;
        transition: 0.4s;
        padding: 13px;
        margin-bottom: 0px;
        color: #b3b3b3;
        background-color: #fff;
        border: 2px solid #b3b3b3;
        border-radius: 0;
        -webkit-box-shadow: none;
        box-shadow: none;
    }

    .animate-if.ng-enter, .animate-if.ng-leave {
        transition:all 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) ;
    }

    .animate-if.ng-enter,
    .animate-if.ng-leave.ng-leave-active {
        opacity:0;
        max-height:0;
        padding-top: 0px;
        padding-bottom: 0px;
    }

    .animate-if.ng-leave,
    .animate-if.ng-enter.ng-enter-active {
        opacity:1;
        max-height: 500px;
        padding-top: 13px;
        padding-bottom: 13px;
    }
</style>
<form role="form" class="form-horizontal">
    <script cam-script type="text/form-script">
        inject([ '$scope', '$http', '$rootScope', '$q', function($scope, $http, $rootScope, $q) {
            console.log($rootScope);
            console.log(camForm);
            var variablesToCreate = [
                {
                    name: 'requestedDate',
                    type: 'Date',
                    submit: true,
                    store: false
                },
                {
                    name: 'validityDate',
                    type: 'Date',
                    value: new Date(),
                    store: true
                }, {
                    name: 'contract',
                    type: 'Integer',
                    submit: true,
                    store: true
                }, {
                    name: 'contractor',
                    type: 'Integer',
                    submit: true,
                    store: true
                }, {
                    name: 'materialsRequired',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'leasingRequired',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'powerRequired',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'worksBelongsTo',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'relatedTo',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'site',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'siteName',
                    type: 'String',
                    submit: true,
                    store: true
                }, {
                    name: 'jobWorks',
                    type: 'Json',
                    submit: true,
                    store: true
                },
                //TEST ONLY
                {
                    name: 'ptype',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'createJRResult',
                    type: 'String',
                    submit: true,
                    store: true
                },
                {
                    name: 'resolutions',
                    type: 'Json',
                    submit: true,
                    store: true,
                    value: []
                }
            ];

            $http.get('/camunda/api/engine/engine/default/task/' + camForm.taskId).then(
                function(result){
                    $scope.processInstanceId = result.data.processInstanceId;
                },
                function (error) {
                    console.log(error.data);
                }
            );

            $scope.showJump = false;

            if($rootScope.authentication.name === 'demo' || $rootScope.authentication.name === 'Yernaz.Kalingarayev@kcell.kz' || $rootScope.authentication.name === 'Askar.Slambekov@kcell.kz' || $rootScope.authentication.name === 'Anzor.Israilov@kcell.kz'){
                $scope.showJump = true;
            }

            camForm.on('form-loaded', function () {
                $scope.custom = {
                    contract: 1,
                    contractor: undefined
                };
                variablesToCreate.forEach(function (el) {
                    camForm.variableManager.fetchVariable(el.name);
                });

                $scope.soaComplaintIdCorrect = false;
                $http.get('/api/catalogs').then(
                        function(result){
                            angular.extend($scope, result.data);
                            $scope.conts = [];
                            if($scope.contracts){
                                for(var i=0;i<$scope.contracts.length;i++){
                                    if($scope.contracts[i].service.id === $scope.custom.contract){
                                        $scope.conts.push($scope.contracts[i].contractor);
                                    }
                                }
                            }
                        },
                        function(error){
                            console.log(error.data);
                        }
                );
            });

            camForm.on('variables-fetched', function () {
                variablesToCreate.forEach(function (el) {
                    if (camForm.variableManager.variables[el.name].type === undefined) {
                        camForm.variableManager.variables[el.name].type = el.type;
                        if(el.value){
                            camForm.variableManager.variables[el.name].value = el.value;
                        }
                    }
                    if(el.name === 'resolutions'){
                        if(!$scope.jobModel){
                            $scope.jobModel = {};
                        }
                        $scope.jobModel['resolutions'] = camForm.variableManager.variables[el.name].value;
                        $q.all($scope.jobModel.resolutions.map(function (resolution) {
                            return $http.get("/camunda/api/engine/engine/default/user/" + resolution.assignee + "/profile");
                        })).then(function (profiles) {
                            profiles.forEach(function (e, index) {
                                $scope.jobModel.resolutions[index].assigneeName = e.data.firstName ? e.data.firstName : "" + " " + e.data.lastName ? e.data.lastName : "";
                            });
                        });
                        $q.all($scope.jobModel.resolutions.map(function (resolution) {
                            return $http.get("/camunda/api/engine/engine/default/history/task?processInstanceId="+resolution.processInstanceId+"&taskId=" + resolution.taskId);
                        })).then(function (tasks) {
                            tasks.forEach(function (e, index) {
                                console.log(e.data);
                                $scope.jobModel.resolutions[index].taskName = e.data[0].name;
                                try {
                                    $scope.jobModel.resolutions[index].taskEndDate = new Date(e.data[0].endTime);
                                } catch(e){
                                    console.log(e);
                                }
                            })
                        });
                    }
                });
            });

            camForm.on('submit', function () {
                variablesToCreate.forEach(function (el) {
                    if (el.submit) {
                        camForm.variableManager.variableValue(el.name, $scope[el.name]);
                    }
                });
                if($scope.materialsRequiredCheckbox){
                    camForm.variableManager.variableValue('materialsRequired', 'Yes');
                } else {
                    camForm.variableManager.variableValue('materialsRequired', 'No');
                }
                if($scope.leasingRequiredCheckbox){
                    camForm.variableManager.variableValue('leasingRequired', 'Yes');
                } else {
                    camForm.variableManager.variableValue('leasingRequired', 'No');
                }
                if($scope.powerRequiredCheckbox){
                    camForm.variableManager.variableValue('powerRequired', 'Yes');
                } else {
                    camForm.variableManager.variableValue('powerRequired', 'No');
                }
                if($scope.ptypeCheckbox){
                    camForm.variableManager.variableValue('ptype', 'test');
                    camForm.variableManager.variableValue('createJRResult', "approved");
                } else {
                    camForm.variableManager.variableValue('ptype', 'prod');
                    camForm.variableManager.variableValue('createJRResult', "approved");
                }
                if($scope.explanation){
                    if(!$scope.resolutions){
                        $scope.resolutions = {};
                    }
                    $scope.resolutions.push({processInstanceId: $scope.processInstanceId, assignee: $rootScope.authentication.name, resolution: 'createJr', comment: $scope.explanation, taskId: camForm.taskId});
                    camForm.variableManager.variableValue('resolutions', $scope.resolutions);
                }
                var validityDate = new Date($scope.validityDate);
                camForm.variableManager.variableValue('validityDate', validityDate);
                camForm.variableManager.variableValue('contract', parseInt($scope.custom.contract));
                camForm.variableManager.variableValue('contractor', parseInt($scope.custom.contractor));
                //camForm.variableManager.variableValue('relatedTo', parseInt($scope.relatedTo));
                camForm.variableManager.variableValue('jobWorks', JSON.parse(angular.toJson($scope.jobWorks)));
                for (var i = 0; i < camForm.fields.length; i++) {
                    if (camForm.fields[i].variableName == 'supplementaryFile1') {
                        if (camForm.fields[i].element.context.value == '') {
                            camForm.fields.splice(i, 1);
                            camForm.variableManager.destroyVariable('supplementaryFile1');
                        }
                    }
                }
                for (var i = 0; i < camForm.fields.length; i++) {
                    if (camForm.fields[i].variableName == 'supplementaryFile2') {
                        if (camForm.fields[i].element.context.value == '') {
                            camForm.fields.splice(i, 1);
                            camForm.variableManager.destroyVariable('supplementaryFile2');
                        }
                    }
                }
                for (var i = 0; i < camForm.fields.length; i++) {
                    if (camForm.fields[i].variableName == 'supplementaryFile3') {
                        if (camForm.fields[i].element.context.value == '') {
                            camForm.fields.splice(i, 1);
                            camForm.variableManager.destroyVariable('supplementaryFile3');
                        }
                    }
                }
                for (var i = 0; i < camForm.fields.length; i++) {
                    if (camForm.fields[i].variableName == 'supplementaryFile4') {
                        if (camForm.fields[i].element.context.value == '') {
                            camForm.fields.splice(i, 1);
                            camForm.variableManager.destroyVariable('supplementaryFile4');
                        }
                    }
                }
                for (var i = 0; i < camForm.fields.length; i++) {
                    if (camForm.fields[i].variableName == 'supplementaryFile5') {
                        if (camForm.fields[i].element.context.value == '') {
                            camForm.fields.splice(i, 1);
                            camForm.variableManager.destroyVariable('supplementaryFile5');
                        }
                    }
                }
            });

            $scope.open = open;
            $scope.toggleJr = toggleJr;
            $scope.getJobs = getJobs;
            $scope.addJobWork = addJobWork;
            $scope.showMoreJobRequests = showMoreJobRequests;
            $scope.refreshJobRequests = refreshJobRequests;
            $scope.showMore = false;
            $scope.page = 0;
            $scope.jobRequestsCount = 0;
            $scope.fileSelected = fileSelected;
            $scope.download = download;
            $scope.removeWork = removeWork;
            $scope.serviceChanged = serviceChanged;
            $scope.jobWorks = [{}];
            $scope.jobRequests = {};

            var currentDate = new Date();

            $scope.datepickerOptions = {
                minDate: currentDate
            }

            function removeWork(index){
                $scope.jobWorks.splice(index,1);
            }

            function toggleJr(index){
                if($scope.jrIndex === index){
                    $scope.jrIndex = undefined;
                } else {
                    $scope.jrIndex = index;
                }
            }

            function open($event) {
                $event.preventDefault();
                $event.stopPropagation();
                $scope.dateFieldOpened = true;
            };

            function getJobs(){
                var query = {
                    "processDefinitionKey" : "Revision",
                    "active" : true,
                    "variables" :
                        [{
                            "name": "reason",
                            "operator": "eq",
                            "value": $scope.reason
                        }]
                };
                var path  = '/camunda/api/engine/engine/default/process-instance?firstResult='+($scope.page*5)+'&maxResults=5';
                $http.post(path,query).then(
                    function(result){
                        $scope.page = $scope.page + 1;
                        var piIds = [];
                        if(result.data.length < 5){
                            $scope.showMore = false;
                        } else {
                            $scope.showMore = true;
                        }
                        for(var i=0;i<result.data.length;i++){
                            piIds.push(result.data[i].id);
                        }
                        var variableQuery = {
                            processInstanceIdIn: piIds
                        };
                        if(piIds.length > 0){
                            $http.post('/camunda/api/engine/engine/default/variable-instance?deserializeValues=false', variableQuery).then(
                                function(variables){
                                    for(var i=0;i<variables.data.length;i++){
                                        if(!$scope.jobRequests[variables.data[i].processInstanceId]){
                                            $scope.jobRequestsCount++;
                                            $scope.jobRequests[variables.data[i].processInstanceId] = {};
                                        }
                                        if(variables.data[i].name === 'jobWorks'){
                                            $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = JSON.parse(variables.data[i].value);
                                        } else if(variables.data[i].name === 'supplementaryFile1' || variables.data[i].name === 'supplementaryFile2' || variables.data[i].name === 'supplementaryFile3' || variables.data[i].name === 'supplementaryFile4' || variables.data[i].name === 'supplementaryFile5'){
                                            $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i];
                                        }
                                        else {
                                            $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i].value;
                                        }

                                    }
                                },
                                function(error){
                                    console.log(error);
                                }
                            );
                        }
                    },
                    function(error){
                        console.log(error);
                    }
                );
            }

            function addJobWork(){
                $scope.jobWorks.push({});
            }

            function showMoreJobRequests(){
                getJobs();
            }

            function refreshJobRequests(){
                $scope.page = 0;
                $scope.jobRequestsCount = 0;
                $scope.jobRequests = {};
                getJobs();
            }

            function fileSelected(el, index){
                $scope['supplementaryFileSelected'+index] = (el.value !== '');
            }

            function download(file){
                document.getElementById('fileDownloadIframe').src = '/camunda/api/engine/engine/default/variable-instance/'+file.id+'/data';
            }

            function serviceChanged(){
                $scope.conts = [];
                if($scope.contracts){
                    for(var i=0;i<$scope.contracts.length;i++){
                        if($scope.contracts[i].service.id == $scope.custom.contract){
                            $scope.conts.push($scope.contracts[i].contractor);
                        }
                    }
                }
            }

            camForm.on('variables-applied', function() {
		        var validityDate = camForm.variableManager.variableValue('validityDate');
		        $scope.validityDate = new Date(validityDate);
		    });

            camForm.on('store', function() {
                variablesToCreate.forEach(function (el) {
                    if (el.store) {
                        camForm.variableManager.variableValue(el.name, $scope[el.name]);
                    }
                });

                var validityDate = new Date($scope.validityDate);
                camForm.variableManager.variableValue('validityDate', validityDate);
                camForm.variableManager.variableValue('contract', parseInt($scope.custom.contract));
                camForm.variableManager.variableValue('contractor', parseInt($scope.custom.contractor));
                //camForm.variableManager.variableValue('relatedTo', parseInt($scope.relatedTo));
                camForm.variableManager.variableValue('jobWorks', JSON.parse(angular.toJson($scope.jobWorks)));
            });

            camForm.on('variables-restored', function() {
                variablesToCreate.forEach(function (el) {
                    if (el.store) {
                        $scope[el.name] = camForm.variableManager.variableValue(el.name);
                    }
                });
                $scope['validityDate'] = camForm.variableManager.variableValue('validityDate');
                if(camForm.variableManager.variableValue('contract')){
                    $scope.custom.contract = parseInt(camForm.variableManager.variableValue('contract'));
                }
                if(camForm.variableManager.variableValue('contractor')){
                    $scope.custom.contractor = parseInt(camForm.variableManager.variableValue('contractor'));
                }
                /*if(camForm.variableManager.variableValue('relatedTo')){
                    $scope.relatedTo = parseInt(camForm.variableManager.variableValue('relatedTo'));
                }*/
                try{
                    $scope.requestedDate = new Date(camForm.variableManager.variableValue('requestedDate'));
                } catch(e){}
                try{
                    if(camForm.variableManager.variableValue('jobWorks')){
                        $scope.jobWorks = JSON.parse(angular.toJson(camForm.variableManager.variableValue('jobWorks')));
                    } else {
                        $scope.jobWorks = [{}];
                    }
                } catch(e){
                    $scope.jobWorks = [{}];
                }
                //$scope.reason = camForm.variableManager.variableValue('reason');
                refreshJobRequests();
                serviceChanged();
            });

            $scope.getUnits = function(index){
                for(var i=0;i<$scope.works.length;i++){
                    if($scope.jobWorks[index].sapServiceNumber === $scope.works[i].sapServiceNumber){
                        $scope.jobWorks[index].materialUnit = $scope.works[i].units;
                    }
                }
            };

            $scope.getSite = function(val) {
                return $http.get('/asset-management/api/sites/search/findByNameIgnoreCaseContaining?name='+val).then(
                    function(response){
                        console.log(response);
                        var sites = response.data._embedded.sites.map(function(site){
                            var site = {
                                name: site.name,
                                id: site._links.self.href.substring(site._links.self.href.lastIndexOf('/')+1)
                            };
                            console.log(site);
                            return site;
                        });
                        console.log(sites);
                        return sites;
                    }
                );
            };

            $scope.siteSelected = function($item){
                $scope.siteName = $item.name;
                $scope.site = $item.id;
            };

            $scope.clearSiteId = function(){
                $scope.site = undefined;
            };

            $scope.siteJobWorkSelected = function($item, $index){
                $scope.jobWorks[$index].sites.name = $item.name;
                $scope.jobWorks[$index].sites.id = $item.id;
            };
            $scope.clearWorkSiteId = function($index){
                if(!$scope.jobWorks[$index].sites){
                    $scope.jobWorks[$index].sites = {id:undefined};
                }
                $scope.jobWorks[$index].sites.id = undefined;
            }
        }]);


    </script>
    <h4>Create job request</h4>
    <div class="form-group">
        <label class="col-sm-4 control-label">Requested date*</label>
        <div class="col-sm-3">
            <div class="form-control">{{requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Validity date*:</label>
        <div class="col-sm-3">
            <div class="input-group">
                <input type="text" ng-model="validityDate" required class="form-control" datepicker-popup="dd.MM.yyyy" is-open="dateFieldOpened" id="validityDate" min-date="datepickerOptions.minDate" />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="open($event)">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">SA&O Complaint Id:</label>
        <div class="col-sm-3">
            <input type="text" cam-variable-name="soaComplaintId" cam-variable-type="String" class="form-control" ng-blur="checkSOAComplaintId()" maxlength="20"/>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Site *: {{siteObject}}</label>
        <div class="col-sm-3">
            <input type="text" ng-model="siteName" typeahead="site as sites.name for sites in getSite($viewValue) | filter:$viewValue" typeahead-on-select="siteSelected($item,$model,$label)" class="form-control" required>
            <input type="hidden" ng-model="site" required/>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Reason*:</label>
        <div class="col-sm-3">
            <select class="form-control" cam-variable-name="reason" required cam-variable-type="String" ng-change="refreshJobRequests()">
                <option value="">select reason</option>
                <option value="{{r.id}}" ng-repeat="r in reasons" ng-selected="{{r.id == reason}}">{{r.name}}</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Related to the:</label>
        <div class="col-sm-8">
            <label class="radio-inline">
                <input type="radio" name="relatedTo" required ng-model="relatedTo" value="Capacity"> Capacity
            </label>
            <label class="radio-inline">
                <input type="radio" name="relatedTo" required ng-model="relatedTo" value="Coverage"> Coverage
            </label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Contractor*:</label>
        <div class="col-sm-8">
            <div ng-if="conts.length == 0 || conts == undefined">Please select Contract</div>
            <!-- NOT REQUIRED -->
            <label class="radio-inline" ng-repeat="c in conts">
                <input type="radio" name="contractor" ng-model="custom.contractor" id="contractor{{$index}}" value="{{c.id}}" required> {{c.name}}
            </label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Type of project:</label>
        <div class="col-sm-3">
            <select cam-variable-name="project" cam-variable-type="String" class="form-control" required>
                <option value="Astana Expo 2017">Astana Expo 2017</option>
                <option value="N/A">N/A</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label required">Works belongs to KZT, Beeline, ODS*:</label>
        <div class="col-sm-8">
            <!-- NOT REQUIRED -->
            <label class="radio-inline">
                <input type="radio" name="worksBelongsTo" ng-model="worksBelongsTo" id="worksBelongsTo1" value="Yes" required> Yes
            </label>
            <label class="radio-inline">
                <input type="radio" name="worksBelongsTo" ng-model="worksBelongsTo" id="worksBelongsTo2" value="No" required> No
            </label>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Supplementary files:</label>
        <div class="col-sm-8">
            <input type="file" class="form-control" cam-variable-type="File" cam-max-filesize="10000000" cam-variable-name="supplementaryFile1"  onchange="angular.element(this).scope().fileSelected(this, 1)" />
            <div ng-show="supplementaryFileSelected1">
                <input type="file" class="form-control" cam-variable-type="File" cam-max-filesize="10000000" cam-variable-name="supplementaryFile2" onchange="angular.element(this).scope().fileSelected(this, 2)"/>
            </div>
            <div ng-show="supplementaryFileSelected2">
                <input type="file" class="form-control" cam-variable-type="File" cam-max-filesize="10000000" cam-variable-name="supplementaryFile3" onchange="angular.element(this).scope().fileSelected(this, 3)"/>
            </div>
            <div ng-show="supplementaryFileSelected3">
                <input type="file" class="form-control" cam-variable-type="File" cam-max-filesize="10000000" cam-variable-name="supplementaryFile4" onchange="angular.element(this).scope().fileSelected(this, 4)"/>
            </div>
            <div ng-show="supplementaryFileSelected4">
                <input type="file" class="form-control" cam-variable-type="File" cam-max-filesize="10000000" cam-variable-name="supplementaryFile5" onchange="angular.element(this).scope().fileSelected(this, 5)"/>
            </div>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Running job requests for these sites ({{jobRequestsCount}} JRs)</label>
        <div class="col-sm-8">
            <div ng-repeat="(k,job) in jobRequests">
                <a ng-click="toggleJr($index)">JR No. XYZ{{$index+1}}, Reason: {{reasonsTitle[job.reason]}}, Created at: {{job.requestedDate | date: 'dd.MM.yyyy'}}</a>
                <div ng-if="jrIndex === $index" class="animate-if" ng-animate-children>
                    <div class="row">
                        <div class="col-md-4">Requested date: {{job.requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
                        <div class="col-md-4">Reason: {{reasonsTitle[job.reason]}}</div>
                        <div class="col-md-4">Materials required: {{job.materialsRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">Validity date: {{job.validityDate | date: 'dd.MM.yyyy'}}</div>
                        <div class="col-md-4">Contract: {{servicesTitle[job.contract]}}</div>
                        <div class="col-md-4">Leasing required: {{job.leasingRequired}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">SA&O Complaint Id: {{job.soaComplaintId}}</div>
                        <div class="col-md-4">Contractor: {{contractorsTitle[job.contractor]}}</div>
                        <div class="col-md-4">Site (near end): {{job.site}}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">Supplementary files:</div>
                        <iframe id="fileDownloadIframe" style="display:none;"></iframe>
                        <div class="col-md-12"><a ng-if="job.supplementaryFile1" ng-click="download(job.supplementaryFile1)">{{job.supplementaryFile1.valueInfo.filename}}</a></div>
                        <div class="col-md-12"><a ng-if="job.supplementaryFile2" ng-click="download(job.supplementaryFile2)">{{job.supplementaryFile2.valueInfo.filename}}</a></div>
                        <div class="col-md-12"><a ng-if="job.supplementaryFile3" ng-click="download(job.supplementaryFile3)">{{job.supplementaryFile3.valueInfo.filename}}</a></div>
                        <div class="col-md-12"><a ng-if="job.supplementaryFile4" ng-click="download(job.supplementaryFile4)">{{job.supplementaryFile4.valueInfo.filename}}</a></div>
                        <div class="col-md-12"><a ng-if="job.supplementaryFile5" ng-click="download(job.supplementaryFile5)">{{job.supplementaryFile5.valueInfo.filename}}</a></div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">Works:</div>
                        <div class="col-md-12" ng-repeat="work in job.jobWorks">
                            <a href="javascript:void(0)">{{$index+1}}. {{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{unitsTitle[work.unit]}}, on sites: {{work.sites}} (Near end)</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">{{work.explanation}}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <button type="button" ng-click="showMoreJobRequests()" class="btn btn-sm btn-primary" ng-disabled="!showMore"><i class="glyphicon glyphicon-th-list"></i> <span ng-if="showMore">Show more</span><span ng-if="!showMore">No more similar job requests</span></span></button>
            </div>
        </div>
    </div>
    <h4>Works</h4>
    <div class="col-sm-12">
        <div class="row" ng-repeat="jobWork in jobWorks">
            <div class="col-md-3" style="padding:0px">
                <select ng-model="jobWork.sapServiceNumber" required class="form-control" ng-change="getUnits($index)">
                    <option ng-repeat="work in works" ng-selected="{{work.sapServiceNumber == jobWork.sapServiceNumber}}" value="{{work.sapServiceNumber}}">{{work.sapPOServiceName}}</option>
                </select>
            </div>
            <div class="col-md-2" style="padding:0px">
                <div class="input-group">
                    <span class="input-group-addon" style="padding-right:5px; background-color: #fff;border: 1px solid #fff;">Works Qty</span>
                    <input type="number" class="form-control" required ng-model="jobWork.quantity" min="1"/>
                </div>
            </div>
            <div class="col-md-4" style="padding:0px">
                <div class="input-group">
                    <span class="input-group-addon" style="padding-right:5px; background-color: #fff;border: 1px solid #fff;">Materials Qty</span>
                    <input type="number" class="form-control" required ng-model="jobWork.materialQuantity" min="1" required/>
                    <span class="input-group-addon">{{jobWork.materialUnit}}</span>
                </div>
            </div>
            <div class="col-md-2" ng-if="reason == '2'" style="padding:0px">
                <input type="text" ng-model="jobWork.sites.name" typeahead="site as sites.name for sites in getSite($viewValue) | filter:$viewValue" typeahead-on-select="siteJobWorkSelected($item,$index)" class="form-control">
                <input type="hidden" ng-model="jobWork.sites.id" ng-required="jobWork.sites.name" />
            </div>
            <div class="col-md-1"><button type="button" class="btn btn-sm btn-warning" ng-if="$index !== 0" ng-click="removeWork($index)"><i class="glyphicon glyphicon-trash"></i> Remove</button></div>
        </div>
        <div class="row">
            <button type="button" class="btn btn-sm btn-primary" ng-click="addJobWork()"><i class="glyphicon glyphicon-plus"></i> Add work</button>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Materials required*:</label>
        <div class="col-sm-8">
            <input type="checkbox" class="form-control" cam-variable-name="materialsRequiredCheckbox" cam-variable-type="Boolean" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Leasing required*:</label>
        <div class="col-sm-8">
            <input type="checkbox" class="form-control" cam-variable-name="leasingRequiredCheckbox" cam-variable-type="Boolean" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Power engineering required*:</label>
        <div class="col-sm-8">
            <input type="checkbox" class="form-control" cam-variable-name="powerRequiredCheckbox" cam-variable-type="Boolean" />
        </div>
    </div>
    <div class="form-group" ng-show="showJump">
        <label class="col-sm-4 control-label"><b>Jump to Fill applied changed (test only)</b>*:</label>
        <div class="col-sm-8">
            <input type="checkbox" class="form-control" cam-variable-name="ptypeCheckbox" cam-variable-type="Boolean" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-4 control-label">Explanation of works *</label>
        <div class="col-sm-8">
            <!-- NOT REQUIRED -->
            <textarea class="form-control" cam-variable-name="explanation" cam-variable-type="String" placeholder="Explanation of works..." maxlength="500" rows="4" required></textarea>
        </div>
    </div>
    <accordion ng-if="jobModel.resolutions.length > 0">
        <accordion-group>
            <accordion-heading>
                History <i class="pull-right glyphicon" ng-class="{'glyphicon-chevron-up': status.isCustomHeaderOpen, 'glyphicon-chevron-down': !status.isCustomHeaderOpen}"></i>
            </accordion-heading>
            <table class="table">
                <thead>
                <tr>
                    <th>Activity</th>
                    <th>Assignee</th>
                    <th>Resolution</th>
                    <th>Date</th>
                    <th>Comment</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="resolution in jobModel.resolutions">
                    <td>{{resolution.taskName}}</td>
                    <td>{{resolution.assigneeName}}</td>
                    <td>{{'task.resolution.'+resolution.resolution | translate}}</td>
                    <td>{{resolution.taskEndDate | date: 'dd.MM.yyyy HH:mm'}}</td>
                    <td>{{resolution.comment}}</td>
                </tr>
                </tbody>
            </table>
        </accordion-group>
    </accordion>
</form>