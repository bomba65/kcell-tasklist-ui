<style>
    .my-group .form-control{
        width:50%;
    }
    .modal-lg.modal-dialog{
        width: 90%;
    }

    .animate-if {
        background:white;
        overflow: hidden;
        transition: 0.4s;
        padding: 13px;
        margin-bottom: 0px;
        color: #b3b3b3;
        background-color: #fff;
        border: 2px solid #b3b3b3;
        border-radius: 0;
        -webkit-box-shadow: none;
        box-shadow: none;
    }

    .animate-if.ng-enter, .animate-if.ng-leave {
        transition:all 0.3s cubic-bezier(0.250, 0.460, 0.450, 0.940) ;
    }

    .animate-if.ng-enter,
    .animate-if.ng-leave.ng-leave-active {
        opacity:0;
        max-height:0;
        padding-top: 0px;
        padding-bottom: 0px;
    }

    .animate-if.ng-leave,
    .animate-if.ng-enter.ng-enter-active {
        opacity:1;
        max-height: 500px;
        padding-top: 13px;
        padding-bottom: 13px;
    }
</style>
<div class="col-md-12">
    <form role="form" class="form-horizontal" name="kcell_form" novalidate>
        <script cam-script type="text/form-script">
            inject([ '$scope', '$http', '$rootScope', '$q', function($scope, $http, $rootScope, $q) {
                $scope.regionsMap = {
                    '0': 'Alm',
                    '11':'Astana',
                    '1': 'N&C',
                    '2': 'N&C',
                    '3': 'East',
                    '4': 'South',
                    '5': 'West',
                    '6': 'West',
                    '7': 'West',
                    '8': 'West'
                };
                $scope.contractorShortName = {
                    '4': 'LSE'
                };
                $scope.reasonShortName = {
                    '1': 'P&O',
                    '2': 'TNU',
                    '3': 'S&FM',
                    '4': 'SAO'
                };

                $scope.requestedDate = new Date();

                $scope.getSite = function(val) {
                    return $http.get('/asset-management/api/sites/search/findByNameIgnoreCaseContaining?name='+val).then(
                            function(response){
                                var sites = response.data._embedded.sites.map(function(site){
                                    var site = {
                                        name: site.name,
                                        id: site._links.self.href.substring(site._links.self.href.lastIndexOf('/')+1),
                                        site_name: (site.params?site.params.site_name:'')
                                    };
                                    return site;
                                });
                                return sites;
                            }
                    );
                };

                $scope.siteSelected = function($item){
                    $scope.siteName = $item.name;
                    $scope.site = $item.id;
                    $scope.site_name = $item.site_name;
                    $scope.jrNumber = "";
                    if($scope.siteName.startsWith('11')){
                        $scope.regionShortName = $scope.regionsMap['11'];
                    } else {
                        $scope.regionShortName = $scope.regionsMap[$scope.siteName.substring(0,1)];
                    }

                    $http.get('/asset-management/sitecounter/' + $scope.site).then(
                        function(result){
                            var s = result.data+"";
                            while (s.length < 4) s = "0" + s;
                            $scope.siteCounter = s;
                        },
                        function(error){
                        }
                    );
                    refreshJobRequests();
                };

                $scope.clearSiteId = function(){
                    $scope.site = undefined;
                };

                $scope.custom = {
                    contract: 1,
                    contractor: undefined
                };

                $http.get('/api/catalogs').then(
                        function(result){
                            angular.extend($scope, result.data);
                            $scope.conts = [];
                            if($scope.contracts){
                                for(var i=0;i<$scope.contracts.length;i++){
                                    if($scope.contracts[i].service.id === $scope.custom.contract){
                                        $scope.conts.push($scope.contracts[i].contractor);
                                    }
                                }
                            }
                        },
                        function(error){
                            console.log(error.data);
                        }
                );

                camForm.on('form-loaded', function () {
                    camForm.variableManager.createVariable({
                        name: 'site_name',
                        type: 'String',
                        value: ''
                    });
                    camForm.variableManager.createVariable({
                        name: 'siteName',
                        type: 'String',
                        value: ''
                    });
                    camForm.variableManager.createVariable({
                        name: 'site',
                        type: 'String',
                        value: ''
                    });
                    camForm.variableManager.createVariable({
                        name: 'jrNumber',
                        type: 'String',
                        value: ''
                    });
                    camForm.variableManager.createVariable({
                        name: 'contractor',
                        type: 'Integer',
                        value: ''
                    });
                });

                camForm.on('submit', function (e) {
                    var jrn = $scope.regionShortName+'-'+$scope.contractorShortName[$scope.custom.contractor]+'-'+$scope.reasonShortName[$scope.reason]+'-'+$scope.requestedDate.getFullYear().toString().substr(-2)+'-'+$scope.siteCounter;
                    camForm.variableManager.variableValue('jrNumber', jrn);
                    camForm.variableManager.variableValue('site_name', $scope.site_name);
                    camForm.variableManager.variableValue('site', $scope.site);
                    camForm.variableManager.variableValue('siteName', $scope.siteName);
                    camForm.variableManager.variableValue('contractor', parseInt($scope.custom.contractor));
                    camForm.businessKey = jrn;
                });
                $scope.showMoreJobRequests = showMoreJobRequests;
                $scope.refreshJobRequests = refreshJobRequests;
                $scope.jobRequestsCount = 0;
                $scope.jobRequests = {};

                function getJobs(){
                    var query = {
                        "processDefinitionKey" : "Revision",
                        "active" : true,
                        "variables" :
                                [{
                                    "name": "reason",
                                    "operator": "eq",
                                    "value": $scope.reason
                                },{
                                    "name": "site",
                                    "operator": "eq",
                                    "value" : $scope.site
                                }]
                    };
                    var path  = '/camunda/api/engine/engine/default/process-instance?firstResult='+($scope.page*5)+'&maxResults=5';
                    $http.post(path,query).then(
                            function(result){
                                $scope.page = $scope.page + 1;
                                var piIds = [];
                                if(result.data.length < 5){
                                    $scope.showMore = false;
                                } else {
                                    $scope.showMore = true;
                                }
                                for(var i=0;i<result.data.length;i++){
                                    piIds.push(result.data[i].id);
                                }
                                var variableQuery = {
                                    processInstanceIdIn: piIds
                                };
                                if(piIds.length > 0){
                                    $http.post('/camunda/api/engine/engine/default/variable-instance?deserializeValues=false', variableQuery).then(
                                            function(variables){
                                                for(var i=0;i<variables.data.length;i++){
                                                    if(!$scope.jobRequests[variables.data[i].processInstanceId]){
                                                        $scope.jobRequestsCount++;
                                                        $scope.jobRequests[variables.data[i].processInstanceId] = {};
                                                    }
                                                    if(variables.data[i].name === 'jobWorks'){
                                                        $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = JSON.parse(variables.data[i].value);
                                                    } else if(variables.data[i].name === 'supplementaryFile1' || variables.data[i].name === 'supplementaryFile2' || variables.data[i].name === 'supplementaryFile3' || variables.data[i].name === 'supplementaryFile4' || variables.data[i].name === 'supplementaryFile5'){
                                                        $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i];
                                                    } else if(variables.data[i].name === 'initiatorFull'){
                                                        $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = JSON.parse(variables.data[i].value);
                                                    } else {
                                                        $scope.jobRequests[variables.data[i].processInstanceId][variables.data[i].name] = variables.data[i].value;
                                                    }

                                                }
                                            },
                                            function(error){
                                                console.log(error);
                                            }
                                    );
                                }
                            },
                            function(error){
                                console.log(error);
                            }
                    );
                }

                function showMoreJobRequests(){
                    getJobs();
                }

                function refreshJobRequests(){
                    $scope.page = 0;
                    $scope.jobRequestsCount = 0;
                    $scope.jobRequests = {};
                    getJobs();
                }

                $scope.toggleJr = function(index){
                    if($scope.jrIndex === index){
                        $scope.jrIndex = undefined;
                    } else {
                        $scope.jrIndex = index;
                    }
                }
            }]);
        </script>
        <div class="form-group">
            <label class="col-sm-3 control-label required">JR Number:</label>
            <div class="col-sm-3">
                <div class="form-control">
                    <span ng-if="jrNumber">{{jrNumber}}</span>
                    <span ng-if="!jrNumber">{{regionShortName?regionShortName:'###'}}-{{contractorShortName[custom.contractor]?contractorShortName[custom.contractor]:'###'}}-{{reasonShortName[reason]?reasonShortName[reason]:'###'}}-{{requestedDate.getFullYear().toString().substr(-2)}}-{{siteCounter?siteCounter:'###'}}</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label required">Site *: {{siteObject}}</label>
            <div class="col-sm-3">
                <input type="text" ng-model="siteName" name="siteName" typeahead="site as sites.name for sites in getSite($viewValue) | filter:$viewValue" typeahead-on-select="siteSelected($item,$model,$label)" class="form-control" required autocomplete="off">
                <input type="hidden" ng-model="site" name="siteId" required/>
                <label class="error" ng-if="kcell_form.siteName.$error.required && ( kcell_form.siteName.$touched || view.submitted)">Required field</label>
                <label class="error" ng-if="kcell_form.siteId.$error.required && ( kcell_form.siteName.$touched || view.submitted)">Необходимо выбрать сайт из списка</label>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label required">Site Name: </label>
            <div class="col-sm-3">
                <input type="text" class="form-control" ng-model="site_name" name="site_name" />
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label required">Reason*:</label>
            <div class="col-sm-3">
                <select class="form-control" cam-variable-name="reason" name="reason" ng-required="true" cam-variable-type="String" ng-change="refreshJobRequests()">
                    <option value="">select reason</option>
                    <option value="{{r.id}}" ng-repeat="r in reasons" ng-selected="{{r.id == reason}}">{{r.name}}</option>
                </select>
                <label class="error" ng-if="kcell_form.reason.$error.required && ( kcell_form.reason.$touched || view.submitted)">Required field</label>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label required">Contractor*:</label>
            <div class="col-sm-8">
                <div ng-if="conts.length == 0 || conts == undefined">Please select Contract</div>
                <label class="radio-inline" ng-repeat="c in conts">
                    <input type="radio" name="contractor" ng-model="custom.contractor" id="contractor{{$index}}" value="{{c.id}}" required> {{c.name}}
                </label>
                <label class="error" ng-if="kcell_form.contractor.$error.required && ( kcell_form.contractor.$touched || view.submitted)">Required field</label>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-12 control-label">Running job requests for these sites ({{jobRequestsCount}} JRs)</label>
            <div class="col-sm-12">
                <div ng-repeat="(k,job) in jobRequests">
                    <a ng-click="toggleJr($index)">JR No. {{job.jrNumber}}, Reason: {{reasonsTitle[job.reason]}}, Created at: {{job.requestedDate | date: 'dd.MM.yyyy'}}</a>
                    <div ng-if="jrIndex === $index" class="animate-if" ng-animate-children>
                        <div class="row">
                            <div class="col-md-4"><b>Initiator</b>: {{job.initiatorFull.firstName}} {{job.initiatorFull.lastName}}</div>
                            <div class="col-md-8"><b>JR Number</b>: {{job.jrNumber}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4"><b>Requested date</b>: {{job.requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
                            <div class="col-md-4"><b>Reason</b>: {{reasonsTitle[job.reason]}}</div>
                            <div class="col-md-4"><b>Materials required</b>: {{job.materialsRequired}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4"><b>Validity date</b>: {{job.validityDate.value | date: 'dd.MM.yyyy'}}</div>
                            <div class="col-md-4"><b>Contract</b>: {{servicesTitle[job.contract]}}</div>
                            <div class="col-md-4"><b>Leasing required</b>: {{job.leasingRequired}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4"><b>SA&O Complaint Id</b>: {{job.soaComplaintId}}</div>
                            <div class="col-md-4"><b>Contractor</b>: {{contractorsTitle[job.contractor]}}</div>
                            <div class="col-md-4"><b>Site (near end)</b>: {{job.siteName}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4"><b>Power engineering required</b>: {{job.powerRequired}}</div>
                            <div class="col-md-4"><b>Project</b>: {{job.project}}</div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">Requested date: {{job.requestedDate | date: 'dd.MM.yyyy HH:mm'}}</div>
                            <div class="col-md-4">Reason: {{reasonsTitle[job.reason]}}</div>
                            <div class="col-md-4">Materials required: {{job.materialsRequired}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">Validity date: {{job.validityDate | date: 'dd.MM.yyyy'}}</div>
                            <div class="col-md-4">Contract: {{servicesTitle[job.contract]}}</div>
                            <div class="col-md-4">Leasing required: {{job.leasingRequired}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">SA&O Complaint Id: {{job.soaComplaintId}}</div>
                            <div class="col-md-4">Contractor: {{contractorsTitle[job.contractor]}}</div>
                            <div class="col-md-4">Site (near end): {{job.siteName}}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">Supplementary files:</div>
                            <iframe id="fileDownloadIframe" style="display:none;"></iframe>
                            <div class="col-md-12"><a ng-if="job.supplementaryFile1" ng-click="download(job.supplementaryFile1)">{{job.supplementaryFile1.valueInfo.filename}}</a></div>
                            <div class="col-md-12"><a ng-if="job.supplementaryFile2" ng-click="download(job.supplementaryFile2)">{{job.supplementaryFile2.valueInfo.filename}}</a></div>
                            <div class="col-md-12"><a ng-if="job.supplementaryFile3" ng-click="download(job.supplementaryFile3)">{{job.supplementaryFile3.valueInfo.filename}}</a></div>
                            <div class="col-md-12"><a ng-if="job.supplementaryFile4" ng-click="download(job.supplementaryFile4)">{{job.supplementaryFile4.valueInfo.filename}}</a></div>
                            <div class="col-md-12"><a ng-if="job.supplementaryFile5" ng-click="download(job.supplementaryFile5)">{{job.supplementaryFile5.valueInfo.filename}}</a></div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">Works:</div>
                            <div class="col-md-12" ng-repeat="work in job.jobWorks">
                                {{$index+1}}. {{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, <span ng-if="work.materialQuantity">materials qty: {{work.materialQuantity}} {{unitsTitle[work.unit]}},</span> on sites: {{work.sites}} (Near end)
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">{{work.explanation}}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <button type="button" ng-click="showMoreJobRequests()" class="btn btn-sm btn-primary" ng-disabled="!showMore"><i class="glyphicon glyphicon-th-list"></i> <span ng-if="showMore">Show more</span><span ng-if="!showMore">No more similar job requests</span></span></button>
                </div>
            </div>
        </div>
    </form>
</div>