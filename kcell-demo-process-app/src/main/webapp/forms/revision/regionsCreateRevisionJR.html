<style>
    .well {
        color: #333;
    }
</style>
<form role="form" class="form-horizontal">
    <script cam-script type="text/form-script">
        inject(['$scope', '$http', function ($scope, $http) {
            var variables = [
                'validityDate',
                'soaComplaintId',
                'site',
                'reason',
                'contract',
                'contractor',
                'materialsRequired',
                'leasingRequired',
                'supplementaryFile1',
                'supplementaryFile2',
                'supplementaryFile3',
                'supplementaryFile4',
                'supplementaryFile5',
                'explanation',
                'works'
            ];
            camForm.on('form-loaded', function () {
                variables.forEach(function(el){
                    camForm.variableManager.fetchVariable(el);
                });

                $http.get('/api/catalogs/services').then(
                        function (result) {
                            $scope.services = result.data;
                            $scope.servicesTitle = {};
                            for (var i = 0; i < $scope.services.length; i++) {
                                $scope.servicesTitle[$scope.services[i].id] = $scope.services[i].name;
                            }
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );

                $http.get('/api/catalogs/contractors').then(
                        function (result) {
                            $scope.contractors = result.data;
                            $scope.contractorTitle = {};
                            for (var i = 0; i < $scope.contractors.length; i++) {
                                $scope.contractorTitle[$scope.contractors[i].id] = $scope.contractors[i].name;
                            }
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );

                $http.get('/api/catalogs/reasons').then(
                        function (result) {
                            $scope.reasons = result.data;
                            $scope.reasonsTitle = {};
                            for (var i = 0; i < $scope.reasons.length; i++) {
                                $scope.reasonsTitle[$scope.reasons[i].id] = $scope.reasons[i].name;
                            }
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );

                $http.get('/api/work/list').then(
                        function (result) {
                            $scope.works = result.data;
                            $scope.worksTitle = {};
                            for (var i = 0; i < $scope.works.length; i++) {
                                $scope.worksTitle[$scope.works[i].sapServiceNumber] = $scope.works[i].sapPOServiceName;
                            }
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );

                $http.get('/api/catalogs/units').then(
                        function (result) {
                            $scope.units = result.data;
                            $scope.unitsTitle = {};
                            for (var i = 0; i < $scope.units.length; i++) {
                                $scope.unitsTitle[$scope.units[i].value] = $scope.units[i].name;
                            }
                        },
                        function (error) {
                            console.log(error.data);
                        }
                );
                /*$http.get('/camunda/api/engine/engine/default/task/' + camForm.taskId + '/variables?deserializeValues=false').then(
                        function(variables){
                            $scope.jobRequest = variables.data;
                            if($scope.works){
                                try{
                                    $scope.works.value = JSON.parse($scope.works.value);
                                } catch(e) {console.log(e);}
                            }
                            if($scope.requestedDate){
                                try{
                                    $scope.requestedDate.value = new Date($scope.requestedDate.value);
                                } catch(e) {console.log(e);}
                            }
                            if($scope.validityDate){
                                try{
                                    $scope.validityDate.value = new Date($scope.validityDate.value);
                                } catch(e) {console.log(e);}
                            }
                        },
                        function(error){
                            console.log(error);
                        }
                );*/
            });
            camForm.on('variables-fetched', function() {
                variables.forEach(function(el){
                    $scope[el] = camForm.variableManager.variables[el];
                });
                console.log(camForm.variableManager.variables)
                console.log('FETCHED');
            });
        }]);
    </script>

    <div class="well">
        <div class="row">
            <div class="col-md-4">Requested date: {{requestedDate.value | date: 'dd.MM.yyyy HH:mm'}}</div>
            <div class="col-md-4">Reason: {{reasonsTitle[reason.value]}}</div>
            <div class="col-md-4">Materials required: {{materialsRequired.value}}</div>
        </div>
        <div class="row">
            <div class="col-md-4">Validity date: {{validityDate.value | date: 'dd.MM.yyyy'}}</div>
            <div class="col-md-4">Contract: {{servicesTitle[contract.value]}}</div>
            <div class="col-md-4">Leasing required: {{leasingRequired.value}}</div>
        </div>
        <div class="row">
            <div class="col-md-4">SA&O Complaint Id: {{soaComplaintId.value}}</div>
            <div class="col-md-4">Contractor: {{contractorTitle[contractor.value]}}</div>
            <div class="col-md-4">Site (near end): {{site.value}}</div>
        </div>
        <div class="row">
            <div class="col-md-12">Supplementary files:</div>
            <iframe id="fileDownloadIframe" style="display:none;"></iframe>
            <div class="col-md-12"><a ng-if="supplementaryFile1" href="{{supplementaryFile1.contentUrl}}">{{supplementaryFile1.valueInfo.filename}}</a></div>
            <div class="col-md-12"><a ng-if="supplementaryFile2" href="{{supplementaryFile1.contentUrl}}">{{supplementaryFile2.valueInfo.filename}}</a></div>
            <div class="col-md-12"><a ng-if="supplementaryFile3" href="{{supplementaryFile1.contentUrl}}">{{supplementaryFile3.valueInfo.filename}}</a></div>
            <div class="col-md-12"><a ng-if="supplementaryFile4" href="{{supplementaryFile1.contentUrl}}">{{supplementaryFile4.valueInfo.filename}}</a></div>
            <div class="col-md-12"><a ng-if="supplementaryFile5" href="{{supplementaryFile1.contentUrl}}">{{supplementaryFile5.valueInfo.filename}}</a></div>
        </div>
        <div class="row">
            <div class="col-md-12">Works:</div>
            <div class="col-md-12" ng-repeat="work in works">
                <a href="javascript:void(0)">{{$index+1}}. {{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{unitsTitle[work.unit]}}, on sites: {{work.sites}} (Near end)</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">{{explanation}}</div>
        </div>
    </div>
</form>