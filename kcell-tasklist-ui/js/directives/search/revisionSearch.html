<div class="row">
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Year:</label>
        <div class="col-sm-4">
            <select ng-model="filter.beginYear" class="form-control selectpicker" select-picker title="" ng-options="y as y for y in years"></select>
        </div>
        <div class="col-sm-4">
            <select ng-model="filter.endYear" class="form-control selectpicker" select-picker title="" ng-options="y as y for y in years"></select>
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">JR Number:</label>
        <div class="col-sm-2">
            <select ng-model="filter.businessKeyFilterType" class="form-control selectpicker" select-picker title="" ng-init="filter.businessKeyFilterType = 'eq'">
                <option value="eq">=</option>
                <option value="like">like</option>
            </select>
        </div>
        <div class="col-sm-6">
            <input type="text" ng-model="filter.businessKey" class="form-control" placeholder="Alm-LSE-P&O-17-4025" />
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Requested Date:</label>
        <div class="col-sm-8">
            <div class="input-group">
                <input type="text" ng-model="filter.requestedDateRange" name="requestedDate" class="form-control calendar-range-readonly" readonly/>
                <span class="input-group-btn">
						                    <button type="button" calendar-range class="btn btn-default" id="calendarRangeButton" name="requestedDate">
						                        <i class="glyphicon glyphicon-calendar"></i>
						                    </button>
						                </span>
            </div>
        </div>

    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Site Id:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.siteId" name="site_id" typeahead="site as sites.name for sites in getSiteId($viewValue)" typeahead-on-select="siteIdSelected($item,$model,$label)" class="form-control" autocomplete="off" placeholder="Site Id">
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Sitename:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.sitename" name="site_name" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="siteSelected($item,$model,$label)" class="form-control" autocomplete="off" placeholder="Site Name">
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Validity Date:</label>
        <div class="col-sm-8">
            <div class="input-group">
                <input type="text" ng-model="filter.validityDateRange" name="validityDate" class="form-control calendar-range-readonly" readonly/>
                <span class="input-group-btn">
						                    <button type="button" calendar-range class="btn btn-default" id="calendarRangeButton" name="validityDate">
						                        <i class="glyphicon glyphicon-calendar"></i>
						                    </button>
						                </span>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4" ng-if="hasGroup('head_kcell_users') || hasGroup('revision_managers') || hasGroup('revision_audit')">
        <label class="col-sm-4 control-label">Region:</label>
        <div class="col-sm-8">
            <select ng-model="filter.region" class="form-control selectpicker" select-picker title="" select-model="regionsMap" ng-init="filter.region = 'all'">
                <option value="all">All</option>
                <option value="{{key}}" ng-repeat="(key, value) in regionsMap" ng-selected="{{key == filter.region}}">{{value}}</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Requestor:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.requestor" class="form-control" placeholder="Name.Surname@kcell.kz" />
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Priority:</label>
        <div class="col-sm-8">
            <select ng-model="filter.priority" class="form-control selectpicker" select-picker title="">
                <option></option>
                <option value="regular">Regular</option>
                <option value="emergency">Emergency</option>
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Current activity:</label>
        <div class="col-sm-8">
            <select ng-model="filter.activityId" class="form-control selectpicker" select-picker title="" select-model="includedUserTasks">
                <option></option>
                <option value="{{task.id}}" ng-repeat="task in includedUserTasks | orderBy: 'name'" ng-selected="{{task.id == filter.activity}}">{{task.name}}</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Work Type:</label>
        <div class="col-sm-8">
            <select ng-model="filter.workType" class="form-control selectpicker" select-picker title="" select-model="reasons">
                <option></option>
                <option value="{{r.id}}" ng-repeat="r in reasons" ng-selected="{{r.id == filter.workType}}">{{r.name}}</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Contains work:</label>
        <div class="col-sm-8">
            <select ng-model="filter.workName" class="form-control selectpicker" select-picker title="" select-model="works">
                <option></option>
                <option ng-repeat="work in works" ng-selected="{{filter.workName == work.sapPOServiceName}}" value="{{work.sapPOServiceName}}">{{work.sapPOServiceName}}</option>
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Contract:</label>
        <div class="col-sm-8">
            <select ng-model="filter.mainContract" class="form-control selectpicker" select-picker title="" ng-init="filter.mainContract = 'All'">
                <option value="All">All</option>
                <option value="Revision">Revision</option>
                <option value="Roll-out">Roll-out</option>
            </select>
        </div>
    </div>
</div>

<div class="row">
    <div class="form-group col-sm-4"></div>

    <div class="form-group col-sm-4">
        <div class="col-sm-12">
            <center>
                <a class="btn btn-default" ng-click="clearFilters()">Clear filters</a>
                <a class="btn btn-primary" ng-click="search(true)"><i class="glyphicon glyphicon-search"></i>
                    Search ({{processInstancesTotal}})</a>
            </center>
        </div></div>
    <div class="col-sm-4">
        <a ng-if="lastSearchParamsRevision" class="btn btn-default" style="float: right" id="xlsxClick" ng-click="getXlsxProcessInstances()">{{xlsxPreparedRevision ? 'Export to Excel' : 'Prepare Excel'}}</a>
    </div>
</div>
<div style="margin-bottom: 20px;"></div>

<table class="table table-condensed table-hover" ng-if="processInstances" id="revisionsTable" name="revisionsTable">
    <thead class="fixed-header">
    <tr>
        <th>#</th>
        <th>Region</th>
        <th>Sitename</th>
        <th>JR Number</th>
        <th>Execution Time</th>
        <th>Current Activity</th>
        <th>Contractor</th>
        <th>Reason</th>
        <th>Requested By</th>
        <th>Current Assignee</th>
        <th>Requested Date</th>
        <th>Validity Date</th>
        <th>Jobs List</th>
    </tr>
    </thead>
    <tbody>
    <tr ng-repeat="pi in processInstances" class="pi-{{pi.state == 'EXTERNALLY_TERMINATED'?'COMPLETED':pi.state}}">
        <td>{{(filter.page-1)*20 + $index + 1}}</td>
        <td>{{regionsMap[pi.siteRegion]}}</td>
        <td>{{pi.site_name}}</td>
        <td>
            <a ng-click="toggleProcessViewRevision($index, pi.processDefinitionKey, pi.processDefinitionId, pi.businessKey)">
                {{pi.businessKey}}
            </a>
        </td>
        <td>{{pi.executionTime}} days</td>
        <td style="max-width: 100px;">
            <span ng-if="!(hasGroup('revision_managers') || hasGroup('revision_audit'))" ng-repeat="task in pi.tasks">{{$index+1}}. {{task.name}}<br/></span>
            <a ng-if="hasGroup('revision_managers') || hasGroup('revision_audit')" ng-repeat="task in pi.tasks" ui-sref="tasks.task({id:task.id})" target="_blank">{{$index+1}}. {{task.name}}<br/></a>
            <span ng-repeat="act in pi.otherActivities">{{pi.tasks.length+$index+1}}. {{act.activityName}}<br/></span>
        </td>
        <td>{{contractorShortName[pi.contractor]}}</td>
        <td>{{reasonShortName[pi.reason]}}</td>
        <td>{{profiles[pi.startUserId].firstName}} {{profiles[pi.startUserId].lastName}}</td>
        <td>
            <a ng-click="showTaskDetail(task)" ng-repeat="task in pi.tasks">{{$index+1}}. {{profiles[task.assignee] ? (profiles[task.assignee].firstName + ' ' + profiles[task.assignee].lastName) : 'Not claimed'}}<br/></a>
        </td>
        <td>{{pi.requestedDate | date:'dd MMM yyyy'}}</td>
        <td>{{pi.validityDate | date:'dd MMM yyyy'}}</td>
        <td style="max-width: 190px;">
            <a ng-click="showWorkDetail(pi.jobWorks)">
											<span ng-repeat="work in pi.jobWorks" class="nowrapDots">
												{{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{work.materialUnit}}
												<br/>
											</span>
            </a>
        </td>
    </tr>

    </tbody>
    <tbody>
    <tr>
        <td colspan="13" style="text-align: center">
            <a ng-disabled="filter.page <= 1" ng-click="filter.page <= 1 || selectPage(1)" class="btn btn-pagination"> << </a>
            <a ng-disabled="filter.page <= 1" ng-click="filter.page <= 1 || prevPage()" class="btn btn-pagination"> < </a>
            <a ng-repeat="page in getPages()" ng-disabled="filter.page == page" ng-click="filter.page == page || selectPage(page)" ng-class="filter.page == page? 'btn-pagination-active':''" class="btn btn-pagination">{{page}}</a>
            <a ng-disabled="filter.page >= processInstancesPages" ng-click="filter.page >= processInstancesPages || nextPage()" class="btn btn-pagination"> > </a>
            <a ng-disabled="filter.page >= processInstancesPages" ng-click="filter.page >= processInstancesPages || selectPage(processInstancesPages)" class="btn btn-pagination"> >> </a>
        </td>
    </tr>
    </tbody>
</table>

<table id="xlsxRevisionsTable" name="xlsxRevisionsTable" id="xlsxRevisionsTable" style="display: none;">
    <thead>
    <tr>
        <th>#</th>
        <th>Region</th>
        <th>Sitename</th>
        <th>JR Number</th>
        <th>Execution Time</th>
        <th>Current Activity</th>
        <th>Contractor</th>
        <th>Reason</th>
        <th>Requested By</th>
        <th>Current Assignee</th>
        <th>Requested Date</th>
        <th>Validity Date</th>
        <th>Jobs List</th>
        <th>Explanation</th>
    </tr>
    </thead>
    <tbody ng-repeat="pi in xlsxProcessInstances">
    <tr>
        <td>{{$index + 1}}</td>
        <td>{{regionsMap[pi.siteRegion]}}</td>
        <td>{{pi.site_name}}</td>
        <td>{{pi.businessKey}}</td>
        <td>{{pi.executionTime}} days</td>
        <td>
            <span ng-repeat="task in pi.tasks">{{$index+1}}. {{task.name}}<br/></span>
            <span ng-repeat="act in pi.otherActivities">{{pi.tasks.length+$index+1}}. {{act.activityName}}<br/></span>
        </td>
        <td>{{contractorShortName[pi.contractor]}}</td>
        <td>{{reasonShortName[pi.reason]}}</td>
        <td>{{profiles[pi.startUserId].firstName}} {{profiles[pi.startUserId].lastName}}</td>
        <td>
            <span ng-repeat="task in pi.tasks">{{$index+1}}. {{profiles[task.assignee] ? (profiles[task.assignee].firstName + ' ' + profiles[task.assignee].lastName) : 'Not claimed'}}<br/></span>
        </td>
        <td>{{pi.requestedDate | date:'dd MMM yyyy'}}</td>
        <td>{{pi.validityDate | date:'dd MMM yyyy'}}</td>
        <td>
										<span ng-repeat="work in pi.jobWorks">
											{{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{work.materialUnit}}
											<br/>
										</span>
        </td>
        <td>{{pi.explanation}}
        </td>
    </tr>
    </tbody>
</table>