
<div class="row">
    <div class=" form-group col-sm-8" style="margin-bottom:25px !important;" ng-show="KWMSProcessesCount>1">
        <div class="col-sm-2"><h4>Processes:</h4></div>
        <div class="col-sm-10" style="padding-left:10px !important;">
            <div class="d-inline" ng-repeat="(key, process) in KWMSProcesses">
                <button type="button" class="btn btn-default" ng-class="process.value? 'active': ''"
                        ng-click="toggleProcess(key)">{{process.title}}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="form-group col-sm-4">
        <div class="col-sm-12 checkbox-inline custom-checkbox" >
            <input type="checkbox"  value="true" ng-model="filter.unfinished" ng-disabled="filter.finished" name="show_active">show only Active
            <div style="    display: inline-block;
    width: 25px;"></div>
            <input type="checkbox" value="true"  ng-model="filter.finished" ng-disabled="filter.unfinished" name="show_closed">show only Closed
        </div>

    </div></div>
<div class="row">
    <div class="form-group col-sm-4">
        <label class="col-sm-4 control-label">Year:</label>
        <div class="col-sm-4">
            <select ng-model="filter.beginYear" class="form-control selectpicker" select-picker title="" ng-options="y as y for y in years"></select>
        </div>
        <div class="col-sm-4">
            <select ng-model="filter.endYear" class="form-control selectpicker" select-picker title="" ng-options="y as y for y in years"></select>
        </div>
    </div>
    <div class="form-group col-sm-4" ng-hide="onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">Site Id:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.siteId" name="site_id" typeahead="site as sites.name for sites in getSiteId($viewValue)" typeahead-on-select="siteIdSelected($item,$model,$label)" class="form-control" autocomplete="off" placeholder="Site Id">
        </div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">Period:</label>
            <div class="col-sm-4">
                <select class="form-control selectpicker" select-picker title="" select-model="months" name="monthOfFormalPeriod" ng-model="filter.monthOfFormalPeriod">
                    <option value=""></option>
                    <option ng-repeat="m in InvoicePeriodMonths" value="{{m.label}}">{{m.label}}</option>
                </select>
            </div>
            <div class="col-sm-4">
                <select class="form-control selectpicker" select-picker title="" select-model="years" name="yearOfFormalPeriod" ng-model="filter.yearOfFormalPeriod">
                    <option value=""></option>
                    <option value="{{y}}" ng-repeat="y in InvoicePeriodYears">{{y}}</option>
                </select>
            </div>
    </div>
    <div class="form-group col-sm-4"  ng-if="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">
        <label class="col-sm-4 control-label">Requested Date:</label>
        <div class="col-sm-8">
            <div class="input-group">
                <input type="text" ng-model="filter.requestedDateRange" name="requestedDate" class="form-control calendar-range-readonly" readonly/>
                <span class="input-group-btn">
                    <button type="button" calendar-range class="btn btn-default" id="calendarRangeButton" name="requestedDate">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4" ng-if="hasGroup('head_kcell_users') || hasGroup('revision_managers') || hasGroup('revision_audit')">
        <label class="col-sm-4 control-label">Region:</label>
        <div class="col-sm-8">
            <select ng-model="filter.region" class="form-control selectpicker" select-picker title="" select-model="regionsMap" ng-init="filter.region = 'all'">
                <option value="all">All</option>
                <option value="{{key}}" ng-repeat="(key, value) in regionsMap" ng-selected="{{key == filter.region}}">{{value}}</option>
            </select>
        </div>
    </div>
    <div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">Initiator:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.initiator" name="initiator"
                   typeahead="users as users.name for users in getUsers($viewValue)"
                   typeahead-on-select="userSelected($item,$model,$label)" typeahead-min-length="2" class="form-control"
                   required autocomplete="off">       </div>
    </div>
    <div class="form-group col-sm-4"  ng-hide="onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">Sitename:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.sitename" name="site_name" typeahead="site as sites.site_name for sites in getSite($viewValue)" typeahead-on-select="siteSelected($item,$model,$label)" class="form-control" autocomplete="off" placeholder="Site Name">
        </div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Validity Date:</label>
        <div class="col-sm-8">
            <div class="input-group">
                <input type="text" ng-model="filter.validityDateRange" name="validityDate" class="form-control calendar-range-readonly" readonly/>
                <span class="input-group-btn">
                    <button type="button" calendar-range class="btn btn-default" id="calendarRangeButton" name="validityDate">
                        <i class="glyphicon glyphicon-calendar"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Dismantle'">
        <label class="col-sm-4 control-label">Initiator of Dismantling:</label>
        <div class="col-sm-8">
            <select ng-model="filter.dismantlingInitiator" class="form-control selectpicker" select-picker title="">
                <option value="">select initiator</option>
                <option value="optimization">Optimization Unit</option>
                <option value="transmission">Transmission Unit</option>
                <option value="infrastructure">Infrastructure Unit</option>
                <option value="operation">Operation Unit</option>
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">
        <label class="col-sm-4 control-label">{{onlyProcessActive==='Revision' ? 'JR' : 'SDR'}} Number:</label>
        <div class="col-sm-3">
            <select ng-model="filter.businessKeyFilterType" class="form-control selectpicker" select-picker title="" ng-init="filter.businessKeyFilterType = 'eq'">
                <option value="eq">=</option>
                <option value="like">like</option>
            </select>
        </div>
        <div class="col-sm-5">
            <input type="text" ng-model="filter.businessKey" class="form-control" placeholder="{{onlyProcessActive==='Revision' ? 'Alm-LSE-P&O-17-4025' : 'SDR-ALM-2019-0023'}}" />
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">
        <label class="col-sm-4 control-label">Requestor:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.requestor" class="form-control" placeholder="Name.Surname@kcell.kz" />
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Priority:</label>
        <div class="col-sm-8">
            <select ng-model="filter.priority" class="form-control selectpicker" select-picker title="">
                <option></option>
                <option value="regular">Regular</option>
                <option value="emergency">Emergency</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Dismantle'">
        <label class="col-sm-4 control-label">Current activity:</label>
        <div class="col-sm-8">
            <select ng-model="filter.dismantleActivityId" class="form-control selectpicker" select-picker title="" select-model="dismantleUserTasks">
                <option></option>
                <option value="{{task.id}}" ng-repeat="task in dismantleUserTasks | orderBy: 'name'" ng-selected="{{task.id == filter.dismantleActivityId}}">{{task.name}}</option>
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Current activity:</label>
        <div class="col-sm-8">
            <select ng-model="filter.activityId" class="form-control selectpicker" select-picker title="" select-model="includedUserTasks">
                <option></option>
                <option value="{{task.id}}" ng-repeat="task in includedUserTasks | orderBy: 'name'" ng-selected="{{task.id == filter.activity}}">{{task.name}}</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Revision' || onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">Work Type:</label>
        <div class="col-sm-8">
            <select ng-model="filter.workType" class="form-control selectpicker" select-picker title="" select-model="reasons">
                <option></option>
                <option value="{{r.id}}" ng-repeat="r in reasons" ng-selected="{{r.id == filter.workType}}">{{r.name}}</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Invoice'">
        <label class="col-sm-4 control-label">MA Number:</label>
        <div class="col-sm-3">
            <select ng-model="filter.businessKeyFilterType" class="form-control selectpicker" select-picker title="" ng-init="filter.businessKeyFilterType = 'eq'">
                <option value="eq">=</option>
                <option value="like">like</option>
            </select>
        </div>
        <div class="col-sm-5">
            <input type="text" ng-model="filter.businessKey" class="form-control" placeholder="Alm-LSE-P&O-17-4025" />
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Contains work:</label>
        <div class="col-sm-8">
            <select ng-model="filter.workName" class="form-control selectpicker" select-picker title="" select-model="works">
                <option></option>
                <option ng-repeat="work in works" ng-selected="{{filter.workName == work.sapPOServiceName}}" value="{{work.sapPOServiceName}}">{{work.sapPOServiceName}}</option>
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Contract:</label>
        <div class="col-sm-8">
            <select ng-model="filter.mainContract" class="form-control selectpicker" select-picker title="" ng-init="filter.mainContract = 'All'">
                <option value="All">All</option>
                <option value="Revision">Revision</option>
                <option value="Roll-out">Roll-out</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4" ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Participation:</label>
        <div class="col-sm-8">
            <select ng-model="filter.participation" class="form-control selectpicker" select-picker title="">
                <option value="">Select participation</option>
                <option value="initiator">Initiator</option>
                <option value="participant">Participant</option>
            </select>
        </div>
    </div>
    <div class="form-group col-sm-4"  ng-show="onlyProcessActive==='Revision'">
        <label class="col-sm-4 control-label">Current Assignee:</label>
        <div class="col-sm-8">
            <input type="text" ng-model="filter.currentAssignee" name="currentAssignee"
                   typeahead="users as users.name for users in getUsers($viewValue)"
                   typeahead-on-select="taskUserSelected($item,$model,$label)" typeahead-min-length="2" class="form-control"
                   required autocomplete="off">
        </div>
    </div>
</div>
<div class="row">
    <div class="form-group col-sm-4"></div>

    <div class="form-group col-sm-4">
        <div class="col-sm-12">
            <center>
                <a class="btn btn-default" ng-click="clearFilters()">Clear filters</a>
                <a class="btn btn-primary" ng-click="search(true)"><i class="glyphicon glyphicon-search"></i>
                    Search ({{processInstancesTotal}})</a>
            </center>
        </div></div>
    <div class="col-sm-4" ng-if="onlyProcessActive!==''">
        <a ng-if="lastSearchParamsRevision" class="btn btn-default" style="float: right" id="xlsxClick" ng-click="getXlsxProcessInstances()">{{xlsxPreparedRevision ? 'Export to Excel' : 'Prepare Excel'}}</a>
    </div>
</div>
<div style="margin-bottom: 20px;"></div>

<table class="table table-condensed table-hover" ng-if="processInstances.length>0" id="revisionsTable" name="revisionsTable">
    <thead class="fixed-header">
    <tr>
        <th>#</th>
        <th ng-if="RevisionOrMonthlyAct || onlyProcessActive==='Dismantle'">Region</th>
        <th ng-if="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">Sitename</th>
        <th>{{onlyProcessActive==='Revision'?'JR Number' : onlyProcessActive==='Invoice'? 'MA Number' : 'Business Key' }}</th>
        <th ng-if="onlyProcessActive===''">Process Name</th>
        <th ng-if="RevisionOrMonthlyAct || onlyProcessActive==='Dismantle'">Execution Time</th>
        <th>Current Activity</th>
        <th ng-if="onlyProcessActive==='Revision'">Contractor</th>
        <th ng-if="RevisionOrMonthlyAct">Reason</th>
        <th>Requested By</th>
        <th ng-if="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">Current Assignee</th>
        <th>Requested Date</th>
        <th ng-if="onlyProcessActive==='Revision'">Validity Date</th>
        <th ng-if="onlyProcessActive==='Revision'">Jobs List</th>
    </tr>
    </thead>
    <tbody>
    <tr ng-repeat="pi in processInstances" class="pi-{{pi.state == 'EXTERNALLY_TERMINATED'?'COMPLETED':pi.state}}">
        <td>{{(filter.page-1)*20 + $index + 1}}</td>
        <td ng-if="RevisionOrMonthlyAct || onlyProcessActive==='Dismantle'">{{regionsMap[pi.siteRegion]}}</td>
        <td ng-if="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">{{pi.site_name}}</td>
        <td>
            <a ng-if="pi.processDefinitionKey!=='sdr_srr_request'" ng-click="toggleProcessViewRevision($index, pi.processDefinitionKey, pi.processDefinitionId, pi.businessKey)">
                {{pi.businessKey}}
            </a>
            <a ng-if="pi.processDefinitionKey==='sdr_srr_request' && pi.requestType === 'dismantle'" ng-click="toggleProcessViewDismantle($index, pi.processDefinitionKey, pi.processDefinitionId, pi.businessKey)">
                {{pi.businessKey}}
            </a>
        </td>
        <td ng-if="onlyProcessActive===''">{{pi.processDefinitionKey == 'sdr_srr_request'? (pi.requestType === 'dismantle' ? 'Dismantle' : 'Replacement') : pi.processDefinitionName}}</td>
        <td ng-if="RevisionOrMonthlyAct || onlyProcessActive==='Dismantle'">{{pi.executionTime}} days</td>
        <td style="max-width: 100px;">
            <span ng-if="!(hasGroup('revision_managers') || hasGroup('revision_audit'))" ng-repeat="task in pi.tasks">{{$index+1}}. {{task.name}}<br/></span>
            <a ng-if="hasGroup('revision_managers') || hasGroup('revision_audit')" ng-repeat="task in pi.tasks" ui-sref="tasks.task({id:task.id})" target="_blank">{{$index+1}}. {{task.name}}<br/></a>
            <span ng-repeat="act in pi.otherActivities">{{pi.tasks.length+$index+1}}. {{act.activityName}}<br/></span>
        </td>
        <td ng-if="onlyProcessActive==='Revision'">{{contractorShortName[pi.contractor]}}</td>
        <td ng-if="RevisionOrMonthlyAct">
            {{pi.processDefinitionKey==='Invoice' ? reasonShortName[pi.workType]
            : reasonShortName[pi.reason] }}</td>
        <td>{{profiles[pi.startUserId].firstName}} {{profiles[pi.startUserId].lastName}}</td>
        <td ng-if="onlyProcessActive==='Revision' || onlyProcessActive==='Dismantle'">
            <a ng-click="showTaskDetail(task)" ng-repeat="task in pi.tasks">{{$index+1}}. {{profiles[task.assignee] ? (profiles[task.assignee].firstName + ' ' + profiles[task.assignee].lastName) : 'Not claimed'}}<br/></a>
        </td>
        <td>{{pi.processDefinitionKey==='Revision'? (pi.requestedDate | date:'dd MMM yyyy') : pi.startTime | date:'dd MMM yyyy' }}</td>
        <td ng-if="onlyProcessActive==='Revision'">{{pi.validityDate | date:'dd MMM yyyy'}}</td>
        <td ng-if="onlyProcessActive==='Revision'" style="max-width: 190px;">
            <a ng-click="showWorkDetail(pi.jobWorks)">
											<span ng-repeat="work in pi.jobWorks" class="nowrapDots">
												{{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{work.materialUnit}}
												<br/>
											</span>
            </a>
        </td>
    </tr>

    </tbody>
    <tbody>
    <tr>
        <td colspan="13" style="text-align: center">
            <a ng-disabled="filter.page <= 1" ng-click="filter.page <= 1 || selectPage(1)" class="btn btn-pagination"> << </a>
            <a ng-disabled="filter.page <= 1" ng-click="filter.page <= 1 || prevPage()" class="btn btn-pagination"> < </a>
            <a ng-repeat="page in getPages()" ng-disabled="filter.page == page" ng-click="filter.page == page || selectPage(page)" ng-class="filter.page == page? 'btn-pagination-active':''" class="btn btn-pagination">{{page}}</a>
            <a ng-disabled="filter.page >= processInstancesPages" ng-click="filter.page >= processInstancesPages || nextPage()" class="btn btn-pagination"> > </a>
            <a ng-disabled="filter.page >= processInstancesPages" ng-click="filter.page >= processInstancesPages || selectPage(processInstancesPages)" class="btn btn-pagination"> >> </a>
        </td>
    </tr>
    </tbody>
</table>

<table id="xlsxRevisionsTable" name="xlsxRevisionsTable" id="xlsxRevisionsTable" style="display: none;">
    <thead class="fixed-header">
    <tr>
        <th>#</th>
        <th ng-if="RevisionOrMonthlyAct">Region</th>
        <th ng-if="onlyProcessActive==='Revision'">Sitename</th>
        <th>{{onlyProcessActive==='Revision'?'JR Number' : onlyProcessActive==='Invoice'? 'MA Number' : 'Business Key' }}</th>
        <th ng-if="RevisionOrMonthlyAct">Execution Time</th>
        <th>Current Activity</th>
        <th ng-if="onlyProcessActive==='Revision'">Contractor</th>
        <th ng-if="RevisionOrMonthlyAct">Reason</th>
        <th>Requested By</th>
        <th ng-if="onlyProcessActive==='Revision'">Current Assignee</th>
        <th>Requested Date</th>
        <th ng-if="onlyProcessActive==='Revision'">Validity Date</th>
        <th ng-if="onlyProcessActive==='Revision'">Jobs List</th>
        <th ng-if="onlyProcessActive==='Revision'">Explanation</th>
    </tr>
    </thead>
    <tbody ng-repeat="pi in xlsxProcessInstances">
    <tr>
        <td>{{$index + 1}}</td>
        <td ng-if="RevisionOrMonthlyAct">{{regionsMap[pi.siteRegion]}}</td>
        <td ng-if="onlyProcessActive==='Revision'">{{pi.site_name}}</td>
        <td>{{pi.businessKey}}</td>
        <td ng-if="RevisionOrMonthlyAct">{{pi.executionTime}} days</td>
        <td>
            <span ng-repeat="task in pi.tasks">{{$index+1}}. {{task.name}}<br/></span>
            <span ng-repeat="act in pi.otherActivities">{{pi.tasks.length+$index+1}}. {{act.activityName}}<br/></span>
        </td>
        <td ng-if="onlyProcessActive==='Revision'">{{contractorShortName[pi.contractor]}}</td>
        <td ng-if="RevisionOrMonthlyAct">{{reasonShortName[pi.reason]}}</td>
        <td>{{profiles[pi.startUserId].firstName}} {{profiles[pi.startUserId].lastName}}</td>
        <td ng-if="onlyProcessActive==='Revision'">
            <span ng-repeat="task in pi.tasks">{{$index+1}}. {{profiles[task.assignee] ? (profiles[task.assignee].firstName + ' ' + profiles[task.assignee].lastName) : 'Not claimed'}}<br/></span>
        </td>
        <td>{{pi.requestedDate | date:'dd MMM yyyy'}}</td>
        <td ng-if="onlyProcessActive==='Revision'">{{pi.validityDate | date:'dd MMM yyyy'}}</td>
        <td ng-if="onlyProcessActive==='Revision'">
										<span ng-repeat="work in pi.jobWorks">
											{{worksTitle[work.sapServiceNumber]}}, works qty: {{work.quantity}}, materials qty: {{work.materialQuantity}} {{work.materialUnit}}
											<br/>
										</span>
        </td>
        <td ng-if="onlyProcessActive==='Revision'">{{pi.explanation}}
        </td>
    </tr>
    </tbody>
</table>
